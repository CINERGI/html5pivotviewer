//
//  HTML5 PivotViewer
//
//  Collection loader interface - used so that different types of data sources can be used
//
//  Original Code:
//    Copyright (C) 2011 LobsterPot Solutions - http://www.lobsterpot.com.au/
//    enquiries@lobsterpot.com.au
//
//  Enhancements:
//    Copyright (C) 2012 OpenLink Software - http://www.openlinksw.com/
//
//  This software is licensed under the terms of the
//  GNU General Public License v2 (see COPYING)
//
///PivotViewer
var PivotViewer=PivotViewer||{};PivotViewer.Version="v0.9.0-e72636d",PivotViewer.Models={},PivotViewer.Models.Loaders={},PivotViewer.Utils={},PivotViewer.Views={};var Debug=Debug||{};(function(a){var b={};a.publish=function(c,e){b[c]&&a.each(b[c],function(){this.apply(a,e||[])})},a.subscribe=function(a,c){return b[a]||(b[a]=[]),b[a].push(c),[a,c]},a.unsubscribe=function(c){var e=c[0];b[e]&&a.each(b[e],function(a){this==c[1]&&b[e].splice(a,1)})}})(jQuery),Debug.Log=function(a){window.console&&window.console.log&&typeof debug!="undefined"&&debug==1&&window.console.log(a)},window.requestAnimFrame=function(a){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),PivotViewer.Utils.EscapeMetaChars=function(a){return a.replace(/\|/gi,"\\|").replace(/\//gi,"\\/").replace(/'/gi,"\\'").replace(/,/gi,"\\,").replace(/:/gi,"\\:").replace(/\(/gi,"\\(").replace(/\)/gi,"\\)").replace(/\+/gi,"\\+").replace(/\+/gi,"\\-").replace(/\+/gi,"\\_").replace(/\+/gi,"\\%")},PivotViewer.Utils.EscapeItemId=function(a){return a.replace(/\s+/gi,"|").replace(/'/gi,"").replace(/\(/gi,"").replace(/\)/gi,"").replace(/\./gi,"")},PivotViewer.Utils.Now=function(){return Date.now?Date.now():(new Date).getTime()},PivotViewer.Utils.Min=function(a){var b=1e6;for(var c=0,d=a.length;c<d;c++)b=b>a[c]?a[c]:b;return b},PivotViewer.Utils.Max=function(a){var b=-1e6;for(var c=0,d=a.length;c<d;c++)b=b<a[c]?a[c]:b;return b},PivotViewer.Utils.Histogram=function(a){if(!a instanceof Array)return null;var b=PivotViewer.Utils.Min(a),c=PivotViewer.Utils.Max(a),d=(Math.floor(Math.pow(2*a.length,1/3))+1)*2;d>10&&(d=10);var e=(c+1-(b-1))/d,f=[];for(var g=0;g<d;g++){var h=b+g*e,i=b+(g+1)*e;f.push([]);for(var j=0,k=a.length;j<k;j++)h<=a[j]&&i>a[j]&&f[g].push(a[j])}return{Histogram:f,Min:b,Max:c,BinCount:d}},function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(c){function g(){!a&&this.init&&this.init.apply(this,arguments)}var d=this.prototype;a=!0;var e=new this;a=!1;for(var f in c)e[f]=typeof c[f]=="function"&&typeof d[f]=="function"&&b.test(c[f])?function(a,b){return function(){var c=this._super;this._super=d[a];var e=b.apply(this,arguments);return this._super=c,e}}(f,c[f]):c[f];return g.prototype=e,g.constructor=g,g.subClass=arguments.callee,g}}(),PivotViewer.Models.Collection=Object.subClass({init:function(){var a="http://schemas.microsoft.com/collection/metadata/2009",b="http://schemas.microsoft.com/livelabs/pivot/collection/2009";this.CollectionName="",this.BrandImage="",this.FacetCategories=[],this.Items=[],this.CXMLBase="",this.ImageBase=""},GetItemById:function(a){for(var b=0;b<this.Items.length;b++)if(this.Items[b].Id==a)return this.Items[b];return null},GetFacetCategoryByName:function(a){for(var b=0;b<this.FacetCategories.length;b++)if(this.FacetCategories[b].Name==a)return this.FacetCategories[b];return null}}),PivotViewer.Models.FacetCategory=Object.subClass({init:function(a,b,c,d,e,f,g){this.Name=a,this.Format=b,this.Type=c!=null&&c!=undefined?c:PivotViewer.Models.FacetType.String,this.IsFilterVisible=d!=null&&d!=undefined?d:!0,this.IsMetaDataVisible=e!=null&&e!=undefined?e:!0,this.IsWordWheelVisible=f!=null&&f!=undefined?f:!0,this.CustomSort}}),PivotViewer.Models.FacetCategorySort=Object.subClass({init:function(a){this.Name=a,this.SortValues=[]}}),PivotViewer.Models.Item=Object.subClass({init:function(a,b,c,d){this.Img=parseInt(a),this.Id=b,this.Href=c,this.Name=d,this.Description,this.Facets=[]}}),PivotViewer.Models.Facet=Object.subClass({init:function(a){this.Name=a,this.FacetValues=[]},AddFacetValue:function(a){this.FacetValues.push(a)}}),PivotViewer.Models.FacetValue=Object.subClass({init:function(a){this.Value=a,this.Href=""}}),PivotViewer.Models.FacetType={String:"String",LongString:"LongString",Number:"Number",DateTime:"DateTime",Link:"Link"},PivotViewer.Models.Loaders.ICollectionLoader=Object.subClass({init:function(){},LoadCollection:function(a){if(!a instanceof PivotViewer.Models.Collection)throw"collection not an instance of PivotViewer.Models.Collection."}}),PivotViewer.Models.Loaders.CXMLLoader=PivotViewer.Models.Loaders.ICollectionLoader.subClass({init:function(a){this.CXMLUri=a},LoadCollection:function(a){var a=a;this._super(a),a.CXMLBase=this.CXMLUri,$.ajax({type:"GET",url:this.CXMLUri,dataType:"xml",success:function(b){Debug.Log("CXML loaded");var c=$(b).find("Collection")[0],d="P";if(c==undefined){$(".pv-loading").remove();var e="";throw e+="Error parsing CXML Collection\r\n\r\n",e+="\r\nPivot Viewer cannot continue until this problem is resolved\r\r",window.alert(e),"Error parsing CXML Collection"}for(var f=0;f<c.attributes.length;f++)if(c.attributes[f].value=="http://schemas.microsoft.com/livelabs/pivot/collection/2009"){d=c.attributes[f].localName!=undefined?c.attributes[f].localName:c.attributes[f].baseName;break}a.CollectionName=$(c).attr("Name"),a.BrandImage=$(c).attr(d+":BrandImage")!=undefined?$(c).attr(d+":BrandImage"):"";var g=$(b).find("FacetCategory");for(var f=0;f<g.length;f++){var h=$(g[f]),i=new PivotViewer.Models.FacetCategory(h.attr("Name"),h.attr("Format"),h.attr("Type"),h.attr(d+":IsFilterVisible")!=undefined?h.attr(d+":IsFilterVisible").toLowerCase()=="true"?!0:!1:!0,h.attr(d+":IsMetaDataVisible")!=undefined?h.attr(d+":IsMetaDataVisible").toLowerCase()=="true"?!0:!1:!0,h.attr(d+":IsWordWheelVisible")!=undefined?h.attr(d+":IsWordWheelVisible").toLowerCase()=="true"?!0:!1:!1),j=h.find(d+"\\:SortOrder"),k=j.find(d+"\\:SortValue");j.length==0&&(j=h.find("SortOrder"),k=j.find("SortValue"));if(j.length==1){var l=new PivotViewer.Models.FacetCategorySort(j.attr("Name"));for(var m=0;m<k.length;m++)l.SortValues.push($(k[m]).attr("Value"));i.CustomSort=l}a.FacetCategories.push(i)}var n=$(b).find("Items");if(n.length==1){a.ImageBase=$(n[0]).attr("ImgBase");var o=$(n[0]).find("Item");if(o.length==0){$(".pv-loading").remove();var e="";e+="There are no items in the CXML Collection\r\n\r\n",window.alert(e)}else for(var f=0;f<o.length;f++){var p=new PivotViewer.Models.Item($(o[f]).attr("Img").replace("#",""),$(o[f]).attr("Id"),$(o[f]).attr("Href"),$(o[f]).attr("Name")),q=$(o[f]).find("Description");q.length==1&&q[0].childNodes.length&&(p.Description=q[0].childNodes[0].nodeValue);var r=$(o[f]).find("Facet");for(var m=0;m<r.length;m++){var s=new PivotViewer.Models.Facet($(r[m]).attr("Name")),t=$(r[m]).children();for(var u=0;u<t.length;u++)if(t[u].nodeType==1){var v=$.trim($(t[u]).attr("Value"));if(v==null){var w=new PivotViewer.Models.FacetValue($(t[u]).attr("Name"));w.Href=$(t[u]).attr("Href"),s.AddFacetValue(w)}else if(t[u].nodeName=="Number"){var w=new PivotViewer.Models.FacetValue(parseFloat(v));s.AddFacetValue(w)}else{var w=new PivotViewer.Models.FacetValue(v);s.AddFacetValue(w)}}p.Facets.push(s)}a.Items.push(p)}}$.publish("/PivotViewer/Models/Collection/Loaded",null)},error:function(a,b,c){$(".pv-loading").remove();var d="";d+="Error loading CXML Collection\r\n\r\n",d=d+"URL        : "+this.url+"\r\n",d=d+"Statuscode : "+a.status+"\r\n",d=d+"Details    : "+c+"\r\n",d+="\r\nPivot Viewer cannot continue until this problem is resolved\r\r",window.alert(d)}})}}),PivotViewer.Views.IPivotViewerView=Object.subClass({init:function(){this.isActive=!1,this.init=!0,this.selected="",this.tiles=[]},Setup:function(a,b,c,d,e){},Filter:function(a,b,c){},GetUI:function(){return""},GetButtonImage:function(){return""},GetButtonImageSelected:function(){return""},GetViewName:function(){return""},Activate:function(){this.isActive=!0},Deactivate:function(){this.isActive=!1}}),PivotViewer.Views.TileBasedView=PivotViewer.Views.IPivotViewerView.subClass({OffsetTiles:function(a,b){for(var c=0;c<this.tiles.length;c++){var d=$.inArray(this.tiles[c].facetItem.Id,this.currentFilter);d>=0&&(this.tiles[c]._locations[0].destinationx+=a,this.tiles[c]._locations[0].destinationy+=b)}},SetInitialTiles:function(a,b,c){var d=b/2,e=c/2;for(var f=0;f<a.length;f++)a[f]._locations[0].x=d,a[f]._locations[0].y=e,a[f].velocityx=0,a[f].velocityy=0,a[f]._locations[0].startx=d,a[f]._locations[0].starty=e,a[f]._locations[0].destinationx=0,a[f]._locations[0].destinationy=0,a[f].width=1,a[f].height=1},GetRowsAndColumns:function(a,b,c,d){var e=.7,f=c*(d-Math.pow(e,2)),g=(b+a*c)*e,h=-1*b*a,i=(-1*g+Math.sqrt(Math.pow(g,2)-4*f*h))/(2*f),j=Math.floor(i*c),k=Math.ceil(b/j),l=Math.floor(a/i);return{Rows:k,Columns:l,TileMaxWidth:i,TileHeight:j}},SetOuterTileDestination:function(a,b,c){var d=c._locations[0].x-a/2,e=c._locations[0].y-b/2,f=e/d,g=Math.atan2(e,d);c._locations[0].destinationx=a*Math.cos(g)+a/2,c._locations[0].destinationy=b*Math.sin(g)+b/2},SortBy:function(a,b,c){var d=function(b){if(c)for(var d=b.facetItem.Facets.length-1;d>-1;d-=1)if(b.facetItem.Facets[d].Name==a&&b.facetItem.Facets[d].FacetValues.length>0)return c(b.facetItem.Facets[d].FacetValues[0].Value);return null};return function(a,c){var e=d(a),f=d(c);return(e<f?-1:e>f?1:0)*[1,-1][+!!b]}}}),PivotViewer.Views.GridView=PivotViewer.Views.TileBasedView.subClass({init:function(){this.Scale=1,this._super();var a=this;$.subscribe("/PivotViewer/Views/Canvas/Click",function(b){if(!a.isActive)return;var c=null,d=0,e=0,f=0,g=0;for(var h=0;h<a.tiles.length;h++)a.tiles[h].Contains(b.x,b.y)?(c=a.tiles[h].facetItem.Id,d=Math.round((a.tiles[h]._locations[0].x-a.currentOffsetX)/a.tiles[h].width),e=Math.round((a.tiles[h]._locations[0].y-a.currentOffsetY)/a.tiles[h].height),a.tiles[h].Selected(!0),tileHeight=a.tiles[h].height,tileWidth=a.tiles[h].height/a.tiles[h]._controller.GetRatio(a.tiles[h].facetItem.Img),tileOrigHeight=a.tiles[h].origheight,tileOrigWidth=a.tiles[h].origwidth,canvasHeight=a.tiles[h].context.canvas.height,canvasWidth=a.tiles[h].context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width())):a.tiles[h].Selected(!1);if(c!=null&&a.selected!=c){tileHeight/canvasHeight>tileWidth/canvasWidth?origProportion=tileOrigHeight/canvasHeight:origProportion=tileOrigWidth/canvasWidth,scale=Math.round(.75/origProportion*2);if(a.selected==""){var i=$(".pv-toolbarpanel-zoomslider").slider("option","value");i=scale,$(".pv-toolbarpanel-zoomslider").slider("option","value",i)}a.selected=c,a.CentreOnSelectedTile(d,e)}else{a.selected=c="",a.currentOffsetX=a.offsetX,a.currentOffsetY=a.offsetY;var i=$(".pv-toolbarpanel-zoomslider").slider("option","value");i=0,$(".pv-toolbarpanel-zoomslider").slider("option","value",i)}$.publish("/PivotViewer/Views/Item/Selected",[c])}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(b){if(!a.isActive||a.selected.length>0)return;for(var c=0;c<a.tiles.length;c++)a.tiles[c].Contains(b.x,b.y)?a.tiles[c].Selected(!0):a.tiles[c].Selected(!1)}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(b){if(!a.isActive)return;var c=a.Scale,d=a.currentWidth,e=a.currentHeight,f=b.scale!=undefined?0:1e3;b.scale!=undefined?b.scale>=1?a.Scale+=b.scale-1:(a.Scale-=b.scale,a.Scale=a.Scale<1?1:a.Scale):b.delta!=undefined&&(a.Scale=b.delta==0?1:a.Scale+b.delta-1),a.Scale==NaN&&(a.Scale=1);var g=(a.width-a.offsetX)*a.Scale,h=(a.height-a.offsetY)*a.Scale;if(g<a.width||a.Scale==1)a.currentOffsetX=a.offsetX,a.currentOffsetY=a.offsetY,a.currentWidth=a.width,a.currentHeight=a.height,a.Scale=1;else{var i=(b.x-a.currentOffsetX)/c*a.Scale,j=(b.y-a.currentOffsetY)/c*a.Scale;a.currentOffsetX=b.x-i,a.currentOffsetY=b.y-j,a.currentWidth=g,a.currentHeight=h}var k=a.GetRowsAndColumns(a.currentWidth-a.offsetX,a.currentHeight-a.offsetY,a.maxRatio,a.currentFilter.length);a.SetVisibleTilePositions(k,a.currentFilter,a.currentOffsetX,a.currentOffsetY,!0,!0,f);if(a.Scale==1&&c!=1){for(var l=0;l<a.tiles.length;l++)a.tiles[l].Selected(!1);a.selected="",$.publish("/PivotViewer/Views/Item/Selected",[a.selected])}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(b){if(!a.isActive)return;var c=b.x,d=b.y,e=!1,f=!1;a.currentOffsetX+=c,a.currentOffsetY+=d,c>0&&a.currentOffsetX>a.offsetX&&(a.currentOffsetX-=c,e=!0),d>0&&a.currentOffsetY>a.offsetY&&(a.currentOffsetY-=d,f=!0),a.currentOffsetX<a.offsetX&&a.currentWidth==a.width&&(a.currentOffsetX-=c,e=!0),c<0&&a.currentOffsetX<-1*(a.currentWidth-a.width)&&(a.currentOffsetX-=c,e=!0),a.currentOffsetY<a.offsetY&&a.currentHeight==a.height&&(a.currentOffsetY-=d,f=!0),d<0&&a.currentOffsetY-a.offsetY<-1*(a.currentHeight-a.height)&&(a.currentOffsetY-=d,f=!0);if(e&&f)return;e?a.OffsetTiles(0,d):f?a.OffsetTiles(c,0):a.OffsetTiles(c,d)})},Setup:function(a,b,c,d,e){this.width=a,this.height=b,this.offsetX=c,this.offsetY=d,this.maxRatio=e,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY},Filter:function(a,b,c){var d=this;if(!Modernizr.canvas)return;Debug.Log("Grid View Filtered: "+b.length),this.tiles=a,this.init&&this.SetInitialTiles(this.tiles,this.width,this.height);for(var e=0;e<this.tiles.length;e++)while(this.tiles[e]._locations.length>1)this.tiles[e]._locations.pop();this.tiles=this.tiles.sort(this.SortBy(c,!1,function(a){return $.isNumeric(a)?a:a.toUpperCase()})),this.currentFilter=b;var f=0;Debug.Log("this.currentWidth: "+this.currentWidth+" this.width: "+this.width);var g=$(".pv-toolbarpanel-zoomslider").slider("option","value");if(g>0){this.selected=selectedItem="",this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-toolbarpanel-zoomslider").slider("option","value",1);var h=this.GetRowsAndColumns(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,this.tiles.length),i=[];for(var j=0;j<this.tiles.length;j++)this.tiles[j].origwidth=h.TileHeight/this.tiles[j]._controller.GetRatio(this.tiles[j].facetItem.Img),this.tiles[j].origheight=h.TileHeight,i.push(this.tiles[j].facetItem.Id);this.SetVisibleTilePositions(h,i,this.currentOffsetX,this.currentOffsetY,!0,!1,1e3),f=1e3}setTimeout(function(){for(var a=0;a<d.tiles.length;a++){d.tiles[a]._locations[0].startx=d.tiles[a]._locations[0].x,d.tiles[a]._locations[0].starty=d.tiles[a]._locations[0].y,d.tiles[a].startwidth=d.tiles[a].width,d.tiles[a].startheight=d.tiles[a].height;var c=$.inArray(d.tiles[a].facetItem.Id,b);c<0&&(d.SetOuterTileDestination(d.width,d.height,d.tiles[a]),d.tiles[a].start=PivotViewer.Utils.Now(),d.tiles[a].end=d.tiles[a].start+1e3)}d.maxRatio=d.tiles[0]._controller.GetRatio(d.tiles[0].facetItem.Img);for(var a=0;a<d.tiles.length;a++){var c=$.inArray(d.tiles[a].facetItem.Id,b);c>=0&&d.tiles[a]._controller.GetRatio(d.tiles[a].facetItem.Img)<d.maxRatio&&(d.maxRatio=d.tiles[a]._controller.GetRatio(d.tiles[a].facetItem.Img))}var e=b.length==d.tiles.length?0:500;setTimeout(function(){var a=d.GetRowsAndColumns(d.width-d.offsetX,d.height-d.offsetY,d.maxRatio,d.currentFilter.length);for(var b=0;b<d.tiles.length;b++)d.tiles[b].origwidth=a.TileHeight/d.tiles[b]._controller.GetRatio(d.tiles[b].facetItem.Img),d.tiles[b].origheight=a.TileHeight;d.SetVisibleTilePositions(a,d.currentFilter,d.offsetX,d.offsetY,!1,!1,1e3)},e)},f),this.init=!1},GetUI:function(){return Modernizr.canvas?"":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"Content/images/GridView.png"},GetButtonImageSelected:function(){return"Content/images/GridViewSelected.png"},GetViewName:function(){return"Grid View"},SetVisibleTilePositions:function(a,b,c,d,e,f,g){var h=f?this.rowscols.Columns:a.Columns;f||(this.rowscols=a);var i=0,j=0;for(var k=0;k<this.tiles.length;k++){var l=$.inArray(this.tiles[k].facetItem.Id,b);l>=0&&(e&&(this.tiles[k]._locations[0].startx=this.tiles[k]._locations[0].x,this.tiles[k]._locations[0].starty=this.tiles[k]._locations[0].y,this.tiles[k].startwidth=this.tiles[k].width,this.tiles[k].startheight=this.tiles[k].height),this.tiles[k].destinationwidth=a.TileMaxWidth,this.tiles[k].destinationheight=a.TileHeight,this.tiles[k]._locations[0].destinationx=i*a.TileMaxWidth+c,this.tiles[k]._locations[0].destinationy=j*a.TileHeight+d,this.tiles[k].start=PivotViewer.Utils.Now(),this.tiles[k].end=this.tiles[k].start+g,i==h-1?(i=0,j++):i++)}},GetSelectedCol:function(a){var b=this;return selectedCol=Math.round((a._locations[0].x-b.currentOffsetX)/a.width),selectedCol},GetSelectedRow:function(a){var b=this;return selectedRow=Math.round((a._locations[0].y-b.currentOffsetY)/a.height),selectedRow},CentreOnSelectedTile:function(a,b){var c=this,d;for(var e=0;e<c.tiles.length;e++)if(c.tiles[e].IsSelected()){d=c.tiles[e];break}offsetX=d._locations[0].x,offsetY=d._locations[0].y;var f=c.GetRowsAndColumns(c.currentWidth-c.offsetX,c.currentHeight-c.offsetY,c.maxRatio,c.currentFilter.length);c.currentOffsetX=f.TileMaxWidth*a*-1+c.width/2-f.TileMaxWidth/2,c.currentOffsetY=f.TileHeight*b*-1+c.height/2-f.TileHeight/2,c.SetVisibleTilePositions(f,c.currentFilter,c.currentOffsetX,c.currentOffsetY,!0,!0,1e3)}}),PivotViewer.Views.GraphView=PivotViewer.Views.TileBasedView.subClass({init:function(){this._super();var a=this;this.buckets=[],this.Scale=1,this.canvasHeightUIAdjusted=0,this.titleSpace=62,$.subscribe("/PivotViewer/Views/Canvas/Click",function(b){if(!a.isActive)return;var c=null,d=0,e=0,f=!1,g=!1,h=0,i=0;for(var j=0;j<a.tiles.length;j++)a.tiles[j].Contains(b.x,b.y)?(c=a.tiles[j].facetItem.Id,selectedX=a.tiles[j]._locations[0].x,selectedY=a.tiles[j]._locations[0].y,a.tiles[j].Selected(!0),f=!0,d=Math.round((a.tiles[j]._locations[0].x-a.currentOffsetX)/a.tiles[j].width),e=Math.round((a.canvasHeightUIAdjusted-a.tiles[j]._locations[0].y)/a.tiles[j].height),tileHeight=a.tiles[j].height,tileWidth=a.tiles[j].height/a.tiles[j]._controller.GetRatio(a.tiles[j].facetItem.Img),tileOrigHeight=a.tiles[j].origheight,tileOrigWidth=a.tiles[j].origwidth,canvasHeight=a.tiles[j].context.canvas.height,canvasWidth=a.tiles[j].context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width())):a.tiles[j].Selected(!1);a.selected!=null&&a.selected!=""&&!f&&(g=!0);if(c!=null&&a.selected!=c){tileHeight/canvasHeight>tileWidth/canvasWidth?origProportion=tileOrigHeight/canvasHeight:origProportion=tileOrigWidth/canvasWidth,scale=Math.round(.75/origProportion*2);if(a.selected==""){var k=$(".pv-toolbarpanel-zoomslider").slider("option","value");k=scale,$(".pv-toolbarpanel-zoomslider").slider("option","value",k)}a.selected=c,a.CentreOnSelectedTile(d,e),$(".pv-viewarea-graphview-overlay div").fadeOut("slow")}else{a.selected=c="",a.currentOffsetX=a.offsetX,a.currentOffsetY=a.offsetY;var k=$(".pv-toolbarpanel-zoomslider").slider("option","value");k=0,$(".pv-toolbarpanel-zoomslider").slider("option","value",k),$(".pv-viewarea-graphview-overlay div").fadeIn("slow")}$.publish("/PivotViewer/Views/Item/Selected",[c]);if(!f&&!g){var l=Math.floor((b.x-a.offsetX)/a.columnWidth);$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:a.sortFacet,Item:a.buckets[l].startRange,MaxRange:a.buckets[l].endRange}])}}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(b){if(!a.isActive)return;$(".pv-viewarea-graphview-overlay-bucket").removeClass("graphview-bucket-hover");var c=Math.floor((b.x-a.offsetX)/a.columnWidth),d=$("#pv-viewarea-graphview-overlay-bucket-"+c);d.addClass("graphview-bucket-hover");for(var e=0;e<a.tiles.length;e++)a.tiles[e].Contains(b.x,b.y)?a.tiles[e].Selected(!0):a.tiles[e].Selected(!1)}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(b){if(!a.isActive)return;var c=a.Scale,d=a.currentWidth,e=a.currentHeight,f=b.scale!=undefined?0:1e3;b.scale!=undefined?b.scale>=1?a.Scale+=b.scale-1:(a.Scale-=b.scale,a.Scale=a.Scale<1?1:a.Scale):b.delta!=undefined&&(a.Scale=b.delta==0?1:a.Scale+b.delta-1),a.Scale==NaN&&(a.Scale=1);var g=(a.width-a.offsetX)*a.Scale,h=(a.height-a.offsetY-a.titleSpace)*a.Scale;if(g<a.width||a.Scale==1)a.currentOffsetX=a.offsetX,a.currentOffsetY=a.offsetY,a.currentWidth=a.width,a.currentHeight=a.height,a.canvasHeightUIAdjusted=a.height-a.titleSpace,a.columnWidth=(a.width-a.offsetX)/a.buckets.length,a.Scale=1,$(".pv-viewarea-graphview-overlay div").fadeIn("slow");else{a.currentOffsetX=b.x-(b.x-a.currentOffsetX)/c*a.Scale;var i=(b.y-a.currentOffsetY)/c*a.Scale;a.currentOffsetY=b.y-i,a.canvasHeightUIAdjusted=h-a.titleSpace/c*a.Scale,a.currentWidth=g,a.currentHeight=h,a.columnWidth=g/a.buckets.length,$(".pv-viewarea-graphview-overlay div").fadeOut("slow")}var j=a.GetRowsAndColumns(a.columnWidth-2,a.canvasHeightUIAdjusted-a.currentOffsetY,a.maxRatio,a.bigCount);a.SetVisibleTileGraphPositions(j,a.currentOffsetX,a.currentOffsetY,!0,!0);if(a.Scale==1&&c!=1){for(var k=0;k<a.tiles.length;k++)a.tiles[k].Selected(!1);a.selected="",$.publish("/PivotViewer/Views/Item/Selected",[a.selected])}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(b){if(!a.isActive)return;var c=b.x,d=b.y,e=!1,f=!1;a.currentOffsetX+=c,a.currentOffsetY+=d,c>0&&a.currentOffsetX>a.offsetX&&(a.currentOffsetX-=c,e=!0),d>0&&a.currentOffsetY+a.canvasHeightUIAdjusted>a.currentHeight+a.offsetY&&(a.currentOffsetY-=d,f=!0),a.currentOffsetX<a.offsetX&&a.currentWidth==a.width&&(a.currentOffsetX-=c,e=!0),c<0&&a.currentOffsetX<-1*(a.currentWidth-a.width)&&(a.currentOffsetX-=c,e=!0),a.currentOffsetY<a.offsetY&&a.currentHeight==a.height&&(a.currentOffsetY-=d,f=!0),d<0&&a.currentOffsetY-a.offsetY<-1*(a.currentHeight-a.height)&&(a.currentOffsetY-=d,f=!0);if(e&&f)return;e?a.OffsetTiles(0,d):f?a.OffsetTiles(c,0):a.OffsetTiles(c,d)})},Setup:function(a,b,c,d,e){this.width=a,this.height=b,this.offsetX=c,this.offsetY=d,this.maxRatio=e,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,this.rowscols=null,this.bigCount=0},Filter:function(a,b,c){var d=this;if(!Modernizr.canvas)return;Debug.Log("Graph View Filtered: "+b.length),this.sortFacet=c,this.tiles=a,this.tiles=a.sort(this.SortBy(this.sortFacet,!1,function(a){return $.isNumeric(a)?a:a.toUpperCase()})),this.currentFilter=b,this.buckets=this.Bucketize(a,b,this.sortFacet),this.columnWidth=(this.width-this.offsetX)/this.buckets.length,this.canvasHeightUIAdjusted=this.height-this.titleSpace;var e=[];this.bigCount=0;for(var f=0;f<this.buckets.length;f++){var g=f%2==0?"graphview-bucket-dark":"graphview-bucket-light";e[f]="<div class='pv-viewarea-graphview-overlay-bucket "+g+"' id='pv-viewarea-graphview-overlay-bucket-"+f+"' style='width: "+(Math.floor(this.columnWidth)-4)+"px; height:"+(this.height-2)+"px; left:"+(f*this.columnWidth-2)+"px;'>",this.buckets[f].startRange==this.buckets[f].endRange?e[f]+="<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[f].startRange+"</div></div>":e[f]+="<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[f].startRange+"<br/>to<br/>"+this.buckets[f].endRange+"</div></div>",this.bigCount<this.buckets[f].Ids.length&&(this.bigCount=this.buckets[f].Ids.length)}var h=$(".pv-viewarea-graphview-overlay");h.css("left",this.offsetX+"px"),$(".pv-viewarea-graphview-overlay div").fadeOut("slow",function(){$(this).remove()}),h.append(e.join("")),$(".pv-viewarea-graphview-overlay div").fadeIn("slow");for(var f=0;f<this.tiles.length;f++){this.tiles[f]._locations[0].startx=this.tiles[f]._locations[0].x,this.tiles[f]._locations[0].starty=this.tiles[f]._locations[0].y,this.tiles[f].startwidth=this.tiles[f].width,this.tiles[f].startheight=this.tiles[f].height;var i=$.inArray(this.tiles[f].facetItem.Id,b);i<0&&(this.SetOuterTileDestination(this.width,this.height,this.tiles[f]),this.tiles[f].start=PivotViewer.Utils.Now(),this.tiles[f].end=this.tiles[f].start+1e3)}d.maxRatio=d.tiles[0]._controller.GetRatio(d.tiles[0].facetItem.Img);for(var f=0;f<d.tiles.length;f++){var i=$.inArray(d.tiles[f].facetItem.Id,b);i>=0&&d.tiles[f]._controller.GetRatio(d.tiles[f].facetItem.Img)<d.maxRatio&&(d.maxRatio=d.tiles[f]._controller.GetRatio(d.tiles[f].facetItem.Img))}var j=b.length==this.tiles.length?0:500;setTimeout(function(){d.rowscols=d.GetRowsAndColumns(d.columnWidth-2,d.canvasHeightUIAdjusted-d.offsetY,d.maxRatio,d.bigCount);for(var a=0;a<d.tiles.length;a++)d.tiles[a].origwidth=d.rowscols.TileHeight/d.tiles[a]._controller.GetRatio(d.tiles[a].facetItem.Img),d.tiles[a].origheight=d.rowscols.TileHeight;d.SetVisibleTileGraphPositions(d.rowscols,d.offsetX,d.offsetY,!1,!1)},j),this.init=!1},GetUI:function(){return Modernizr.canvas?"<div class='pv-viewarea-graphview-overlay'></div>":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"Content/images/GraphView.png"},GetButtonImageSelected:function(){return"Content/images/GraphViewSelected.png"},GetViewName:function(){return"Graph View"},SetVisibleTileGraphPositions:function(a,b,c,d,e){var f=e?this.rowscols.Columns:a.Columns;e||(this.rowscols=a);var g=[],h=[];for(var i=0;i<this.tiles.length;i++){this.tiles[i].firstFilterItemDone=!1;while(this.tiles[i]._locations.length>1)this.tiles[i]._locations.pop()}for(var j=0;j<this.buckets.length;j++){var k=0,l=0;for(var m=0,n=this.tiles.length;m<n;m++)$.inArray(this.tiles[m].facetItem.Id,this.buckets[j].Ids)>=0&&(this.tiles[m].firstFilterItemDone?(tileLocation=new PivotViewer.Views.TileLocation,tileLocation.startx=this.tiles[m]._locations[0].startx,tileLocation.starty=this.tiles[m]._locations[0].starty,tileLocation.x=this.tiles[m]._locations[0].x,tileLocation.y=this.tiles[m]._locations[0].y,tileLocation.destinationx=j*this.columnWidth+k*a.TileMaxWidth+b,tileLocation.destinationy=this.canvasHeightUIAdjusted-a.TileHeight-l*a.TileHeight+c,this.tiles[m]._locations.push(tileLocation)):(d&&(this.tiles[m]._locations[0].startx=this.tiles[m]._locations[0].x,this.tiles[m]._locations[0].starty=this.tiles[m]._locations[0].y,this.tiles[m].startwidth=this.tiles[m].width,this.tiles[m].startheight=this.tiles[m].height),this.tiles[m].destinationwidth=a.TileMaxWidth,this.tiles[m].destinationheight=a.TileHeight,this.tiles[m]._locations[0].destinationx=j*this.columnWidth+k*a.TileMaxWidth+b,this.tiles[m]._locations[0].destinationy=this.canvasHeightUIAdjusted-a.TileHeight-l*a.TileHeight+c,this.tiles[m].start=PivotViewer.Utils.Now(),this.tiles[m].end=this.tiles[m].start+1e3,this.tiles[m].firstFilterItemDone=!0),k==f-1?(k=0,l++):k++)}},Bucketize:function(a,b,c){var d=[];for(var e=0;e<a.length;e++)if($.inArray(a[e].facetItem.Id,b)>=0){var f=!1;for(var g=0;g<a[e].facetItem.Facets.length;g++)if(a[e].facetItem.Facets[g].Name==c&&a[e].facetItem.Facets[g].FacetValues.length>0)for(var h=0;h<a[e].facetItem.Facets[g].FacetValues.length;h++){var i=a[e].facetItem.Facets[g].FacetValues[h].Value,j=!1;for(var k=0;k<d.length;k++)d[k].startRange==i&&($.inArray(a[e].facetItem.Id,d[k].Ids)<0&&d[k].Ids.push(a[e].facetItem.Id),j=!0);j||d.push({startRange:i,endRange:i,Ids:[a[e].facetItem.Id]}),f=!0}if(!f){var i="(no info)",j=!1;for(var k=0;k<d.length;k++)d[k].startRange==i&&(d[k].Ids.push(a[e].facetItem.Id),j=!0);j||d.push({startRange:i,endRange:i,Ids:[a[e].facetItem.Id]})}}var l=0;while(d.length>8)if(l<d.length-1){d[l].endRange=d[l+1].endRange;for(var e=0;e<d[l+1].Ids.length;e++)$.inArray(d[l+1].Ids[e],d[l].Ids)<0&&d[l].Ids.push(d[l+1].Ids[e]);d.splice(l+1,1),l++}else l=0;return d},GetSelectedCol:function(a){var b=this;return selectedCol=Math.round((a._locations[0].x-b.currentOffsetX)/a.width),selectedCol},GetSelectedRow:function(a){var b=this;return selectedRow=Math.round((a._locations[0].y-b.currentOffsetY)/a.height),selectedRow},CentreOnSelectedTile:function(a,b){var c=this,d;for(var e=0;e<c.tiles.length;e++)if(c.tiles[e].IsSelected()){d=c.tiles[e];break}offsetX=d._locations[0].x,offsetY=d._locations[0].y;var f=c.GetRowsAndColumns(c.columnWidth-2,c.canvasHeightUIAdjusted-c.currentOffsetY,c.maxRatio,c.bigCount),g=0,h=c.columnWidth-f.TileMaxWidth*f.Columns,i=Math.floor(a/f.Columns);h>0&&(g=i*h),c.currentOffsetX=f.TileMaxWidth*a*-1+c.width/2-f.TileMaxWidth/2+g,c.currentOffsetY=c.canvasHeightUIAdjusted-f.TileHeight*b+c.height/2-f.TileHeight/2,c.SetVisibleTileGraphPositions(f,c.currentOffsetX,c.currentOffsetY,!0,!0)}}),PivotViewer.Views.IImageController=Object.subClass({init:function(){},Setup:function(a){},GetImagesAtLevel:function(a,b){},Width:0,Height:0}),PivotViewer.Views.LoadImageSetHelper=Object.subClass({init:function(){this._images=[],this._loaded=!1},LoadImages:function(a){var b=this;for(var c=0;c<a.length;c++){var d=new Image;d.src=a[c],d.onload=function(){b._loaded=!0},this._images.push(d)}},GetImages:function(){return this._images},IsLoaded:function(){return this._loaded}}),PivotViewer.Views.DeepZoomImageController=PivotViewer.Views.IImageController.subClass({init:function(){this._items=[],this._collageItems=[],this._baseUrl="",this._collageMaxLevel=0,this._tileSize=256,this._format="",this._ratio=1,this.MaxRatio=1,this._zooming=!1;var a=this;$.subscribe("/PivotViewer/ImageController/Zoom",function(b){a._zooming=b})},Setup:function(a){this._baseUrl=a.substring(0,a.lastIndexOf("/")),this._collageUrl=a.substring(a.lastIndexOf("/")+1).replace(".xml","_files");var b=this;$.ajax({type:"GET",url:a,dataType:"xml",success:function(a){var c=$(a).find("Collection");b._tileSize=$(c).attr("TileSize"),b._format=$(c).attr("Format"),b._collageMaxLevel=$(c).attr("MaxLevel");var d=$(a).find("I");if(d.length==0)return;var e=$(d[0]).find("Size");if(e.length>0){b.MaxWidth=parseInt(e.attr("Width")),b.Height=parseInt(e.attr("Height")),b.MaxRatio=b.Height/b.MaxWidth;for(i=0;i<d.length;i++){itemSize=$(d[i]).find("Size");var f=parseInt(itemSize.attr("Width")),g=parseInt(itemSize.attr("Height")),h=f>g?f:g,j=Math.ceil(Math.log(h)/Math.log(2));b._ratio=g/f;var k=$(d[i]).attr("Source"),l=$(d[i]).attr("Id"),m=$(d[i]).attr("N"),n=k.substring(k.lastIndexOf("/")+1).replace(/\.xml/gi,"").replace(/\.dzi/gi,""),o=k.substring(0,k.lastIndexOf("/"));o.length>0&&(o+="/"),b._items.push(new PivotViewer.Views.DeepZoomItem(l,n,m,o,b._ratio,f,g,j)),f>b.MaxWidth&&(b.MaxWidth=f),b._ratio<b.MaxRatio&&(b.MaxRatio=b._ratio)}}$.publish("/PivotViewer/ImageController/Collection/Loaded",null)},error:function(a,b,c){$(".pv-loading").remove();var d="";d+="Error loading from DeepZoom Cache\r\n\r\n",d=d+"URL        : "+this.url+"\r\n",d=d+"Statuscode : "+a.status+"\r\n",d=d+"Details    : "+c+"\r\n",d+="\r\nPivot Viewer cannot continue until this problem is resolved\r\r",window.alert(d)}})},GetImagesAtLevel:function(a,b){b=b<=0?6:b;for(var c=0;c<this._items.length;c++)if(this._items[c].ItemId==a){b=b>this._items[c].MaxLevel?this._items[c].MaxLevel:b;var d=this._items[c].DZN.toString(2),e="",f="";for(var g=0;g<d.length;g++)g%2==0?e+=d[g]:f+=d[g];dzCol=parseInt(e,2),dzRow=parseInt(f,2);if(this._items[c].Levels!=undefined&&this._items[c].Levels.length!=0||!!this._zooming){if(this._items[c].Levels.length<b&&!this._zooming){var h=this.GetImageList(c,this._baseUrl+"/"+this._items[c].BasePath+this._items[c].DZId+"_files/"+b+"/",b),i=new PivotViewer.Views.LoadImageSetHelper;i.LoadImages(h),this._items[c].Levels.splice(b,0,i)}for(var j=b;j>-1;j--){if(this._items[c].Levels[j]!=undefined&&this._items[c].Levels[j].IsLoaded())return this._items[c].Levels[j].GetImages();if(j==b&&this._items[c].Levels[j]==undefined&&!this._zooming){var h=this.GetImageList(c,this._baseUrl+"/"+this._items[c].BasePath+this._items[c].DZId+"_files/"+j+"/",j),i=new PivotViewer.Views.LoadImageSetHelper;i.LoadImages(h),this._items[c].Levels.splice(j,0,i)}}return null}var h=this.GetImageList(c,this._baseUrl+"/"+this._items[c].BasePath+this._items[c].DZId+"_files/6/",6),i=new PivotViewer.Views.LoadImageSetHelper;return i.LoadImages(h),this._items[c].Levels.push(i),null}return null},GetImageList:function(a,b,c){var d=[],e=this._tileSize,f=this._format,g=this._items[a].Ratio,h=this._items[a].Height,i=this._items[a].MaxLevel,j=Math.ceil(h/g/Math.pow(2,i-c)),k=Math.ceil(h/Math.pow(2,i-c)),l=Math.ceil
(j/e),m=Math.ceil(k/e);for(var n=0;n<l;n++)for(var o=0;o<m;o++)d.push(b+n+"_"+o+"."+f);return d},GetWidthForImage:function(a,b){for(var c=0;c<this._items.length;c++)if(this._items[c].ItemId==a)return Math.floor(b/this._items[c].Ratio)},GetDzi:function(a){for(var b=0;b<this._items.length;b++)if(this._items[b].ItemId==a)return dziName=this._baseUrl+"/"+this._items[b].BasePath+this._items[b].DZId+".dzi",dziName},GetMaxLevel:function(a){for(var b=0;b<this._items.length;b++)if(this._items[b].ItemId==a)return this._items[b].MaxLevel},GetWidth:function(a){for(var b=0;b<this._items.length;b++)if(this._items[b].ItemId==a)return this._items[b].Width},GetHeight:function(a){for(var b=0;b<this._items.length;b++)if(this._items[b].ItemId==a)return this._items[b].Height},GetRatio:function(a){for(var b=0;b<this._items.length;b++)if(this._items[b].ItemId==a)return this._items[b].Ratio}}),PivotViewer.Views.DeepZoomItem=Object.subClass({init:function(a,b,c,d,e,f,g,h){this.ItemId=a,this.DZId=b,this.DZN=parseInt(c),this.BasePath=d,this.Levels=[],this.Ratio=e,this.Width=f,this.Height=g,this.MaxLevel=h}}),PivotViewer.Views.TileController=Object.subClass({init:function(a){this._tiles=[],this._helpers=[],this._helperText="",this._easing=new Easing.Easer({type:"circular",side:"both"}),this._imageController=a},initTiles:function(a,b,c){for(var d=0;d<a.length;d++){var e=new PivotViewer.Views.Tile(this._imageController);e.facetItem=a[d],e.CollectionRoot=b.replace(/\\/gi,"/").replace(/\.xml/gi,""),this._canvasContext=c,e.context=this._canvasContext,tileLocation=new PivotViewer.Views.TileLocation,e._locations.push(tileLocation),this._tiles.push(e)}return this._tiles},AnimateTiles:function(){var a=this;this._started=!0;var b=null,c=!1;if(this._tiles.length>0&&this._tiles[0].context!=null){b=this._tiles[0].context;var d=!1;for(var e=0;e<this._tiles.length;e++)for(l=0;l<this._tiles[e]._locations.length;l++){var f=PivotViewer.Utils.Now()-this._tiles[e].start,g=this._tiles[e].end-this._tiles[e].start;if(f<=g){if(this._tiles[e]._locations[l].x!=this._tiles[e]._locations[l].destinationx||this._tiles[e]._locations[l].y!=this._tiles[e]._locations[l].destinationy)d=!0;this._tiles[e]._locations[l].x=this._easing.ease(f,this._tiles[e]._locations[l].startx,this._tiles[e]._locations[l].destinationx-this._tiles[e]._locations[l].startx,g),this._tiles[e]._locations[l].y=this._easing.ease(f,this._tiles[e]._locations[l].starty,this._tiles[e]._locations[l].destinationy-this._tiles[e]._locations[l].starty,g);if(this._tiles[e].width!=this._tiles[e].destinationWidth||this._tiles[e].height!=this._tiles[e].destinationHeight)d=!0;this._tiles[e].width=this._easing.ease(f,this._tiles[e].startwidth,this._tiles[e].destinationwidth-this._tiles[e].startwidth,g),this._tiles[e].height=this._easing.ease(f,this._tiles[e].startheight,this._tiles[e].destinationheight-this._tiles[e].startheight,g)}else this._tiles[e]._locations[l].x=this._tiles[e]._locations[l].destinationx,this._tiles[e]._locations[l].y=this._tiles[e]._locations[l].destinationy,this._tiles[e].width=this._tiles[e].destinationwidth,this._tiles[e].height=this._tiles[e].destinationheight;this._tiles[e]._locations[l].destinationx+this._tiles[e].destinationwidth<0||this._tiles[e]._locations[l].destinationx>b.canvas.width||this._tiles[e]._locations[l].destinationy+this._tiles[e].destinationheight<0||this._tiles[e]._locations[l].destinationy>b.canvas.height?this._tiles[e].destinationVisible=!1:this._tiles[e].destinationVisible=!0}}this._isZooming!=d&&(this._isZooming=d,$.publish("/PivotViewer/ImageController/Zoom",[this._isZooming])),b.clearRect(0,0,b.canvas.width,b.canvas.height);for(var e=0;e<this._tiles.length;e++)this._tiles[e]._locations[0].x+this._tiles[e].width>0&&this._tiles[e]._locations[0].x<b.canvas.width&&this._tiles[e]._locations[0].y+this._tiles[e].height>0&&this._tiles[e]._locations[0].y<b.canvas.height&&(c?this._tiles[e].DrawEmpty():this._tiles[e].Draw());if(!!this._breaks){this._started=!1;return}requestAnimFrame(function(){a.AnimateTiles()})},BeginAnimation:function(){!this._started&&this._tiles.length>0&&(this._breaks=!1,this.AnimateTiles())},StopAnimation:function(){this._breaks=!0},SetLinearEasingBoth:function(){this._easing=new Easing.Easer({type:"linear",side:"both"})},SetCircularEasingBoth:function(){this._easing=new Easing.Easer({type:"circular",side:"both"})},SetQuarticEasingOut:function(){this._easing=new Easing.Easer({type:"quartic",side:"out"})},GetMaxTileRatio:function(){return this._imageController.MaxRatio},DrawHelpers:function(a){this._helpers=a},DrawHelperText:function(a){this._helperText=a}}),PivotViewer.Views.Tile=Object.subClass({init:function(a){if(!(this instanceof PivotViewer.Views.Tile))return new PivotViewer.Views.Tile(a);this._controller=a,this._imageLoaded=!1,this._selected=!1,this._level=0,this._images=null,this._locations=[]},IsSelected:function(){return this._selected},Draw:function(){if(this.destinationVisible){var a=this.width>this.height?this.width:this.height,b=Math.ceil(Math.log(a)/Math.log(2));if(b==Infinity||b==-Infinity)b=0;this._level=b,this._images=this._controller.GetImagesAtLevel(this.facetItem.Img,this._level)}if(this._images!=null){if(typeof this._images=="function")this._images(this.facetItem,this.context,this._locations[0].x+4,this._locations[0].y+4,this.width-8,this.height-8);else if(this._images.length>0&&this._images[0]instanceof Image){var c=this._controller.GetHeight(this.facetItem.Img),d=this.height-8,e=Math.ceil(this._controller.GetWidthForImage(this.facetItem.Img,d));blankWidth=this.width-8-e;for(var f=0;f<this._images.length;f++){var g=this._images[f].src,h=this._controller._tileSize,i=g.match(/[0-9]+_[0-9]+/g),j=parseInt(i[i.length-1].substring(0,i[i.length-1].indexOf("_"))),k=parseInt(i[i.length-1].substring(i[i.length-1].indexOf("_")+1));i=g.match(/_files\/[0-9]+\//g);var m=parseInt(i[0].substring(7,i[0].length-1)),n=Math.ceil(c/Math.pow(2,this._controller.GetMaxLevel(this.facetItem.Img)-m)),o=d/n,p=Math.floor(blankWidth/2)+4+j*Math.floor(h*o),q=4+Math.floor(k*h*o),r=Math.ceil(this._images[f].height*o),s=Math.ceil(this._images[f].width*o);for(l=0;l<this._locations.length;l++)this.context.drawImage(this._images[f],p+this._locations[l].x,q+this._locations[l].y,s,r)}if(this._selected){this.context.beginPath();var p=Math.floor(blankWidth/2)+4,q=4;this.context.rect(p+this._locations[0].x,q+this._locations[0].y,e,d),this.context.lineWidth=4,this.context.strokeStyle="#92C4E1",this.context.stroke()}}}else this.DrawEmpty()},Contains:function(a,b){var c=!1;for(i=0;i<this._locations.length;i++)c=this._locations[0].x<=a&&this._locations[0].x+this.width>=a&&this._locations[0].y<=b&&this._locations[0].y+this.height>=b;return c},DrawEmpty:function(){this._controller.DrawLevel==undefined?(this.context.beginPath(),this.context.fillStyle="#D7DDDD",this.context.fillRect(this._locations[0].x+4,this._locations[0].y+4,this.width-8,this.height-8),this.context.rect(this._locations[0].x+4,this._locations[0].y+4,this.width-8,this.height-8),this.context.lineWidth=1,this.context.strokeStyle="white",this.context.stroke()):this._controller.DrawLevel(this.facetItem,this.context,this._locations[0].x+4,this._locations[0].y+4,this.width-8,this.height-8)},CollectionRoot:"",now:null,end:null,width:0,height:0,origwidth:0,origheight:0,ratio:1,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,facetItem:null,firstFilterItemDone:!1,Selected:function(a){this._selected=a}}),PivotViewer.Views.TileLocation=Object.subClass({init:function(){},x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0}),function(a){var b=[],c=[],d=[],e=[],f=0,g,h,i=[],j=[],k="",l,m=null,n=null,o={View:null,Facet:null,Filters:[]},p=null,q=0,r=new PivotViewer.Models.Collection,s={init:function(a){p=this,p.addClass("pv-wrapper"),InitPreloader();if(a.Loader==undefined)throw"Collection loader is undefined.";if(!(a.Loader instanceof PivotViewer.Models.Loaders.ICollectionLoader))throw"Collection loader does not inherit from PivotViewer.Models.Loaders.ICollectionLoader.";a.Loader.LoadCollection(r);if(a.ImageController==undefined)l=new PivotViewer.Views.DeepZoomImageController;else{if(!a.ImageController instanceof PivotViewer.Views.IImageController)throw"Image Controller does not inherit from PivotViewer.Views.IImageController.";l=a.ImageController}if(a.ViewerState!=undefined){var b=a.ViewerState.split("&");for(var c=0,d=b.length;c<d;c++){var e=b[c].split("=");if(e.length==2)if(e[0]=="$view$")o.View=parseInt(e[1])-1;else if(e[0]=="$facet0$")o.Facet=PivotViewer.Utils.EscapeItemId(e[1]);else{var f={Facet:e[0],Predicates:[]},g=e[1].split("_");for(var h=0,i=g.length;h<i;h++){var j=g[h].split(".");j.length==2&&f.Predicates.push({Operator:j[0],Value:j[1]})}o.Filters.push(f)}}}},show:function(){Debug.Log("Show")},hide:function(){Debug.Log("Hide")}};InitPreloader=function(){p.append("<div class='pv-loading'><img src='Content/images/loading.gif' alt='Loading' /><span>Loading...</span></div>"),a(".pv-loading").css("top",a(".pv-wrapper").height()/2-33+"px"),a(".pv-loading").css("left",a(".pv-wrapper").width()/2-43+"px")},InitTileCollection=function(){InitUI();var b=r.ImageBase;b.indexOf("http",0)>=0||b.indexOf("www.",0)>=0||(b=r.CXMLBase.substring(0,r.CXMLBase.lastIndexOf("/")+1)+b);var c=a(".pv-viewarea-canvas")[0].getContext("2d");h=new PivotViewer.Views.TileController(l),i=h.initTiles(r.Items,b,c),l.Setup(b.replace("\\","/"))},InitPivotViewer=function(){CreateFacetList(),CreateViews(),AttachEventHandlers(),a(".pv-loading").remove(),ApplyViewerState(),o.View!=null?SelectView(o.View,!0):SelectView(0,!0),h.BeginAnimation()},InitUI=function(){var b="<div class='pv-toolbarpanel'>",c=r.BrandImage;c.length>0&&(b+="<img class='pv-toolbarpanel-brandimage' src='"+c+"'></img>"),b+="<span class='pv-toolbarpanel-name'>"+r.CollectionName+"</span>",b+="<div class='pv-toolbarpanel-facetbreadcrumb'></div>",b+="<div class='pv-toolbarpanel-zoomcontrols'><div class='pv-toolbarpanel-zoomslider'></div></div>",b+="<div class='pv-toolbarpanel-viewcontrols'></div>",b+="<div class='pv-toolbarpanel-sortcontrols'></div>",b+="</div>",p.append(b);var d=q;a(".pv-toolbarpanel-zoomslider").slider({max:100,change:function(b,c){var e=c.value-d;centreX=a(".pv-viewarea-canvas").width()/2,centreY=a(".pv-viewarea-canvas").height()/2,a.publish("/PivotViewer/Views/Canvas/Zoom",[{x:centreX,y:centreY,delta:.5*e}]),d=c.value}}),p.append("<div class='pv-mainpanel'></div>");var e=a(".pv-wrapper").height()-a(".pv-toolbarpanel").height()-6;a(".pv-mainpanel").css("height",e+"px"),a(".pv-mainpanel").append("<div class='pv-filterpanel'></div>"),a(".pv-mainpanel").append("<div class='pv-viewpanel'><canvas class='pv-viewarea-canvas' width='"+p.width()+"' height='"+e+"px'></canvas></div>"),a(".pv-mainpanel").append("<div class='pv-infopanel'></div>");var f=a(".pv-filterpanel");f.append("<div class='pv-filterpanel-clearall'>Clear All</div>").append("<input class='pv-filterpanel-search' type='text' placeholder='Search...' /><div class='pv-filterpanel-search-autocomplete'></div>").css("height",e-13+"px"),a(".pv-filterpanel-search").css("width",f.width()-2+"px"),a(".pv-filterpanel-search-autocomplete").css("width",f.width()-8+"px").hide();var g=a(".pv-infopanel");g.css("left",a(".pv-mainpanel").offset().left+a(".pv-mainpanel").width()-205+"px").css("height",e-28+"px"),g.append("<div class='pv-infopanel-controls'></div>"),a(".pv-infopanel-controls").append("<div><div class='pv-infopanel-controls-navleft'></div><div class='pv-infopanel-controls-navleftdisabled'></div><div class='pv-infopanel-controls-navbar'></div><div class='pv-infopanel-controls-navright'></div><div class='pv-infopanel-controls-navrightdisabled'></div></div>"),a(".pv-infopanel-controls-navleftdisabled").hide(),a(".pv-infopanel-controls-navrightdisabled").hide(),g.append("<div class='pv-infopanel-heading'></div>"),g.append("<div class='pv-infopanel-details'></div>"),g.hide()},CreateFacetList=function(){for(var b=0;b<r.Items.length;b++){var f=r.Items[b];for(var g=0;g<r.FacetCategories.length;g++){var h=r.FacetCategories[g];if(h.IsFilterVisible){var i=!1;for(var j=0,k=f.Facets.length;j<k;j++){var l=f.Facets[j];if(l.Name==h.Name){for(var m=0;m<l.FacetValues.length;m++)if(h.Type==PivotViewer.Models.FacetType.String){var n=!1,o=PivotViewer.Utils.EscapeItemId("pv-facet-item-"+l.Name+"__"+l.FacetValues[m].Value);for(var p=c.length-1;p>-1;p-=1)if(c[p].itemId==o){c[p].count+=1,n=!0;break}n||c.push({itemId:o,itemValue:l.FacetValues[m].Value,facet:l.Name,count:1})}else if(h.Type==PivotViewer.Models.FacetType.Number){var q=!1;for(var p=0;p<d.length;p++)if(d[p].Facet==f.Facets[j].Name){d[p].Values.push(l.FacetValues[m].Value),q=!0;break}q||d.push({Facet:l.Name,Values:[l.FacetValues[m].Value]})}i=!0}}if(!i){var n=!1,o=PivotViewer.Utils.EscapeItemId("pv-facet-item-"+h.Name+"__(no info)");for(var p=c.length-1;p>-1;p-=1)if(c[p].itemId==o){c[p].count+=1,n=!0;break}n||c.push({itemId:o,itemValue:"(no info)",facet:h.Name,count:1})}}if(h.IsWordWheelVisible)for(var j=0,k=f.Facets.length;j<k;j++){var l=f.Facets[j];if(l.Name==h.Name)for(var m=0;m<l.FacetValues.length;m++)h.Type==PivotViewer.Models.FacetType.String&&e.push({Facet:l.Name,Value:l.FacetValues[m].Value})}}}var s=["<div class='pv-filterpanel-accordion'>"],t=[];for(var b=0;b<r.FacetCategories.length;b++)r.FacetCategories[b].IsFilterVisible&&(s[b+1]="<h3><a href='#'>",s[b+1]+=r.FacetCategories[b].Name,s[b+1]+="</a><div class='pv-filterpanel-accordion-heading-clear' facetType='"+r.FacetCategories[b].Type+"'>&nbsp;</div></h3>",s[b+1]+="<div style='height:30%' id='pv-cat-"+PivotViewer.Utils.EscapeItemId(r.FacetCategories[b].Name)+"'>",r.FacetCategories[b].Type==PivotViewer.Models.FacetType.String?(r.FacetCategories[b].CustomSort!=undefined||r.FacetCategories[b].CustomSort!=null?s[b+1]+="<span class='pv-filterpanel-accordion-facet-sort' customSort='"+r.FacetCategories[b].CustomSort.Name+"'>Sort: "+r.FacetCategories[b].CustomSort.Name+"</span>":s[b+1]+="<span class='pv-filterpanel-accordion-facet-sort'>Sort: A-Z</span>",s[b+1]+=CreateStringFacet(r.FacetCategories[b].Name)):r.FacetCategories[b].Type==PivotViewer.Models.FacetType.Number&&(s[b+1]+="<div id='pv-filterpanel-category-numberitem-"+r.FacetCategories[b].Name.replace(/\s+/gi,"|")+"'></div>"),s[b+1]+="</div>",t[b]="<option value='"+PivotViewer.Utils.EscapeItemId(r.FacetCategories[b].Name)+"' label='"+r.FacetCategories[b].Name+"'>"+r.FacetCategories[b].Name+"</option>");s[s.length]="</div>",a(".pv-filterpanel").append(s.join(""));for(var b=0;b<r.FacetCategories.length;b++)r.FacetCategories[b].IsFilterVisible&&SortFacetItems(r.FacetCategories[b].Name);a(".pv-filterpanel-accordion").css("height",a(".pv-filterpanel").height()-a(".pv-filterpanel-search").height()-50+"px"),a(".pv-filterpanel-accordion").accordion({}),a(".pv-toolbarpanel-sortcontrols").append('<select class="pv-toolbarpanel-sort">'+t.join("")+"</select>");for(var b=0;b<d.length;b++)CreateNumberFacet(PivotViewer.Utils.EscapeItemId(d[b].Facet),d[b].Values)},CreateStringFacet=function(a){var b=["<ul class='pv-filterpanel-accordion-facet-list'>"];for(var d=0;d<c.length;d++)c[d].facet==a&&(b[d+1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+c[d].itemId+"'>",b[d+1]+="<input itemvalue='"+c[d].itemValue.replace(/\s+/gi,"|")+"' itemfacet='"+a.replace(/\s+/gi,"|")+"' class='pv-facet-facetitem' type='checkbox' />",b[d+1]+="<span class='pv-facet-facetitem-label' title='"+c[d].itemValue+"'>"+c[d].itemValue+"</span>",b[d+1]+="<span class='pv-facet-facetitem-count'>0</span>",b[d+1]+="</li>");return b[b.length]="</ul>",b.join("")},CreateNumberFacet=function(b,c){var d=165,e=80,f=a("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(b));f.empty(),f.append("<span class='pv-filterpanel-numericslider-range-val'>&nbsp;</span>");var g="<svg class='pv-filterpanel-accordion-facet-chart' width='"+d+"' height='"+e+"'>",h=PivotViewer.Utils.Histogram(c),i=.5+d/h.BinCount|0,j=0;for(var k=0,l=h.Histogram.length;k<l;k++)j=j<h.Histogram[k].length?h.Histogram[k].length:j;for(var k=0,l=h.Histogram.length;k<l;k++){var m=.5+e/(j/h.Histogram[k].length)|0,n=.5+i*k|0;g+="<rect x='"+n+"' y='"+(e-m)+"' width='"+i+"' height='"+m+"'></rect>"}f.append(g+"</svg>");var o=a("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(b));o.append('</span><div id="pv-filterpanel-numericslider-'+b+'" class="pv-filterpanel-numericslider"></div><span class="pv-filterpanel-numericslider-range-min">'+h.Min+'</span><span class="pv-filterpanel-numericslider-range-max">'+h.Max+"</span>");var p=a("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeMetaChars(b));p.slider({range:!0,min:h.Min,max:h.Max,values:[h.Min,h.Max],slide:function(b,c){a(this).parent().find(".pv-filterpanel-numericslider-range-val").text(c.values[0]+" - "+c.values[1])},stop:function(b,c){var d=a(this),e=d.slider("option","min"),f=d.slider("option","max");c.values[0]>e||c.values[1]<f?d.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"):c.values[0]==e&&c.values[1]==f&&d.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection()}})},CreateViews=function(){var c=a(".pv-viewpanel"),d=p.width(),e=a(".pv-mainpanel").height(),f=a(".pv-filterpanel").width()+18,g=4;b.push(new PivotViewer.Views.GridView),b.push(new PivotViewer.Views.GraphView);for(var i=0;i<b.length;i++)try{b[i]instanceof PivotViewer.Views.IPivotViewerView?(b[i].Setup(d,e,f,g,h.GetMaxTileRatio()),c.append("<div class='pv-viewpanel-view' id='pv-viewpanel-view-"+i+"'>"+b[i].GetUI()+"</div>"),a(".pv-toolbarpanel-viewcontrols").append("<div class='pv-toolbarpanel-view' id='pv-toolbarpanel-view-"+i+"' title='"+b[i].GetViewName()+"'><img id='pv-viewpanel-view-"+i+"-image' src='"+b[i].GetButtonImage()+"' alt='"+b[i].GetViewName()+"' /></div>")):alert("View does not inherit from PivotViewer.Views.IPivotViewerView")}catch(j){alert(j.Message)}},SelectView=function(c,d){for(var e=0;e<b.length;e++)c!=e&&(a("#pv-viewpanel-view-"+e+"-image").attr("src",b[e].GetButtonImage()),b[e].Deactivate(),b[e].init=!1);a("#pv-viewpanel-view-"+c+"-image").attr("src",b[c].GetButtonImageSelected()),b[c].Activate(),b[c].init=d,f=c,FilterCollection()},SortFacetItems=function(b){var c=a("#pv-cat-"+PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId(b))+" ul"),d=c.prev().text().replace("Sort: ",""),e=c.children("li").get();if(d=="A-Z")e.sort(function(b,c){var d=a(b).children().first().attr("itemvalue"),e=a(c).children().first().attr("itemvalue");return d<e?1:d>e?-1:0});else if(d=="Quantity")e.sort(function(b,c){var d=parseInt(a(b).children(".pv-facet-facetitem-count").text()),e=parseInt(a(c).children(".pv-facet-facetitem-count").text());return d<e?-1:d>e?1:0});else{var f=r.GetFacetCategoryByName(b);if(f.CustomSort!=undefined){var g=[];for(var h=f.CustomSort.SortValues.length-1;h>-1;h-=1)for(var i=0;i<e.length;i++)f.CustomSort.SortValues[h]==a(e[i]).children(".pv-facet-facetitem-label").text()&&(g.push(e[i]),found=!0);e=g}}for(var h=0;h<e.length;h++)c.prepend(e[h])},ApplyViewerState=function(){o.Facet!=null&&a(".pv-toolbarpanel-sort").val(o.Facet).attr("selected","selected");for(var b=0,c=o.Filters.length;b<c;b++)for(var d=0,e=o.Filters[b].Predicates.length;d<e;d++){var f=o.Filters[b].Predicates[d].Operator;if(f=="GT"||f=="GE"||f=="LT"||f=="LE"){var g=a("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeItemId(o.Filters[b].Facet)),h=parseFloat(o.Filters[b].Predicates[d].Value);switch(f){case"GT":g.slider("values",0,h+1);break;case"GE":g.slider("values",0,h);break;case"LT":g.slider("values",1,h-1);break;case"LE":g.slider("values",1,h)}g.parent().find(".pv-filterpanel-numericslider-range-val").text(g.slider("values",0)+" - "+g.slider("values",1)),g.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")}else f=="EQ"?SelectStringFacetItem(PivotViewer.Utils.EscapeItemId(o.Filters[b].Facet),PivotViewer.Utils.EscapeItemId(o.Filters[b].Predicates[d].Value)):f=="NT"&&SelectStringFacetItem(PivotViewer.Utils.EscapeItemId(o.Filters[b].Facet),"(no|info)")}},SelectStringFacetItem=function(b,c){var d=a('.pv-facet-facetitem[itemfacet="'+b+'"][itemvalue="'+c+'"]');d.attr("checked","checked"),d.parent().parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")},FilterCollection=function(){var c=[],d=[],e=[],g=a(".pv-toolbarpanel-sort option:selected").text(),k=a(".pv-facet-facetitem:checked");a(".pv-filterpanel-clearall").css("visibility","hidden");var l=[];for(var m=0;m<k.length;m++){var n=a(k[m]).attr("itemfacet").replace(/\|/gi," "),o=a(k[m]).attr("itemvalue").replace(/\|/gi," "),p=!1;for(var q=0;q<l.length;q++)l[q].facet==n&&(l[q].facetValue.push(o),p=!0);p||l.push({facet:n,facetValue:[o]}),a.inArray(n,e)<0&&e.push(n)}var s=[];for(var m=0,t=r.FacetCategories.length;m<t;m++)if(r.FacetCategories[m].Type==PivotViewer.Models.FacetType.Number){var u=a("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(r.FacetCategories[m].Name.replace(/\s+/gi,"|"))),v=a(u).find(".pv-filterpanel-numericslider");if(v.length>0){var w=v.slider("values"),x=v.slider("option","max"),y=v.slider("option","min");if(w[0]!=y||w[1]!=x){var n=r.FacetCategories[m].Name;s.push({facet:n,selectedMin:w[0],selectedMax:w[1],rangeMin:y,rangeMax:x}),a.inArray(n,e)<0&&e.push(n)}}}for(var m=0,t=r.Items.length;m<t;m++){var z=0;for(var A=0,B=l.length;A<B;A++)for(var C=0,D=l[A].facetValue.length;C<D;C++)if(l[A].facetValue[C]=="(no info)"){var E=!1;for(var q=0,F=r.Items[m].Facets.length;q<F;q++)r.Items[m].Facets[q].Name==l[A].facet&&(E=!0);E==0&&z++}for(var q=0,F=r.Items[m].Facets.length;q<F;q++)for(var A=0,B=l.length;A<B;A++){var G=0;if(r.Items[m].Facets[q].Name==l[A].facet)for(var H=0,I=r.Items[m].Facets[q].FacetValues.length;H<I;H++)for(var C=0,D=l[A].facetValue.length;C<D;C++)r.Items[m].Facets[q].FacetValues[H].Value==l[A].facetValue[C]&&G++;G>0&&z++}if(z!=l.length)continue;for(var A=0,B=s.length;A<B;A++)if(s[A].selectedMin=="(no info)"){var E=!1;for(var q=0,F=r.Items[m].Facets.length;q<F;q++)r.Items[m].Facets[q].Name==s[A].facet&&(E=!0);E==0&&z++}for(var q=0,F=r.Items[m].Facets.length;q<F;q++)for(var A=0,B=s.length;A<B;A++)if(r.Items[m].Facets[q].Name==s[A].facet)for(var H=0,I=r.Items[m].Facets[q].FacetValues.length;H<I;H++){var J=parseFloat(r.Items[m].Facets[q].FacetValues[H].Value);!isNaN(J)&&J>=s[A].selectedMin&&J<=s[A].selectedMax&&z++}if(z!=l.length+s.length)continue;c.push(r.Items[m].Id),l.length+s.length>0&&a(".pv-filterpanel-clearall").css("visibility","visible")}a(".pv-viewpanel-view").hide(),a("#pv-viewpanel-view-"+f).show(),FilterFacets(c,e),UpdateBreadcrumbNavigation(l,s),h.SetCircularEasingBoth(),b[f].Filter(i,c,g);var K=[];for(var m=0;m<b[f].tiles.length;m++){var L=a.inArray(b[f].tiles[m].facetItem.Id,c);L>=0&&K.push(b[f].tiles[m].facetItem.Id)}j=K,DeselectInfoPanel()},FilterFacets=function(b,e){if(b.length==r.Items.length){for(var f=c.length-1;f>-1;f-=1){var g=a("#"+PivotViewer.Utils.EscapeMetaChars(c[f].itemId));g.show(),g.find("span").last().text(c[f].count)}for(var f=0;f<d.length;f++)CreateNumberFacet(PivotViewer.Utils.EscapeItemId(d[f].Facet),d[f].Values);return}var h=[],i=[];for(var f=b.length-1;f>-1;f-=1){var g=r.GetItemById(b[f]);for(var j=0;j<r.FacetCategories.length;j++)if(r.FacetCategories[j].IsFilterVisible){var k=!1;for(var l=g.Facets.length-1;l>-1;l-=1)if(g.Facets[l].Name==r.FacetCategories[j].Name){if(a.inArray(g.Facets[l].Name,e)<0){var m=r.GetFacetCategoryByName(g.Facets[l].Name);if(m.IsFilterVisible)for(var n=g.Facets[l].FacetValues.length-1;n>-1;n-=1)if(m.Type==PivotViewer.Models.FacetType.String){var o={item:"#"+PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId("pv-facet-item-"+g.Facets[l].Name+"__"+g.Facets[l].FacetValues[n].Value)),count:1},p=!1;for(var q=h.length-1;q>-1;q-=1)if(h[q].item==o.item){h[q].count+=1,p=!0;break}p||h.push(o)}else if(m.Type==PivotViewer.Models.FacetType.Number){var s=!1;for(var q=0;q<i.length;q++)if(i[q].Facet==g.Facets[l].Name){i[q].Values.push(g.Facets[l].FacetValues[n].Value),s=!0;break}s||i.push({Facet:g.Facets[l].Name,Values:[g.Facets[l].FacetValues[n].Value]})}}k=!0}if(!k){var o={item:"#"+PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId("pv-facet-item-"+r.FacetCategories[j].Name+"__(no info)")),count:1},p=!1;for(var q=h.length-1;q>-1;q-=1)if(h[q].item==o.item){h[q].count+=1,p=!0;break}p||h.push(o)}}}for(var f=c.length-1;f>-1;f-=1)if(a.inArray(c[f].facet,e)<0){var p=!1;for(var l=h.length-1;l>-1;l-=1)if(h[l].item==c[f].itemId){p=!0;break}p||a("#"+PivotViewer.Utils.EscapeMetaChars(c[f].itemId)).hide()}else a("#"+PivotViewer.Utils.EscapeMetaChars(c[f].itemId)).find("span").last().text(c[f].count);for(var f=h.length-1;f>-1;f-=1){var t=a(h[f].item);if(t.length>0){t.show();var u=t.find("span").last();u.text(h[f].count)}}for(var f=0;f<i.length;f++)CreateNumberFacet(PivotViewer.Utils.EscapeItemId(i[f].Facet),i[f].Values)},UpdateBreadcrumbNavigation=function(b,c){var d=a(".pv-toolbarpanel-facetbreadcrumb");d.empty();if(b.length==0)return;var e="|";for(var f=0,g=b.length;f<g;f++)e+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+b[f].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",e+=b[f].facetValue.join(", "),e+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>";for(var f=0,g=c.length;f<g;f++)e+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+c[f].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",c[f].selectedMin==c[f].rangeMin?e+="Under "+c[f].selectedMax:c[f].selectedMax==c[f].rangeMax?e+="Over "+c[f].selectedMin:e+=c[f].selectedMin+" - "+c[f].selectedMax,e+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>";d.append(e)},DeselectInfoPanel=function(){a(".pv-infopanel").fadeOut(),a(".pv-infopanel-heading").text(""),a(".pv-infopanel-details").empty()},GetItemIds=function(a,b){var c=[];for(var d=0;d<r.Items.length;d++){var e=!1;for(var f=0;f<r.Items[d].Facets.length;f++)if(r.Items[d].Facets[f].Name==a){for(var g=0;g<r.Items[d].Facets[f].FacetValues.length;g++)b==r.Items[d].Facets[f].FacetValues[g].Value&&c.push(r.Items[d].Id);e=!0}!e&&b=="(no info)"&&c.push(r.Items[d].Id)}return c},GetItem=function(a){for(var b=0;b<r.Items.length;b++)if(r.Items[b].Id==a)return r.Items[b];return null},a.subscribe("/PivotViewer/Models/Collection/Loaded",function(a){InitTileCollection()}),a.subscribe("/PivotViewer/ImageController/Collection/Loaded",function(a){InitPivotViewer()}),a.subscribe("/PivotViewer/Views/Item/Selected",function(b){if(b===undefined||b===null||b===""){DeselectInfoPanel();return}var c=GetItem(b);if(c!=null){var d=!0;a(".pv-infopanel-heading").text(c.Name);var e=a(".pv-infopanel-details");e.empty(),c.Description!=undefined&&c.Description.length>0&&e.append("<div class='pv-infopanel-detail-description' style='height:100px;'>"+c.Description+"</div><div class='pv-infopanel-detail-description-more'>More</div>"),c.Id==j[0]&&c==j[j.length-1]?(a(".pv-infopanel-controls-navright").hide(),a(".pv-infopanel-controls-navrightdisabled").show(),a(".pv-infopanel-controls-navleft").hide(),a(".pv-infopanel-controls-navleftdisabled").show()):c.Id==j[0]?(a(".pv-infopanel-controls-navleft").hide(),a(".pv-infopanel-controls-navleftdisabled").show(),a(".pv-infopanel-controls-navright").show(),a(".pv-infopanel-controls-navrightdisabled").hide()):c.Id==j[j.length-1]?(a(".pv-infopanel-controls-navright").hide(),a(".pv-infopanel-controls-navrightdisabled").show(),a(".pv-infopanel-controls-navleft").show(),a(".pv-infopanel-controls-navleftdisabled").hide()):(a(".pv-infopanel-controls-navright").show(),a(".pv-infopanel-controls-navrightdisabled").hide(),a(".pv-infopanel-controls-navleft").show(),a(".pv-infopanel-controls-navleftdisabled").hide());var f=[],g=0;for(var h=0;h<c.Facets.length;h++){var i=!1,l=!1;for(var m=0;m<r.FacetCategories.length;m++)if(r.FacetCategories[m].Name==c.Facets[h].Name&&r.FacetCategories[m].IsMetaDataVisible){i=!0,l=r.FacetCategories[m].IsFilterVisible;break}if(i){f[g]="<div class='pv-infopanel-detail "+(d?"detail-dark":"detail-light")+"'><div class='pv-infopanel-detail-item detail-item-title'>"+c.Facets[h].Name+"</div>";for(var m=0;m<c.Facets[h].FacetValues.length;m++)f[g]+="<div class='pv-infopanel-detail-item detail-item-value"+(l?" detail-item-value-filter":"")+"'>",c.Facets[h].FacetValues[m].Href!=null?f[g]+="<a class='detail-item-link' href='"+c.Facets[h].FacetValues[m].Href+"'>"+c.Facets[h].FacetValues[m].Value+"</a>":f[g]+=c.Facets[h].FacetValues[m].Value,f[g]+="</div>";f[g]+="</div>",g++,d=!d}}e.append(f.join("")),a(".pv-infopanel").fadeIn(),e.css("height",a(".pv-infopanel").height()-(a(".pv-infopanel-controls").height()+a(".pv-infopanel-heading").height())-20+"px"),k=c;return}}),a.subscribe("/PivotViewer/Views/Item/Filtered",function(b){if(b==undefined||b==null)return;for(var c=0,d=r.FacetCategories.length;c<d;c++){if(r.FacetCategories[c].Name==b.Facet&&r.FacetCategories[c].Type==PivotViewer.Models.FacetType.String){var e=a(PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId("#pv-facet-item-"+b.Facet+"__"+b.Item))+" input");e.attr("checked","checked"),FacetItemClick(e[0])}if(r.FacetCategories[c].Name==b.Facet&&r.FacetCategories[c].Type==PivotViewer.Models.FacetType.Number){var f=a("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeMetaChars(b.Facet));FacetSliderDrag(f,b.Item,b.MaxRange)}}}),AttachEventHandlers=function(){a(".pv-toolbarpanel-view").on("click",function(a){var b=this.id.substring(this.id.lastIndexOf("-")+1,this.id.length);b!=null&&SelectView(parseInt(b),!1)}),a(".pv-toolbarpanel-sort").on("change",function(a){FilterCollection()}),a(".pv-filterpanel-accordion-facet-sort").on("click",function(b){var c=a(this),d=c.text(),e=c.parent().prev().children("a").text(),f=c.attr("customSort");d=="Sort: A-Z"?a(this).text("Sort: Quantity"):d=="Sort: Quantity"&&f==undefined?a(this).text("Sort: A-Z"):d=="Sort: Quantity"?a(this).text("Sort: "+f):a(this).text("Sort: A-Z"),SortFacetItems(e)}),a(".pv-facet-facetitem").on("click",function(a){FacetItemClick(this)}),a(".pv-facet-facetitem-label").on("click",function(b){var c=a(this).prev(),d=a(this.parentElement.parentElement).find(":checked");c.attr("checked")=="checked"&&d.length<=1?c.removeAttr("checked"):c.attr("checked","checked");for(var e=d.length-1;e>-1;e-=1)d[e].getAttribute("itemvalue")!=c[0].getAttribute("itemvalue")&&(d[e].checked=!1);FacetItemClick(c[0])}),a(".pv-filterpanel-clearall").on("click",function(b){var c=a(".pv-facet-facetitem:checked");for(var d=0;d<c.length;d++)a(c[d]).removeAttr("checked");var e=a(".pv-filterpanel-numericslider");for(var d=0;d<e.length;d++){var f=a(e[d]),g=f.slider("option","min"),h=f.slider("option","max");f.slider("values",0,g),f.slider("values",1,h),f.prev().prev().html("&nbsp;")}a(".pv-filterpanel-search").val(""),a(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection()}),a(".pv-filterpanel-accordion-heading-clear").on("click",function(b){var c=this.attributes.facetType.value;if(c=="String"){var d=a(this.parentElement).next().find(".pv-facet-facetitem:checked");for(var e=0;e<d.length;e++)a(d[e]).removeAttr("checked")}else if(c=="Number"){var f=a(this.parentElement).next().find(".pv-filterpanel-numericslider"),g=f.slider("option","min"),h=f.slider("option","max");f.slider("values",0,g),f.slider("values",1,h),f.prev().prev().html("&nbsp;")}FilterCollection(),a(this).css("visibility","hidden")}),a(".ui-slider-range").on("mousedown",function(a){}),a(".pv-infopanel-details").on("click",".detail-item-value-filter",function(b){return a.publish("/PivotViewer/Views/Item/Filtered",[{Facet:a(this).parent().children().first().text(),Item:a(this).text()}]),!1}),a(".pv-infopanel-details").on("click",".pv-infopanel-detail-description-more",function(b){var c=a(this),d=a(this).prev();c.text()=="More"?(d.css("height",""),a(this).text("Less")):(d.css("height","100px"),a(this).text("More"))}),a(".pv-infopanel-controls-navleft").on("click",function(c){for(var d=0;d<j.length;d++)if(j[d]==k.Id){d>=0&&a.publish("/PivotViewer/Views/Item/Selected",[j[d-1]]);for(var e=0;e<i.length;e++)i[e].facetItem.Id==j[d-1]?(i[e].Selected(!0),selectedCol=b[f].GetSelectedCol(i[e]),selectedRow=b[f].GetSelectedRow(i[e]),b[f].CentreOnSelectedTile(selectedCol,selectedRow)):i[e].Selected(!1);break}}),a(".pv-infopanel-controls-navright").on("click",function(c){for(var d=0;d<j.length;d++)if(j[d]==k.Id){if(d<j.length){a.publish("/PivotViewer/Views/Item/Selected",[j[d+1]]);for(var e=0;e<i.length;e++)i[e].facetItem.Id==j[d+1]?(i[e].Selected(!0),selectedCol=b[f].GetSelectedCol(i[e]),selectedRow=
b[f].GetSelectedRow(i[e]),b[f].CentreOnSelectedTile(selectedCol,selectedRow)):i[e].Selected(!1)}break}}),a(".pv-filterpanel-search").on("keyup",function(b){var c=!1,d=[],f=a(".pv-filterpanel-search-autocomplete"),g=FilterCollection,h=SelectStringFacetItem;f.empty();if(b.keyCode==27){a(b.target).blur();return}for(var i=0,j=e.length;i<j;i++){var k=e[i].Value.toLowerCase();k.indexOf(b.target.value.toLowerCase())>=0&&a.inArray(k,d)==-1&&(d.push(k),f.append('<span facet="'+e[i].Facet+'">'+e[i].Value+"</span>"),b.keyCode==13&&(SelectStringFacetItem(PivotViewer.Utils.EscapeItemId(e[i].Facet),PivotViewer.Utils.EscapeItemId(e[i].Value)),c=!0))}a(".pv-filterpanel-search-autocomplete > span").on("mousedown",function(b){b.preventDefault(),a(".pv-filterpanel-search").val(b.target.textContent),a(".pv-filterpanel-search-autocomplete").hide(),h(PivotViewer.Utils.EscapeItemId(b.target.attributes[0].value),PivotViewer.Utils.EscapeItemId(b.target.textContent)),g()}),d.length>0&&f.show(),c&&FilterCollection()}),a(".pv-filterpanel-search").on("blur",function(b){b.target.value="",a(".pv-filterpanel-search-autocomplete").hide()});var c=a(".pv-viewarea-canvas");c.on("mouseup",function(b){var c=a(this).offset(),d=b.clientX-c.left,e=b.clientY-c.top;(!n||n.x==0&&n.y==0)&&a.publish("/PivotViewer/Views/Canvas/Click",[{x:d,y:e}]),m=null,n=!1}),c.on("mouseout",function(a){m=null,n=!1}),c.on("mousedown",function(b){var c=a(this).offset(),d=b.clientX-c.left,e=b.clientY-c.top;m={x:d,y:e}}),c.on("mousemove",function(b){var c=a(this).offset(),d=b.clientX-c.left,e=b.clientY-c.top;m==null?a.publish("/PivotViewer/Views/Canvas/Hover",[{x:d,y:e}]):(n={x:d-m.x,y:e-m.y},m={x:d,y:e},a.publish("/PivotViewer/Views/Canvas/Drag",[n]))}),c.on("mousewheel",function(b,c){var d=a(this).offset(),e=b.clientX-d.left,f=b.clientY-d.top;h.SetQuarticEasingOut(),h.DrawHelpers([{x:e,y:f}]);var g=a(".pv-toolbarpanel-zoomslider").slider("option","value");c>0?g=g<5?5:g+5:c<0&&(g-=5),g=Math.max(0,Math.min(100,g)),a(".pv-toolbarpanel-zoomslider").slider("option","value",g)}),c.on("touchstart",function(b){var c=b.originalEvent,d=a(this).offset(),e=c.touches[0].pageX-d.left,f=c.touches[0].pageY-d.top;m={x:e,y:f}}),c.on("touchmove",function(b){try{var c=b.originalEvent;b.preventDefault();if(c.touches.length>1){b.preventDefault();var d=1e7,e=1e7,f=0,g=0,i=[];for(var j=0;j<c.touches.length;j++)i.push({x:c.touches[j].pageX,y:c.touches[j].pageY}),c.touches[j].pageX<d&&(d=c.touches[j].pageX),c.touches[j].pageX>f&&(f=c.touches[j].pageX),c.touches[j].pageY<e&&(e=c.touches[j].pageY),c.touches[j].pageY>g&&(g=c.touches[j].pageY);var k=(d+f)/2,l=(e+g)/2;h.SetLinearEasingBoth(),i.push({x:k,y:l}),h.DrawHelpers(i),h.DrawHelperText("Scale: "+c.scale),a.publish("/PivotViewer/Views/Canvas/Zoom",[{x:k,y:l,scale:c.scale}]);return}var o=a(this).offset(),p=c.touches[0].pageX-o.left,q=c.touches[0].pageY-o.top;n={x:p-m.x,y:q-m.y},m={x:p,y:q},a.publish("/PivotViewer/Views/Canvas/Drag",[n])}catch(r){Debug.Log(r.message)}}),c.on("touchend",function(b){var c=b.originalEvent;if(c.touches.length==1&&m==null){var d=a(this).offset(),e=c.touches[0].pageX-d.left,f=c.touches[0].pageY-d.top;(!n||n.x==0&&n.y==0)&&a.publish("/PivotViewer/Views/Canvas/Click",[{x:e,y:f}])}m=null,n=!1;return})},FacetItemClick=function(b){a(b).attr("checked")=="checked"&&a(b.parentElement.parentElement.parentElement).prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"),FilterCollection()},FacetSliderDrag=function(b,c,d){var e=a(b),f=e.slider("option","min"),g=e.slider("option","max");c=="(no info)"&&(c=0),c>f||d<g?(e.parent().find(".pv-filterpanel-numericslider-range-val").text(c+" - "+d),e.slider("values",0,c),e.slider("values",1,d),e.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")):c==f&&d==g&&e.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection()},a.fn.PivotViewer=function(b){if(s[b])return s[b].apply(this,Array.prototype.slice.call(arguments,1));if(typeof b=="object"||!b)return s.init.apply(this,arguments);a.error("Method "+b+" does not exist on jQuery.PivotViewer")}}(jQuery);