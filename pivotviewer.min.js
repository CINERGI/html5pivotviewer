//PivotViewer 0.4.4
var PivotViewer=PivotViewer||{};PivotViewer.Models={},PivotViewer.Models.Loaders={},PivotViewer.Utils={},PivotViewer.Views={};var Debug=Debug||{};(function(a){var b={};a.publish=function(c,e){b[c]&&a.each(b[c],function(){this.apply(a,e||[])})},a.subscribe=function(a,c){return b[a]||(b[a]=[]),b[a].push(c),[a,c]},a.unsubscribe=function(c){var e=c[0];b[e]&&a.each(b[e],function(a){this==c[1]&&b[e].splice(a,1)})}})(jQuery),Debug.Log=function(a){window.console&&window.console.log&&typeof debug!="undefined"&&debug==1&&window.console.log(a)},window.requestAnimFrame=function(a){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),PivotViewer.Utils.EscapeMetaChars=function(a){return a.replace(/\|/gi,"\\|").replace(/\//gi,"\\/").replace(/'/gi,"\\'").replace(/,/gi,"\\,").replace(/:/gi,"\\:").replace(/\(/gi,"\\(").replace(/\)/gi,"\\)")},PivotViewer.Utils.EscapeItemId=function(a){return a.replace(/\s+/gi,"|").replace(/'/gi,"").replace(/\(/gi,"").replace(/\)/gi,"").replace(/\./gi,"")},function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(c){function g(){!a&&this.init&&this.init.apply(this,arguments)}var d=this.prototype;a=!0;var e=new this;a=!1;for(var f in c)e[f]=typeof c[f]=="function"&&typeof d[f]=="function"&&b.test(c[f])?function(a,b){return function(){var c=this._super;this._super=d[a];var e=b.apply(this,arguments);return this._super=c,e}}(f,c[f]):c[f];return g.prototype=e,g.constructor=g,g.subClass=arguments.callee,g}}(),PivotViewer.Models.Collection=Object.subClass({init:function(){var a="http://schemas.microsoft.com/collection/metadata/2009",b="http://schemas.microsoft.com/livelabs/pivot/collection/2009";this.CollectionName="",this.BrandImage="",this.FacetCategories=[],this.Items=[],this.ImageBase=""},GetItemById:function(a){for(var b=0;b<this.Items.length;b++)if(this.Items[b].Id==a)return this.Items[b];return null},GetFacetCategoryByName:function(a){for(var b=0;b<this.FacetCategories.length;b++)if(this.FacetCategories[b].Name==a)return this.FacetCategories[b];return null}}),PivotViewer.Models.FacetCategory=Object.subClass({init:function(a,b,c,d,e,f,g){this.Name=a,this.Format=b,this._type=c!=null&&c!=undefined?c:PivotViewer.Models.FacetType.String,this.IsFilterVisible=d!=null&&d!=undefined?d:!0,this.IsMetaDataVisible=e!=null&&e!=undefined?e:!0,this.IsWordWheelVisible=f!=null&&f!=undefined?f:!0,this.CustomSort},getType:function(){switch(this._type){case"String":return PivotViewer.Models.FacetType.String}}}),PivotViewer.Models.FacetCategorySort=Object.subClass({init:function(a){this.Name=a,this.SortValues=[]}}),PivotViewer.Models.Item=Object.subClass({init:function(a,b,c,d){this.Img=a,this.Id=b,this.Href=c,this.Name=d,this.Description,this.Facets=[]}}),PivotViewer.Models.Facet=Object.subClass({init:function(a){this.Name=a,this.FacetValues=[]},AddFacetValue:function(a){this.FacetValues.push(a)}}),PivotViewer.Models.FacetValue=Object.subClass({init:function(a){this.Value=a,this.Href=""}}),PivotViewer.Models.FacetType={String:"String",LongString:"LongString",Number:"Number",DateTime:"DateTime",Link:"Link"},PivotViewer.Models.Loaders.ICollectionLoader=Object.subClass({init:function(){},LoadCollection:function(a){if(!a instanceof PivotViewer.Models.Collection)throw"collection not an instance of PivotViewer.Models.Collection."}}),PivotViewer.Models.Loaders.CXMLLoader=PivotViewer.Models.Loaders.ICollectionLoader.subClass({init:function(a){this.CXMLUri=a},LoadCollection:function(a){var a=a;this._super(a),a.CXMLBase=this.CXMLUri,$.ajax({type:"GET",url:this.CXMLUri,dataType:"xml",success:function(b){Debug.Log("CXML loaded");var c=$(b).find("Collection")[0],d="P";for(var e=0;e<c.attributes.length;e++)if(c.attributes[e].value=="http://schemas.microsoft.com/livelabs/pivot/collection/2009"){d=c.attributes[e].localName!=undefined?c.attributes[e].localName:c.attributes[e].baseName;break}a.CollectionName=$(c).attr("Name"),a.BrandImage=$(c).attr(d+":BrandImage")!=undefined?$(c).attr(d+":BrandImage"):"";var f=$(b).find("FacetCategory");for(var e=0;e<f.length;e++){var g=$(f[e]),h=new PivotViewer.Models.FacetCategory(g.attr("Name"),g.attr("Format"),PivotViewer.Models.FacetType.String,g.attr(d+":IsFilterVisible")!=undefined?g.attr(d+":IsFilterVisible").toLowerCase()=="true"?!0:!1:!1,g.attr(d+":IsMetaDataVisible")!=undefined?g.attr(d+":IsMetaDataVisible").toLowerCase()=="true"?!0:!1:!1,g.attr(d+":IsWordWheelVisible")!=undefined?g.attr(d+":IsWordWheelVisible").toLowerCase()=="true"?!0:!1:!1),i=g.find(d+"\\:SortOrder"),j=i.find(d+"\\:SortValue");i.length==0&&(i=g.find("SortOrder"),j=i.find("SortValue"));if(i.length==1){var k=new PivotViewer.Models.FacetCategorySort(i.attr("Name"));for(var l=0;l<j.length;l++)k.SortValues.push($(j[l]).attr("Value"));h.CustomSort=k}a.FacetCategories.push(h)}var m=$(b).find("Items");if(m.length==1){a.ImageBase=$(m[0]).attr("ImgBase");var n=$(m[0]).find("Item");for(var e=0;e<n.length;e++){var o=new PivotViewer.Models.Item($(n[e]).attr("Img").replace("#",""),$(n[e]).attr("Id"),$(n[e]).attr("Href"),$(n[e]).attr("Name")),p=$(n[e]).find("Description");p.length==1&&p[0].childNodes.length&&(o.Description=p[0].childNodes[0].nodeValue);var q=$(n[e]).find("Facet");for(var l=0;l<q.length;l++){var r=new PivotViewer.Models.Facet($(q[l]).attr("Name")),s=$(q[l]).children();for(var t=0;t<s.length;t++)if(s[t].nodeType==1){var u=$.trim($(s[t]).attr("Value"));if(u==null){var v=new PivotViewer.Models.FacetValue($(s[t]).attr("Name"));v.Href=$(s[t]).attr("Href"),r.AddFacetValue(v)}else{var v=new PivotViewer.Models.FacetValue(u);r.AddFacetValue(v)}}o.Facets.push(r)}a.Items.push(o)}}$.publish("/PivotViewer/Models/Collection/Loaded",null)}})}}),PivotViewer.Views.IPivotViewerView=Object.subClass({init:function(){this.isActive=!1,this.init=!0,this.selected="",this.tiles=[]},Setup:function(a,b,c,d,e){},Filter:function(a,b,c){},GetUI:function(){return""},GetButtonImage:function(){return""},GetButtonImageSelected:function(){return""},GetViewName:function(){return""},Activate:function(){this.isActive=!0},Deactivate:function(){this.isActive=!1}}),PivotViewer.Views.TileBasedView=PivotViewer.Views.IPivotViewerView.subClass({OffsetTiles:function(a,b){for(var c=0;c<this.tiles.length;c++){var d=$.inArray(this.tiles[c].facetItem.Id,this.currentFilter);d>=0&&(this.tiles[c].destinationx+=a,this.tiles[c].destinationy+=b)}},SetInitialTiles:function(a,b,c){var d=b/2,e=c/2;for(var f=0;f<a.length;f++)a[f].x=d,a[f].y=e,a[f].velocityx=0,a[f].velocityy=0,a[f].startx=d,a[f].starty=e,a[f].destinationx=0,a[f].destinationy=0,a[f].width=1,a[f].height=1},GetRowsAndColumns:function(a,b,c,d){var e=.7,f=c*(d-Math.pow(e,2)),g=(b+a*c)*e,h=-1*b*a,i=(-1*g+Math.sqrt(Math.pow(g,2)-4*f*h))/(2*f),j=i*c,k=Math.floor(b/j),l=Math.floor(a/i);return{Rows:k,Columns:l,TileWidth:i,TileHeight:j}},SetOuterTileDestination:function(a,b,c){var d=c.x-a/2,e=c.y-b/2,f=e/d,g=Math.atan2(e,d);c.destinationx=a*Math.cos(g)+a/2,c.destinationy=b*Math.sin(g)+b/2},SortBy:function(a,b,c){var d=function(b){if(c)for(var d=b.facetItem.Facets.length-1;d>-1;d-=1)if(b.facetItem.Facets[d].Name==a&&b.facetItem.Facets[d].FacetValues.length>0)return c(b.facetItem.Facets[d].FacetValues[0].Value);return null};return function(a,c){var e=d(a),f=d(c);return(e<f?-1:e>f?1:0)*[1,-1][+!!b]}}}),PivotViewer.Views.GridView=PivotViewer.Views.TileBasedView.subClass({init:function(){this._super();var a=this;$.subscribe("/PivotViewer/Views/Canvas/Click",function(b){if(!a.isActive)return;var c="",d=0,e=0,f=0,g=0;for(var h=0;h<a.tiles.length;h++)a.tiles[h].Contains(b.x,b.y)?(c=a.tiles[h].facetItem.Id,d=Math.round((a.tiles[h].x-a.currentOffsetX)/a.tiles[h].width),e=Math.round((a.tiles[h].y-a.currentOffsetY)/a.tiles[h].height),a.tiles[h].Selected(!0),f=a.tiles[h].x,g=a.tiles[h].y):a.tiles[h].Selected(!1);if(c.length>0&&a.selected!=c){a.selected=c,a.width<a.height?(a.currentWidth=a.width*a.rowscols.Columns*.9,a.currentHeight=a.height/a.width*a.currentWidth):(a.currentHeight=a.height*a.rowscols.Rows*.9,a.currentWidth=a.width/a.height*a.currentHeight);var i=a.GetRowsAndColumns(a.currentWidth-a.offsetX,a.currentHeight-a.offsetY,a.ratio,a.currentFilter.length);a.currentOffsetX=i.TileWidth*d*-1+a.width/2-i.TileWidth/2,a.currentOffsetY=i.TileHeight*e*-1+a.height/2-i.TileHeight/2,a.SetVisibleTilePositions(i,a.currentFilter,a.currentOffsetX,a.currentOffsetY,!0,!0,1e3)}else{a.selected=c="",a.currentOffsetX=a.offsetX,a.currentOffsetY=a.offsetY,a.currentWidth=a.width,a.currentHeight=a.height;var i=a.GetRowsAndColumns(a.currentWidth-a.offsetX,a.currentHeight-a.offsetY,a.ratio,a.currentFilter.length);a.SetVisibleTilePositions(i,a.currentFilter,a.currentOffsetX,a.currentOffsetY,!0,!0,1e3)}$.publish("/PivotViewer/Views/Item/Selected",[c])}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(b){if(!a.isActive||a.selected.length>0)return;for(var c=0;c<a.tiles.length;c++)a.tiles[c].Contains(b.x,b.y)?a.tiles[c].Selected(!0):a.tiles[c].Selected(!1)}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(b){if(!a.isActive)return;var c=a.currentWidth,d=a.currentHeight;b.scale>0?a.currentScale+=Math.abs(b.scale-a.prevScale):a.currentScale-=Math.abs(a.prevScale-b.scale);var e=a.width;if(b.scale!=undefined)e=a.width*(b.scale+a.prevScale);else{if(b.delta==undefined)return;e=a.currentWidth+a.currentWidth*.5*(b.delta>=0?1:-1)}a.prevScale=b.scale,e<a.width?(a.currentOffsetX=a.offsetX,a.currentOffsetY=a.offsetY,a.currentWidth=a.width,a.currentHeight=a.height,a.prevScale=0):(a.currentWidth=e,a.currentHeight=d/c*a.currentWidth,a.currentWidth/a.rowscols.Columns>a.width&&(a.currentWidth=a.width*a.rowscols.Columns,a.currentHeight=d/c*a.currentWidth),a.currentHeight/a.rowscols.Rows>a.height&&(a.currentHeight=a.height*a.rowscols.Rows,a.currentWidth=c/d*a.currentHeight),a.currentOffsetX=(b.x-a.offsetX)/a.width*(a.currentWidth-a.width)*-1+a.offsetX,a.currentOffsetY=(b.y-a.offsetY)/a.height*(a.currentHeight-a.height)*-1+a.offsetY);var f=a.GetRowsAndColumns(a.currentWidth-a.offsetX,a.currentHeight-a.offsetY,a.ratio,a.currentFilter.length);a.SetVisibleTilePositions(f,a.currentFilter,a.currentOffsetX,a.currentOffsetY,!0,!0,100);if(b.delta<0){for(var g=0;g<a.tiles.length;g++)a.tiles[g].Selected(!1);a.selected="",$.publish("/PivotViewer/Views/Item/Selected",[a.selected])}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(b){var c=b.x,d=b.y,e=!1,f=!1;a.currentOffsetX+=c,a.currentOffsetY+=d,c>0&&a.currentOffsetX>a.offsetX&&(a.currentOffsetX-=c,e=!0),d>0&&a.currentOffsetY>a.offsetY&&(a.currentOffsetY-=d,f=!0),a.currentOffsetX<a.offsetX&&a.currentWidth==a.width&&(a.currentOffsetX-=c,e=!0),c<0&&a.currentOffsetX-a.offsetX<-1*(a.currentWidth-a.width)&&(a.currentOffsetX-=c,e=!0),a.currentOffsetY<a.offsetY&&a.currentHeight==a.height&&(a.currentOffsetY-=d,f=!0),d<0&&a.currentOffsetY-a.offsetY<-1*(a.currentHeight-a.height)&&(a.currentOffsetY-=d,f=!0);if(e&&f)return;e?a.OffsetTiles(0,d):f?a.OffsetTiles(c,0):a.OffsetTiles(c,d)})},Setup:function(a,b,c,d,e){this.width=a,this.height=b,this.offsetX=c,this.offsetY=d,this.ratio=e,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY},Filter:function(a,b,c){var d=this;if(!Modernizr.canvas)return;Debug.Log("Grid View Filtered: "+b.length),this.tiles=a,this.init&&this.SetInitialTiles(this.tiles,this.width,this.height),this.tiles=this.tiles.sort(this.SortBy(c,!1,function(a){return a.toUpperCase()})),this.currentFilter=b;var e=0;Debug.Log("this.currentWidth: "+this.currentWidth+" this.width: "+this.width);if(this.currentWidth!=this.width&&!this.init){this.selected=selectedItem="",this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,this.currentWidth=this.width,this.currentHeight=this.height;var f=this.GetRowsAndColumns(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.ratio,this.tiles.length),g=[];for(var h=0;h<this.tiles.length;h++)g.push(this.tiles[h].facetItem.Id);this.SetVisibleTilePositions(f,g,this.currentOffsetX,this.currentOffsetY,!0,!1,1e3),e=1e3}setTimeout(function(){for(var a=0;a<d.tiles.length;a++){d.tiles[a].startx=d.tiles[a].x,d.tiles[a].starty=d.tiles[a].y,d.tiles[a].startwidth=d.tiles[a].width,d.tiles[a].startheight=d.tiles[a].height;var c=$.inArray(d.tiles[a].facetItem.Id,b);c<0&&(d.SetOuterTileDestination(d.width,d.height,d.tiles[a]),d.tiles[a].start=Now(),d.tiles[a].end=d.tiles[a].start+1e3)}var e=b.length==d.tiles.length?0:500;setTimeout(function(){var a=d.GetRowsAndColumns(d.width-d.offsetX,d.height-d.offsetY,d.ratio,d.currentFilter.length);d.SetVisibleTilePositions(a,d.currentFilter,d.offsetX,d.offsetY,!1,!1,1e3)},e)},e),this.init=!1},GetUI:function(){return Modernizr.canvas?"":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"../media/GridView.png"},GetButtonImageSelected:function(){return"../media/GridViewSelected.png"},GetViewName:function(){return"Grid View"},SetVisibleTilePositions:function(a,b,c,d,e,f,g){var h=f?this.rowscols.Columns:a.Columns;f||(this.rowscols=a);var i=0,j=0;for(var k=0;k<this.tiles.length;k++){var l=$.inArray(this.tiles[k].facetItem.Id,b);l>=0&&(e&&(this.tiles[k].startx=this.tiles[k].x,this.tiles[k].starty=this.tiles[k].y,this.tiles[k].startwidth=this.tiles[k].width,this.tiles[k].startheight=this.tiles[k].height),this.tiles[k].destinationwidth=a.TileWidth,this.tiles[k].destinationheight=a.TileHeight,this.tiles[k].destinationx=i*a.TileWidth+c,this.tiles[k].destinationy=j*a.TileHeight+d,this.tiles[k].start=Now(),this.tiles[k].end=this.tiles[k].start+g,i==h-1?(i=0,j++):i++)}}}),PivotViewer.Views.GraphView=PivotViewer.Views.TileBasedView.subClass({init:function(){this._super();var a=this;this.buckets=[],this.canvasHeightUIAdjusted=0,$.subscribe("/PivotViewer/Views/Canvas/Click",function(b){if(!a.isActive)return;var c="";for(var d=0;d<a.tiles.length;d++)if(a.tiles[d].Contains(b.x,b.y)){c=a.tiles[d].facetItem.Id;break}if(c.length>0)$.publish("/PivotViewer/Views/Item/Selected",[c]);else{var e=Math.floor(b.x/a.columnWidth);$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:a.sortFacet,Item:a.buckets[e].startRange}])}}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(b){if(!a.isActive)return;$(".pv-viewarea-graphview-overlay-bucket").removeClass("graphview-bucket-hover");var c=Math.floor((b.x-a.offsetX)/a.columnWidth),d=$("#pv-viewarea-graphview-overlay-bucket-"+c);d.addClass("graphview-bucket-hover");for(var e=0;e<a.tiles.length;e++)a.tiles[e].Contains(b.x,b.y)?a.tiles[e].Selected(!0):a.tiles[e].Selected(!1)})},Setup:function(a,b,c,d,e){this.width=a,this.height=b,this.offsetX=c,this.offsetY=d,this.ratio=e,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,this.rowscols=null,this.bigCount=0},Filter:function(a,b,c){var d=this;if(!Modernizr.canvas)return;Debug.Log("Graph View Filtered: "+b.length),this.sortFacet=c,this.tiles=a,this.tiles=a.sort(this.SortBy(this.sortFacet,!1,function(a){return a.toUpperCase()})),this.currentFilter=b,this.buckets=this.Bucketize(a,b,this.sortFacet),this.columnWidth=(this.width-this.offsetX)/this.buckets.length,this.canvasHeightUIAdjusted=this.height-62;var e=[];for(var f=0;f<this.buckets.length;f++){var g=f%2==0?"graphview-bucket-dark":"graphview-bucket-light";e[f]="<div class='pv-viewarea-graphview-overlay-bucket "+g+"' id='pv-viewarea-graphview-overlay-bucket-"+f+"' style='width: "+(Math.floor(this.columnWidth)-4)+"px; height:"+this.height+"px; left:"+(f*this.columnWidth-2)+"px;'>",this.buckets[f].startRange==this.buckets[f].endRange?e[f]+="<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[f].startRange+"</div></div>":e[f]+="<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[f].startRange+"<br/>to<br/>"+this.buckets[f].endRange+"</div></div>",this.bigCount<this.buckets[f].Ids.length&&(this.bigCount=this.buckets[f].Ids.length)}var h=$(".pv-viewarea-graphview-overlay");h.css("left",this.offsetX+"px"),$(".pv-viewarea-graphview-overlay div").fadeOut("slow",function(){$(this).remove()}),h.append(e.join("")),$(".pv-viewarea-graphview-overlay div").fadeIn("slow");for(var f=0;f<this.tiles.length;f++){this.tiles[f].startx=this.tiles[f].x,this.tiles[f].starty=this.tiles[f].y,this.tiles[f].startwidth=this.tiles[f].width,this.tiles[f].startheight=this.tiles[f].height;var i=$.inArray(this.tiles[f].facetItem.Id,b);i<0&&(SetOuterTileDestination(this.width,this.height,this.tiles[f]),this.tiles[f].start=Now(),this.tiles[f].end=this.tiles[f].start+1e3)}var j=b.length==this.tiles.length?0:500;setTimeout(function(){var a=d.width-d.offsetX,b=d.height-d.offsetY;d.rowscols=d.GetRowsAndColumns(d.columnWidth-2,d.canvasHeightUIAdjusted,d.ratio,d.bigCount),d.SetVisibleTileGraphPositions(d.rowscols,d.offsetX,d.offsetY,!1,!1)},j),this.init=!1},GetUI:function(){return Modernizr.canvas?"<div class='pv-viewarea-graphview-overlay'></div>":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"../media/GraphView.png"},GetButtonImageSelected:function(){return"../media/GraphViewSelected.png"},GetViewName:function(){return"Graph View"},SetVisibleTileGraphPositions:function(a,b,c,d,e){var f=e?this.rowscols.Columns:a.Columns;e||(this.rowscols=a);for(var g=0;g<this.buckets.length;g++){var h=0,i=0;for(var j=this.tiles.length-1;j>-1;j-=1)$.inArray(this.tiles[j].facetItem.Id,this.buckets[g].Ids)>=0&&(d&&(this.tiles[g].startx=this.tiles[g].x,this.tiles[g].starty=this.tiles[g].y,this.tiles[g].startwidth=this.tiles[g].width,this.tiles[g].startheight=this.tiles[g].height),this.tiles[j].destinationwidth=a.TileWidth,this.tiles[j].destinationheight=a.TileHeight,this.tiles[j].destinationx=g*this.columnWidth+h*a.TileWidth+b,this.tiles[j].destinationy=this.canvasHeightUIAdjusted-a.TileHeight-i*a.TileHeight+c,this.tiles[j].start=Now(),this.tiles[j].end=this.tiles[j].start+1e3,h==a.Columns-1?(h=0,i++):h++)}},Bucketize:function(a,b,c){var d=[];for(var e=0;e<a.length;e++)if($.inArray(a[e].facetItem.Id,b)>=0){var f=!1;for(var g=0;g<a[e].facetItem.Facets.length;g++)if(a[e].facetItem.Facets[g].Name==c&&a[e].facetItem.Facets[g].FacetValues.length>0){var h=a[e].facetItem.Facets[g].FacetValues[0].Value,i=!1;for(var j=0;j<d.length;j++)d[j].startRange==h&&(d[j].Ids.push(a[e].facetItem.Id),i=!0);i||d.push({startRange:h,endRange:h,Ids:[a[e].facetItem.Id]}),f=!0}if(!f){var h="(no info)",i=!1;for(var j=0;j<d.length;j++)d[j].startRange==h&&(d[j].Ids.push(a[e].facetItem.Id),i=!0);i||d.push({startRange:h,endRange:h,Ids:[a[e].facetItem.Id]})}}var k=0;while(d.length>8)if(k<d.length-1){d[k].endRange=d[k+1].endRange;for(var e=0;e<d[k+1].Ids.length;e++)d[k].Ids.push(d[k+1].Ids[e]);d.splice(k+1,1),k++}else k=0;return d}}),PivotViewer.Views.DeepZoomController=function(){var a=[],b=!1,c=!1,d=new Easing.Easer({type:"circular",side:"both"}),e,f=!1,g,h=[],i="";return InitDZController=function(b,c,d){e=new PivotViewer.Views.DeepZoomImageController;for(var f=0;f<b.length;f++){var h=new PivotViewer.Views.DeepZoomTile(e);h.facetItem=b[f],h.CollectionRoot=c.replace(/\\/gi,"/").replace(/\.xml/gi,""),g=d,h.context=g,a.push(h)}return e.Init(c.replace("\\","/")),a},AnimateTiles=function(){b=!0;if(a.length>0&&a[0].context!=null){var e=a[0].context;e.clearRect(0,0,e.canvas.width,e.canvas.height);var j=!1;for(var k=0;k<a.length;k++){var l=Now()-a[k].start,m=a[k].end-a[k].start;if(l<=m){if(a[k].x!=a[k].destinationx||a[k].y!=a[k].destinationy)j=!0;a[k].x=d.ease(l,a[k].startx,a[k].destinationx-a[k].startx,m),a[k].y=d.ease(l,a[k].starty,a[k].destinationy-a[k].starty,m);if(a[k].width!=a[k].destinationWidth||a[k].height!=a[k].destinationHeight)j=!0;a[k].width=d.ease(l,a[k].startwidth,a[k].destinationwidth-a[k].startwidth,m),a[k].height=d.ease(l,a[k].startheight,a[k].destinationheight-a[k].startheight,m)}else a[k].x=a[k].destinationx,a[k].y=a[k].destinationy,a[k].width=a[k].destinationwidth,a[k].height=a[k].destinationheight;a[k].destinationx+a[k].destinationwidth<0||a[k].destinationx>e.canvas.width||a[k].destinationy+a[k].destinationheight<0||a[k].destinationy>e.canvas.height?a[k].destinationVisible=!1:a[k].destinationVisible=!0}}f!=j&&(f=j,$.publish("/PivotViewer/DeepZoom/Zoom",[f]));for(var k=0;k<a.length;k++)a[k].x+a[k].width>0&&a[k].x<e.canvas.width&&a[k].y+a[k].height>0&&a[k].y<e.canvas.height&&a[k].Draw();if(debug){if(h.length>0)for(var k=0;k<h.length;k++)g.beginPath(),g.moveTo(h[k].x,h[k].y),g.arc(h[k].x+1,h[k].y+1,10,0,Math.PI*2,!0),g.fillStyle="#FF0000",g.fill(),g.beginPath(),g.rect(h[k].x+25,h[k].y-40,50,13),g.fillStyle="white",g.fill(),g.fillStyle="black",g.fillText(h[k].x+", "+h[k].y,h[k].x+30,h[k].y-30);i.length>0&&(g.beginPath(),g.rect(220,5,500,14),g.fillStyle="white",g.fill(),g.fillStyle="black",g.fillText(i,225,14))}if(!!c){b=!1;return}requestAnimFrame(function(){AnimateTiles()})},Now=function(){return Date.now?Date.now():(new Date).getTime()},{Init:InitDZController,BeginAnimation:function(){!b&&a.length>0&&(c=!1,AnimateTiles())},StopAnimation:function(){c=!0},SetLinearEasingBoth:function(){d=new Easing.Easer({type:"linear",side:"both"})},SetCircularEasingBoth:function(){d=new Easing.Easer({type:"circular",side:"both"})},SetQuarticEasingOut:function(){d=new Easing.Easer({type:"quartic",side:"out"})},GetTileRaio:function(){return e.Height()/e.Width()},DrawHelpers:function(a){h=a},DrawHelperText:function(a){i=a}}},PivotViewer.Views.DeepZoomTile=Object.subClass({init:function(a){if(!(this instanceof PivotViewer.Views.DeepZoomTile))return new PivotViewer.Views.DeepZoomTile(a);this._controller=a,this._image=new Image,this._imageLoaded=!1,this._selected=!1,this._controller=a,this._level=0,this._images=null,this._image.onload=function(){this._imageLoaded=!0}},Draw:function(){if(this.destinationVisible){var a=this.width>this.height?this.width:this.height,b=Math.ceil(Math.log(a)/Math.log(2));if(b==Infinity||b==-Infinity)b=0;this._level=b,this._images=this._controller.GetImagesAtLevel(this.facetItem.Img,this._level)}if(this._images!=null)for(var c=0;c<this._images.length;c++)this.context.drawImage(this._images[c],this.x+2,this.y+2,this.width-4,this.height-4);else this.context.beginPath(),this.context.rect(this.x+2,this.y+2,this.width-4,this.height-4),this.context.lineWidth=1,this.context.strokeStyle="black",this.context.stroke();this._selected&&(this.context.beginPath(),this.context.rect(this.x+2,this.y+2,this.width-4,this.height-4),this.context.lineWidth=4,this.context.strokeStyle="#92C4E1",this.context.stroke())},Contains:function(a,b){return this.x<=a&&this.x+this.width>=a&&this.y<=b&&this.y+this.height>=b},CollectionRoot:"",now:null,end:null,x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0,width:0,height:0,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,facetItem:null,Selected:function(a){this._selected=a}}),PivotViewer.Views.DeepZoomImageController=function(){var a=[],b=[],c="",d="",e=0,f=256,g=0,h=0,i="jpg",j=0,k=!1;return initDZ=function(b){c=b.substring(0,b.lastIndexOf("/")),d=b.substring(b.lastIndexOf("/")+1).replace(".xml","_files"),$.ajax({type:"GET",url:b,dataType:"xml",success:function(b){var d=$(b).find("I");if(d.length==0)return;var k=$(d[0]).attr("Source");$.ajax({type:"GET",url:c+"/"+k,dataType:"xml",success:function(b){var c=$(b).find("Image");if(c.length==0)return;var k=$(c[0]);f=k.attr("TileSize"),i=k.attr("Format"),e=k.attr("MaxLevel");var l=k.children().first();g=parseInt(l.attr("Width")),h=parseInt(l.attr("Height"));var m=g>h?g:h;j=Math.ceil(Math.log(m)/Math.log(2));for(var n=0;n<d.length;n++){var o=$(d[n]).attr("Source"),p=$(d[n]).attr("Id"),q=$(d[n]).attr("N"),r=o.substring(o.lastIndexOf("/")+1).replace(/\.xml/gi,""),s=o.substring(0,o.lastIndexOf("/"));a.push(new PivotViewer.Views.DeepZoomItem(p,r,q,s))}$.publish("/PivotViewer/DeepZoom/Collection/Loaded",null)}})}})},getImageLevel=function(b,d){d=d>7?7:d,d=d<=0?6:d;for(var e=0;e<a.length;e++)if(a[e].ItemId==b){var f=a[e].DZN.toString(2),g="",h="";for(var i=0;i<f.length;i++)i%2==0?g+=f[i]:h+=f[i];dzCol=parseInt(g,2),dzRow=parseInt(h,2);if(a[e].Levels!=undefined&&a[e].Levels.length!=0||!!k){if(a[e].Levels.length<d&&!k){var j=getImageList(c+"/"+a[e].BasePath+"/"+a[e].DZId+"_files/"+d+"/",d),l=new PivotViewer.Views.DeepZoomLevel;l.LoadImages(j),a[e].Levels.splice(d,0,l)}for(var m=d;m>-1;m--){if(a[e].Levels[m]!=undefined&&a[e].Levels[m].IsLoaded())return a[e].Levels[m].GetImages();if(m==d&&a[e].Levels[m]==undefined&&!k){var j=getImageList(c+"/"+a[e].BasePath+"/"+a[e].DZId+"_files/"+m+"/",m),l=new PivotViewer.Views.DeepZoomLevel;l.LoadImages(j),a[e].Levels.splice(m,0,l)}}return null}var j=getImageList(c+"/"+a[e].BasePath+"/"+a[e].DZId+"_files/6/",6),l=new PivotViewer.Views.DeepZoomLevel;return l.LoadImages(j),a[e].Levels.push(l),null}return null},getImageList=function(a,b){var c=[],d=Math.ceil(g/Math.pow(2,j-b)),e=Math.ceil(h/Math.pow(2,j-b)),k=Math.ceil(d/f),l=Math.ceil(e/f);for(var m=0;m<k;m++)for(var n=0;n<l;n++)c.push(a+m+"_"+n+"."+i);return c},$.subscribe("/PivotViewer/DeepZoom/Zoom",function(a){k=a}),{Init:initDZ,GetImagesAtLevel:getImageLevel,Width:function(){return g},Height:function(){return h}}},PivotViewer.Views.DeepZoomItem=function(a,b,c,d){var e=a,f=b,g=parseInt(c),h=d,i=[];return{ItemId:e,DZId:f,DZN:g,BasePath:h,Levels:i}},PivotViewer.Views.DeepZoomLevel=function(){var a=[],b=!1;return loadImages=function(c){for(var d=0;d<c.length;d++){var e=new Image;e.src=c[d],e.onload=function(){b=!0},a.push(e)}},isLoaded=function(){if(!b){var c=0;for(var d=0;d<a.length;d++)a[d].complete&&c++;c==a.length&&(b=!0)}return b},{LoadImages:loadImages,IsLoaded:function(){return b},GetImages:function(){return a}}},function(a){var b=[],c=[],d=0,e,f,g=[],h=null,i=null,j={CXML:"",PivotCollection:new PivotViewer.Models.Collection,_self:null},k={init:function(a){j._self=this,j._self.addClass("pv-wrapper"),InitPreloader();if(a.Loader==undefined)throw"Collection loader is undefined.";if(!(a.Loader instanceof PivotViewer.Models.Loaders.ICollectionLoader))throw"Collection loader does not inherit from PivotViewer.Models.Loaders.ICollectionLoader.";a.Loader.LoadCollection(j.PivotCollection)},show:function(){Debug.Log("Show")},hide:function(){Debug.Log("Hide")}};InitPreloader=function(){j._self.append("<div class='pv-loading'><img src='Content/images/loading.gif' alt='Loading' /><span>Loading...</span></div>"),a(".pv-loading").css("top",a(".pv-wrapper").height()/2-33+"px"),a(".pv-loading").css("left",a(".pv-wrapper").width()/2-43+"px")},InitDeepZoom=function(){InitUI();var b=j.PivotCollection.CXMLBase.substring(0,j.PivotCollection.CXMLBase.lastIndexOf("/")+1)+j.PivotCollection.ImageBase,c=a(".pv-viewarea-canvas")[0].getContext("2d");f=new PivotViewer.Views.DeepZoomController,g=f.Init(j.PivotCollection.Items,b,c),f.BeginAnimation()},InitPivotViewer=function(){CreateFacetList(),CreateViews(),AttachEventHandlers(),a(".pv-loading").remove(),SelectView(0)},InitUI=function(){var b="<div class='pv-toolbarpanel'>",c=j.PivotCollection.BrandImage;c.length>0&&(b+="<img class='pv-toolbarpanel-brandimage' src='"+c+"'></img>"),b+="<span class='pv-toolbarpanel-name'>"+j.PivotCollection.CollectionName+"</span>",b+="<div class='pv-toolbarpanel-zoomcontrols'><div class='pv-toolbarpanel-zoomslider'></div></div>",b+="<div class='pv-toolbarpanel-viewcontrols'></div>",b+="<div class='pv-toolbarpanel-sortcontrols'></div>",b+="</div>",j._self.append(b),j._self.append("<div class='pv-mainpanel'></div>");var d=a(".pv-wrapper").height()-a(".pv-toolbarpanel").height()-6;a(".pv-mainpanel").css("height",d+"px"),a(".pv-mainpanel").append("<div class='pv-filterpanel'></div>"),a(".pv-mainpanel").append("<div class='pv-viewpanel'><canvas class='pv-viewarea-canvas' width='"+j._self.width()+"' height='"+d+"px'></canvas></div>"),a(".pv-mainpanel").append("<div class='pv-infopanel'></div>"),a(".pv-filterpanel").append("<div class='pv-filterpanel-clearall'>Clear All</div>"),a(".pv-filterpanel").append("<input class='pv-filterpanel-search' type='text' placeholder='Search...' />"),a(".pv-filterpanel").css("height",d-13+"px"),a(".pv-filterpanel-search").css("width",a(".pv-filterpanel").width()-12+"px"),a(".pv-infopanel").css("left",a(".pv-mainpanel").offset().left+a(".pv-mainpanel").width()-205+"px"),a(".pv-infopanel").css("height",d-28+"px"),a(".pv-infopanel").append("<div class='pv-infopanel-controls'></div>"),a(".pv-infopanel-controls").append("<div><div class='pv-infopanel-controls-navleft'></div><div class='pv-infopanel-controls-navbar'></div><div class='pv-infopanel-controls-navright'></div></div>"),a(".pv-infopanel").append("<div class='pv-infopanel-heading'></div>"),a(".pv-infopanel").append("<div class='pv-infopanel-details'></div>"),a(".pv-infopanel").hide()},CreateFacetList=function(){for(var b=0;b<j.PivotCollection.Items.length;b++)for(var d=0;d<j.PivotCollection.FacetCategories.length;d++)if(j.PivotCollection.FacetCategories[d].IsFilterVisible){var e=!1;for(var f=0;f<j.PivotCollection.Items[b].Facets.length;f++)if(j.PivotCollection.Items[b].Facets[f].Name==j.PivotCollection.FacetCategories[d].Name){for(var g=0;g<j.PivotCollection.Items[b].Facets[f].FacetValues.length;g++){var h=!1,i=PivotViewer.Utils.EscapeItemId("pv-facet-item-"+j.PivotCollection.Items[b].Facets[f].Name+"__"+j.PivotCollection.Items[b].Facets[f].FacetValues[g].Value);for(var k=c.length-1;k>-1;k-=1)if(c[k].itemId==i){c[k].count+=1,h=!0;break}h||c.push({itemId:i,itemValue:j.PivotCollection.Items[b].Facets[f].FacetValues[g].Value,facet:j.PivotCollection.Items[b].Facets[f].Name,count:1})}e=!0}if(!e){var h=!1,i=PivotViewer.Utils.EscapeItemId("pv-facet-item-"+j.PivotCollection.FacetCategories[d].Name+"__(no info)");for(var k=c.length-1;k>-1;k-=1)if(c[k].itemId==i){c[k].count+=1,h=!0;break}h||c.push({itemId:i,itemValue:"(no info)",facet:j.PivotCollection.FacetCategories[d].Name,count:1})}}var l=["<div class='pv-filterpanel-accordion'>"],m=[];for(var b=0;b<j.PivotCollection.FacetCategories.length;b++)j.PivotCollection.FacetCategories[b].IsFilterVisible&&(l[b+1]="<h3><a href='#'>",l[b+1]+=j.PivotCollection.FacetCategories[b].Name,l[b+1]+="</a><div class='pv-filterpanel-accordion-heading-clear'>&nbsp;</div></h3>",l[b+1]+="<div id='pv-cat-"+PivotViewer.Utils.EscapeItemId(j.PivotCollection.FacetCategories[b].Name)+"'>",j.PivotCollection.FacetCategories[b].CustomSort!=undefined||j.PivotCollection.FacetCategories[b].CustomSort!=null?l[b+1]+="<span class='pv-filterpanel-accordion-facet-sort' customSort='"+j.PivotCollection.FacetCategories[b].CustomSort.Name+"'>Sort: "+j.PivotCollection.FacetCategories[b].CustomSort.Name+"</span>":l[b+1]+="<span class='pv-filterpanel-accordion-facet-sort'>Sort: A-Z</span>",l[b+1]+=CreateFacet(j.PivotCollection.FacetCategories[b].Name),l[b+1]+="</div>",m[b]="<option value='"+PivotViewer.Utils.EscapeItemId(j.PivotCollection.FacetCategories[b].Name)+"' label='"+j.PivotCollection.FacetCategories[b].Name+"'>"+j.PivotCollection.FacetCategories[b].Name+"</option>");l[l.length]="</div>",a(".pv-filterpanel").append(l.join(""));for(var b=0;b<j.PivotCollection.FacetCategories.length;b++)j.PivotCollection.FacetCategories[b].IsFilterVisible&&SortFacetItems(j.PivotCollection.FacetCategories[b].Name);a(".pv-filterpanel-accordion").css("height",a(".pv-filterpanel").height()-a(".pv-filterpanel-search").height()-40+"px"),a(".pv-filterpanel-accordion").accordion({fillSpace:!0}),a(".pv-toolbarpanel-sortcontrols").append('<select class="pv-toolbarpanel-sort">'+m.join("")+"</select>")},CreateFacet=function(a){var b=["<ul class='pv-filterpanel-accordion-facet-list'>"];for(var d=0;d<c.length;d++)c[d].facet==a&&(b[d+1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+c[d].itemId+"'>",b[d+1]+="<input itemvalue='"+c[d].itemValue.replace(/\s+/gi,"|")+"' itemfacet='"+a.replace(/\s+/gi,"|")+"' class='pv-facet-facetitem' type='checkbox' />",b[d+1]+="<span class='pv-facet-facetitem-label' title='"+c[d].itemValue+"'>"+c[d].itemValue+"</span>"
,b[d+1]+="<span class='pv-facet-facetitem-count'>0</span>",b[d+1]+="</li>");return b[b.length]="</ul>",b.join("")},CreateViews=function(){var c=a(".pv-viewpanel"),d=j._self.width(),e=a(".pv-mainpanel").height(),g=a(".pv-filterpanel").width()+18,h=4;b.push(new PivotViewer.Views.GridView),b.push(new PivotViewer.Views.GraphView);for(var i=0;i<b.length;i++)try{b[i]instanceof PivotViewer.Views.IPivotViewerView?(b[i].Setup(d,e,g,h,f.GetTileRaio()),c.append("<div class='pv-viewpanel-view' id='pv-viewpanel-view-"+i+"'>"+b[i].GetUI()+"</div>"),a(".pv-toolbarpanel-viewcontrols").append("<div class='pv-toolbarpanel-view' id='pv-toolbarpanel-view-"+i+"' title='"+b[i].GetViewName()+"'><img id='pv-viewpanel-view-"+i+"-image' src='"+b[i].GetButtonImage()+"' alt='"+b[i].GetViewName()+"' /></div>")):alert("View does not inherit from PivotViewer.Views.IPivotViewerView")}catch(k){alert(k.Message)}},SelectView=function(c){for(var e=0;e<b.length;e++)c!=e&&(a("#pv-viewpanel-view-"+e+"-image").attr("src",b[e].GetButtonImage()),b[e].Deactivate());a("#pv-viewpanel-view-"+c+"-image").attr("src",b[c].GetButtonImageSelected()),b[c].Activate(),d=c,FilterCollection()},SortFacetItems=function(b){var c=a("#pv-cat-"+PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId(b))+" ul"),d=c.prev().text().replace("Sort: ",""),e=c.children("li").get();if(d=="A-Z")e.sort(function(b,c){var d=a(b).children().first().attr("itemvalue"),e=a(c).children().first().attr("itemvalue");return d<e?1:d>e?-1:0});else if(d=="Quantity")e.sort(function(b,c){var d=parseInt(a(b).children(".pv-facet-facetitem-count").text()),e=parseInt(a(c).children(".pv-facet-facetitem-count").text());return d<e?-1:d>e?1:0});else{var f=j.PivotCollection.GetFacetCategoryByName(b);if(f.CustomSort!=undefined){var g=[];for(var h=f.CustomSort.SortValues.length-1;h>-1;h-=1)for(var i=0;i<e.length;i++)f.CustomSort.SortValues[h]==a(e[i]).children(".pv-facet-facetitem-label").text()&&(g.push(e[i]),found=!0);e=g}}for(var h=0;h<e.length;h++)c.prepend(e[h])},FilterCollection=function(){var c=a(".pv-facet-facetitem:checked"),e=[],h=[],i=[],k=a(".pv-toolbarpanel-sort option:selected").text();if(c.length==0){for(l in j.PivotCollection.Items)e.push(j.PivotCollection.Items[l].Id);a(".pv-filterpanel-clearall").css("visibility","hidden"),a(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden")}else{for(var l=0;l<c.length;l++){var m=a(c[l]).attr("itemfacet").replace(/\|/gi," "),n=a(c[l]).attr("itemvalue").replace(/\|/gi," "),o=GetItemIds(m,n);for(var p=0;p<o.length;p++){var q=!1;for(var r=0;r<h.length;r++)o[p]==h[r].Id&&(h[r].count++,q=!0);q||h.push({Id:o[p],count:1})}a.inArray(m,i)<0&&i.push(m)}for(var l=0;l<h.length;l++)h[l].count==i.length&&e.push(h[l].Id);a(".pv-filterpanel-clearall").css("visibility","visible")}a(".pv-viewpanel-view").hide(),a("#pv-viewpanel-view-"+d).show(),FilterFacets(e,i),f.SetCircularEasingBoth(),b[d].Filter(g,e,k),a.publish("/PivotViewer/Views/Item/Deselected",null),DeselectInfoPanel()},FilterFacets=function(b,d){if(b.length==j.PivotCollection.Items.length){for(var e=c.length-1;e>-1;e-=1){var f=a("#"+PivotViewer.Utils.EscapeMetaChars(c[e].itemId));f.show(),f.find("span").last().text(c[e].count)}return}var g=[];for(var e=b.length-1;e>-1;e-=1){var f=j.PivotCollection.GetItemById(b[e]);for(var h=0;h<j.PivotCollection.FacetCategories.length;h++)if(j.PivotCollection.FacetCategories[h].IsFilterVisible){var i=!1;for(var k=f.Facets.length-1;k>-1;k-=1)if(f.Facets[k].Name==j.PivotCollection.FacetCategories[h].Name){if(a.inArray(f.Facets[k].Name,d)<0&&j.PivotCollection.GetFacetCategoryByName(f.Facets[k].Name).IsFilterVisible)for(var l=f.Facets[k].FacetValues.length-1;l>-1;l-=1){var m={item:"#"+PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId("pv-facet-item-"+f.Facets[k].Name+"__"+f.Facets[k].FacetValues[l].Value)),count:1},n=!1;for(var o=g.length-1;o>-1;o-=1)if(g[o].item==m.item){g[o].count+=1,n=!0;break}n||g.push(m)}i=!0}if(!i){var m={item:"#"+PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId("pv-facet-item-"+j.PivotCollection.FacetCategories[h].Name+"__(no info)")),count:1},n=!1;for(var o=g.length-1;o>-1;o-=1)if(g[o].item==m.item){g[o].count+=1,n=!0;break}n||g.push(m)}}}for(var e=c.length-1;e>-1;e-=1)if(a.inArray(c[e].facet,d)<0){var n=!1;for(var k=g.length-1;k>-1;k-=1)if(g[k].item==c[e].itemId){n=!0;break}n||a("#"+PivotViewer.Utils.EscapeMetaChars(c[e].itemId)).hide()}for(var e=g.length-1;e>-1;e-=1){var p=a(g[e].item);if(p.length>0){p.show();var q=p.find("span").last();q.text(g[e].count)}}},DeselectInfoPanel=function(){a(".pv-infopanel").fadeOut(),a(".pv-infopanel-heading").text(""),a(".pv-infopanel-details").empty()},GetItemIds=function(a,b){var c=[];for(var d=0;d<j.PivotCollection.Items.length;d++){var e=!1;for(var f=0;f<j.PivotCollection.Items[d].Facets.length;f++)if(j.PivotCollection.Items[d].Facets[f].Name==a){for(var g=0;g<j.PivotCollection.Items[d].Facets[f].FacetValues.length;g++)b==j.PivotCollection.Items[d].Facets[f].FacetValues[g].Value&&c.push(j.PivotCollection.Items[d].Id);e=!0}!e&&b=="(no info)"&&c.push(j.PivotCollection.Items[d].Id)}return c},GetItem=function(a){for(var b=0;b<j.PivotCollection.Items.length;b++)if(j.PivotCollection.Items[b].Id==a)return j.PivotCollection.Items[b];return null},a.subscribe("/PivotViewer/Models/Collection/Loaded",function(a){InitDeepZoom()}),a.subscribe("/PivotViewer/DeepZoom/Collection/Loaded",function(a){InitPivotViewer()}),a.subscribe("/PivotViewer/Views/Item/Selected",function(b){if(b==undefined||b==null)return;if(b.length>0){var c=GetItem(b);if(c!=null){var d=!0;a(".pv-infopanel-heading").text(c.Name);var e=a(".pv-infopanel-details");e.empty(),c.Description!=undefined&&c.Description.length>0&&e.append("<div class='pv-infopanel-detail-description' style='height:100px;'>"+c.Description+"</div><div class='pv-infopanel-detail-description-more'>More</div>");var f=[],g=0;for(var h=0;h<c.Facets.length;h++){var i=!1,k=!1;for(var l=0;l<j.PivotCollection.FacetCategories.length;l++)if(j.PivotCollection.FacetCategories[l].Name==c.Facets[h].Name&&j.PivotCollection.FacetCategories[l].IsMetaDataVisible){i=!0,k=j.PivotCollection.FacetCategories[l].IsFilterVisible;break}if(i){f[g]="<div class='pv-infopanel-detail "+(d?"detail-dark":"detail-light")+"'><div class='pv-infopanel-detail-item detail-item-title'>"+c.Facets[h].Name+"</div>";for(var l=0;l<c.Facets[h].FacetValues.length;l++)f[g]+="<div class='pv-infopanel-detail-item detail-item-value"+(k?" detail-item-value-filter":"")+"'>",c.Facets[h].FacetValues[l].Href!=null?f[g]+="<a class='detail-item-link' href='"+c.Facets[h].FacetValues[l].Href+"'>"+c.Facets[h].FacetValues[l].Value+"</a>":f[g]+=c.Facets[h].FacetValues[l].Value,f[g]+="</div>";f[g]+="</div>",g++,d=!d}}e.append(f.join("")),a(".pv-infopanel").fadeIn(),e.css("height",a(".pv-infopanel").height()-(a(".pv-infopanel-controls").height()+a(".pv-infopanel-heading").height())-20+"px");return}}DeselectInfoPanel()}),a.subscribe("/PivotViewer/Views/Item/Filtered",function(b){if(b==undefined||b==null)return;var c=a(PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId("#pv-facet-item-"+b.Facet+"__"+b.Item))+" input");c.attr("checked","checked"),FacetItemClick(c[0])}),AttachEventHandlers=function(){a(".pv-toolbarpanel-view").on("click",function(a){var b=this.id.substring(this.id.lastIndexOf("-")+1,this.id.length);b!=null&&SelectView(parseInt(b))}),a(".pv-toolbarpanel-sort").on("change",function(a){FilterCollection()}),a(".pv-filterpanel-accordion-facet-sort").on("click",function(b){var c=a(this),d=c.text(),e=c.parent().prev().children("a").text(),f=c.attr("customSort");d=="Sort: A-Z"?a(this).text("Sort: Quantity"):d=="Sort: Quantity"&&f==undefined?a(this).text("Sort: A-Z"):d=="Sort: Quantity"?a(this).text("Sort: "+f):a(this).text("Sort: A-Z"),SortFacetItems(e)}),a(".pv-facet-facetitem").on("click",function(a){FacetItemClick(this)}),a(".pv-facet-facetitem-label").on("click",function(b){var c=a(this).prev(),d=a(this.parentElement.parentElement).find(":checked");c.attr("checked")=="checked"&&d.length<=1?c.removeAttr("checked"):c.attr("checked","checked");for(var e=d.length-1;e>-1;e-=1)d[e].getAttribute("itemvalue")!=c[0].getAttribute("itemvalue")&&(d[e].checked=!1);FacetItemClick(c[0])}),a(".pv-filterpanel-clearall").on("click",function(b){var c=a(".pv-facet-facetitem:checked");for(var d=0;d<c.length;d++)a(c[d]).removeAttr("checked");FilterCollection()}),a(".pv-filterpanel-accordion-heading-clear").on("click",function(b){var c=a(this.parentElement).next().find(".pv-facet-facetitem:checked");for(var d=0;d<c.length;d++)a(c[d]).removeAttr("checked");FilterCollection(),a(this).css("visibility","hidden")}),a(".pv-infopanel-details").on("click",".detail-item-value-filter",function(b){a.publish("/PivotViewer/Views/Item/Filtered",[{Facet:a(this).parent().children().first().text(),Item:a(this).text()}])}),a(".pv-infopanel-details").on("click",".pv-infopanel-detail-description-more",function(b){var c=a(this),d=a(this).prev();c.text()=="More"?(d.css("height",""),a(this).text("Less")):(d.css("height","100px"),a(this).text("More"))});var b=a(".pv-viewarea-canvas");b.on("mouseup",function(b){var c=a(this).offset(),d=b.clientX-c.left,e=b.clientY-c.top;(!i||i.x==0&&i.y==0)&&a.publish("/PivotViewer/Views/Canvas/Click",[{x:d,y:e}]),h=null,i=!1}),b.on("mouseout",function(a){h=null,i=!1}),b.on("mousedown",function(b){var c=a(this).offset(),d=b.clientX-c.left,e=b.clientY-c.top;h={x:d,y:e}}),b.on("mousemove",function(b){var c=a(this).offset(),d=b.clientX-c.left,e=b.clientY-c.top;h==null?a.publish("/PivotViewer/Views/Canvas/Hover",[{x:d,y:e}]):(i={x:d-h.x,y:e-h.y},h={x:d,y:e},a.publish("/PivotViewer/Views/Canvas/Drag",[i]))}),b.on("mousewheel",function(b,c){var d=a(this).offset(),e=b.clientX-d.left,g=b.clientY-d.top;f.SetQuarticEasingOut(),f.DrawHelpers([{x:e,y:g}]),a.publish("/PivotViewer/Views/Canvas/Zoom",[{x:e,y:g,delta:c}])}),b.on("touchstart",function(b){var c=b.originalEvent,d=a(this).offset(),e=c.touches[0].pageX-d.left,f=c.touches[0].pageY-d.top;h={x:e,y:f}}),b.on("touchmove",function(b){try{var c=b.originalEvent;b.preventDefault();if(c.touches.length>1){b.preventDefault();var d=1e7,e=1e7,g=0,j=0,k=[];for(var l=0;l<c.touches.length;l++)k.push({x:c.touches[l].pageX,y:c.touches[l].pageY}),c.touches[l].pageX<d&&(d=c.touches[l].pageX),c.touches[l].pageX>g&&(g=c.touches[l].pageX),c.touches[l].pageY<e&&(e=c.touches[l].pageY),c.touches[l].pageY>j&&(j=c.touches[l].pageY);var m=(d+g)/2,n=(e+j)/2;f.SetLinearEasingBoth(),k.push({x:m,y:n}),f.DrawHelpers(k),f.DrawHelperText("Scale: "+c.scale),a.publish("/PivotViewer/Views/Canvas/Zoom",[{x:m,y:n,scale:c.scale}]);return}var o=a(this).offset(),p=c.touches[0].pageX-o.left,q=c.touches[0].pageY-o.top;i={x:p-h.x,y:q-h.y},h={x:p,y:q},a.publish("/PivotViewer/Views/Canvas/Drag",[i])}catch(r){Debug.Log(r.message)}}),b.on("touchend",function(b){var c=b.originalEvent;if(c.touches.length==1&&h==null){var d=a(this).offset(),e=c.touches[0].pageX-d.left,f=c.touches[0].pageY-d.top;(!i||i.x==0&&i.y==0)&&a.publish("/PivotViewer/Views/Canvas/Click",[{x:e,y:f}])}h=null,i=!1;return})},FacetItemClick=function(b){a(b).attr("checked")=="checked"&&a(b.parentElement.parentElement.parentElement).prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"),FilterCollection()},a.fn.PivotViewer=function(b){if(k[b])return k[b].apply(this,Array.prototype.slice.call(arguments,1));if(typeof b=="object"||!b)return k.init.apply(this,arguments);a.error("Method "+b+" does not exist on jQuery.PivotViewer")}}(jQuery);