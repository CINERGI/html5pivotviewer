//
//  HTML5 PivotViewer
//
//  Collection loader interface - used so that different types of data sources can be used
//
//  Original Code:
//    Copyright (C) 2011 LobsterPot Solutions - http://www.lobsterpot.com.au/
//    enquiries@lobsterpot.com.au
//
//  Enhancements:
//    Copyright (C) 2012-2013 OpenLink Software - http://www.openlinksw.com/
//
//  This software is licensed under the terms of the
//  GNU General Public License v2 (see COPYING)
//
///PivotViewer
var PivotViewer=PivotViewer||{};PivotViewer.Version="v0.9.76-579b1c4",PivotViewer.Models={},PivotViewer.Models.Loaders={},PivotViewer.Utils={},PivotViewer.Views={};var Debug=Debug||{};(function(e){var t={};e.publish=function(n,r){t[n]&&e.each(t[n],function(){this.apply(e,r||[])})},e.subscribe=function(e,n){return t[e]||(t[e]=[]),t[e].push(n),[e,n]},e.unsubscribe=function(n){var r=n[0];t[r]&&e.each(t[r],function(e){this==n[1]&&t[r].splice(e,1)})}})(jQuery),Debug.Log=function(e){window.console&&window.console.log&&typeof debug!="undefined"&&debug==1&&window.console.log(e)},window.requestAnimFrame=function(e){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),PivotViewer.Utils.EscapeMetaChars=function(e){return e.replace(/\|/gi,"\\|").replace(/\//gi,"\\/").replace(/'/gi,"\\'").replace(/,/gi,"\\,").replace(/:/gi,"\\:").replace(/\(/gi,"\\(").replace(/\)/gi,"\\)").replace(/\+/gi,"\\+").replace(/\+/gi,"\\-").replace(/\+/gi,"\\_").replace(/\+/gi,"\\%")},PivotViewer.Utils.EscapeItemId=function(e){return e.replace(/\s+/gi,"|").replace(/'/gi,"").replace(/\(/gi,"").replace(/\)/gi,"").replace(/\./gi,"")},PivotViewer.Utils.Now=function(){return Date.now?Date.now():(new Date).getTime()},PivotViewer.Utils.Min=function(e){var t=1e6;for(var n=0,r=e.length;n<r;n++)t=t>e[n]?e[n]:t;return t},PivotViewer.Utils.Max=function(e){var t=-1e6;for(var n=0,r=e.length;n<r;n++)t=t<e[n]?e[n]:t;return t},PivotViewer.Utils.Histogram=function(e){if(!e instanceof Array)return null;var t=PivotViewer.Utils.Min(e),n=PivotViewer.Utils.Max(e),r=(Math.floor(Math.pow(2*e.length,1/3))+1)*2;r>10&&(r=10);var i=(n+1-(t-1))/r,s=[];for(var o=0;o<r;o++){var u=t+o*i,a=t+(o+1)*i;s.push([]);for(var f=0,l=e.length;f<l;f++)u<=e[f]&&a>e[f]&&s[o].push(e[f])}return{Histogram:s,Min:t,Max:n,BinCount:r}},function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(n){function o(){!e&&this.init&&this.init.apply(this,arguments)}var r=this.prototype;e=!0;var i=new this;e=!1;for(var s in n)i[s]=typeof n[s]=="function"&&typeof r[s]=="function"&&t.test(n[s])?function(e,t){return function(){var n=this._super;this._super=r[e];var i=t.apply(this,arguments);return this._super=n,i}}(s,n[s]):n[s];return o.prototype=i,o.constructor=o,o.subClass=arguments.callee,o}}(),PivotViewer.Models.Collection=Object.subClass({init:function(){var e="http://schemas.microsoft.com/collection/metadata/2009",t="http://schemas.microsoft.com/livelabs/pivot/collection/2009";this.CollectionName="",this.BrandImage="",this.FacetCategories=[],this.Items=[],this.CXMLBase="",this.ImageBase="",this.CopyrightName="",this.CopyrightHref=""},GetItemById:function(e){for(var t=0;t<this.Items.length;t++)if(this.Items[t].Id==e)return this.Items[t];return null},GetFacetCategoryByName:function(e){for(var t=0;t<this.FacetCategories.length;t++)if(this.FacetCategories[t].Name==e)return this.FacetCategories[t];return null}}),PivotViewer.Models.FacetCategory=Object.subClass({init:function(e,t,n,r,i,s,o){this.Name=e,this.Format=t,this.Type=n!=null&&n!=undefined?n:PivotViewer.Models.FacetType.String,this.IsFilterVisible=r!=null&&r!=undefined?r:!0,this.IsMetaDataVisible=i!=null&&i!=undefined?i:!0,this.IsWordWheelVisible=s!=null&&s!=undefined?s:!0,this.CustomSort}}),PivotViewer.Models.FacetCategorySort=Object.subClass({init:function(e){this.Name=e,this.SortValues=[]}}),PivotViewer.Models.Item=Object.subClass({init:function(e,t,n,r){this.Img=parseInt(e),this.Id=t,this.Href=n,this.Name=r,this.Description,this.Facets=[]}}),PivotViewer.Models.Facet=Object.subClass({init:function(e){this.Name=e,this.FacetValues=[]},AddFacetValue:function(e){this.FacetValues.push(e)}}),PivotViewer.Models.FacetValue=Object.subClass({init:function(e){this.Value=e,this.Href=""}}),PivotViewer.Models.FacetType={String:"String",LongString:"LongString",Number:"Number",DateTime:"DateTime",Link:"Link"},PivotViewer.Models.Loaders.ICollectionLoader=Object.subClass({init:function(){},LoadCollection:function(e){if(!e instanceof PivotViewer.Models.Collection)throw"collection not an instance of PivotViewer.Models.Collection."}}),PivotViewer.Models.Loaders.CXMLLoader=PivotViewer.Models.Loaders.ICollectionLoader.subClass({init:function(e,t){this.CXMLUriNoProxy=e,t?this.CXMLUri=t+e:this.CXMLUri=e},LoadCollection:function(e){var e=e;this._super(e),e.CXMLBaseNoProxy=this.CXMLUriNoProxy,e.CXMLBase=this.CXMLUri,$.ajax({type:"GET",url:this.CXMLUri,dataType:"xml",success:function(t){Debug.Log("CXML loaded");var n=$(t).find("Collection")[0],r="P";if(n==undefined){$(".pv-loading").remove();var i="";i+="Error parsing CXML Collection<br>",i+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-parse-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+i+"</p></div></div>");var s=setTimeout(function(){window.open("#pv-parse-error","_self")},1e3);throw"Error parsing CXML Collection"}for(var o=0;o<n.attributes.length;o++)if(n.attributes[o].value=="http://schemas.microsoft.com/livelabs/pivot/collection/2009"){r=n.attributes[o].localName!=undefined?n.attributes[o].localName:n.attributes[o].baseName;break}e.CollectionName=$(n).attr("Name"),e.BrandImage=$(n).attr(r+":BrandImage")!=undefined?$(n).attr(r+":BrandImage"):"";var u=$(t).find("FacetCategory");for(var o=0;o<u.length;o++){var a=$(u[o]),f=new PivotViewer.Models.FacetCategory(a.attr("Name"),a.attr("Format"),a.attr("Type"),a.attr(r+":IsFilterVisible")!=undefined?a.attr(r+":IsFilterVisible").toLowerCase()=="true"?!0:!1:!0,a.attr(r+":IsMetaDataVisible")!=undefined?a.attr(r+":IsMetaDataVisible").toLowerCase()=="true"?!0:!1:!0,a.attr(r+":IsWordWheelVisible")!=undefined?a.attr(r+":IsWordWheelVisible").toLowerCase()=="true"?!0:!1:!0),l=a.find(r+"\\:SortOrder"),c=l.find(r+"\\:SortValue");l.length==0&&(l=a.find("SortOrder"),c=l.find("SortValue"));if(l.length==1){var h=new PivotViewer.Models.FacetCategorySort(l.attr("Name"));for(var p=0;p<c.length;p++)h.SortValues.push($(c[p]).attr("Value"));f.CustomSort=h}e.FacetCategories.push(f)}var d=$(t).find("Items");if(d.length==1){e.ImageBase=$(d[0]).attr("ImgBase");var v=$(d[0]).find("Item");if(v.length==0){$(".pv-loading").remove();var i="";i+="There are no items in the CXML Collection<br><br>",$(".pv-wrapper").append('<div id="pv-empty-collection-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+i+"</p></div></div>");var s=setTimeout(function(){window.open("#pv-empty-collection-error","_self")},1e3)}else for(var o=0;o<v.length;o++){var m=new PivotViewer.Models.Item($(v[o]).attr("Img").replace("#",""),$(v[o]).attr("Id"),$(v[o]).attr("Href"),$(v[o]).attr("Name")),g=$(v[o]).find("Description");g.length==1&&g[0].childNodes.length&&(m.Description=g[0].childNodes[0].nodeValue);var y=$(v[o]).find("Facet");for(var p=0;p<y.length;p++){var b=new PivotViewer.Models.Facet($(y[p]).attr("Name")),w=$(y[p]).children();for(var E=0;E<w.length;E++)if(w[E].nodeType==1){var S=$.trim($(w[E]).attr("Value"));if(S==null||S==""){var x=new PivotViewer.Models.FacetValue($(w[E]).attr("Name"));x.Href=$(w[E]).attr("Href"),b.AddFacetValue(x)}else if(w[E].nodeName=="Number"){var x=new PivotViewer.Models.FacetValue(parseFloat(S));b.AddFacetValue(x)}else{var x=new PivotViewer.Models.FacetValue(S);b.AddFacetValue(x)}}m.Facets.push(b)}e.Items.push(m)}}var T=$(t).find("Extension");if(T.length==1){var N=$(T[0]).find("d1p1\\:Copyright, Copyright");N!=undefined&&(e.CopyrightName=$(N[0]).attr("Name"),e.CopyrightHref=$(N[0]).attr("Href"))}$.publish("/PivotViewer/Models/Collection/Loaded",null)},error:function(e,t,n){$(".pv-loading").remove();var r="";r+="Error loading CXML Collection<br><br>",r=r+"URL        : "+this.url+"<br>",r=r+"Status : "+e.status+" "+n+"<br>",r=r+"Details    : "+e.responseText+"<br>",r+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-loading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+r+"</p></div></div>");var i=setTimeout(function(){window.open("#pv-loading-error","_self")},1e3)}})}}),PivotViewer.Views.IPivotViewerView=Object.subClass({init:function(){this.isActive=!1,this.init=!0,this.selected="",this.tiles=[]},Setup:function(e,t,n,r,i){},Filter:function(e,t,n){},GetUI:function(){return""},GetButtonImage:function(){return""},GetButtonImageSelected:function(){return""},GetViewName:function(){return""},Activate:function(){this.isActive=!0},Deactivate:function(){this.isActive=!1}}),PivotViewer.Views.TileBasedView=PivotViewer.Views.IPivotViewerView.subClass({OffsetTiles:function(e,t){for(var n=0;n<this.tiles.length;n++){var r=$.inArray(this.tiles[n].facetItem.Id,this.currentFilter);r>=0&&(this.tiles[n]._locations[0].destinationx+=e,this.tiles[n]._locations[0].destinationy+=t)}},SetInitialTiles:function(e,t,n){var r=t/2,i=n/2;for(var s=0;s<e.length;s++)e[s]._locations[0].x=r,e[s]._locations[0].y=i,e[s].velocityx=0,e[s].velocityy=0,e[s]._locations[0].startx=r,e[s]._locations[0].starty=i,e[s]._locations[0].destinationx=0,e[s]._locations[0].destinationy=0,e[s].width=1,e[s].height=1},GetRowsAndColumns:function(e,t,n,r){var i=.7,s=n*(r-Math.pow(i,2)),o=(t+e*n)*i,u=-1*t*e,a=(-1*o+Math.sqrt(Math.pow(o,2)-4*s*u))/(2*s),f=Math.floor(a*n),l=Math.ceil(t/f),c=Math.floor(e/a),h=e-c*a;return{Rows:l,Columns:c,TileMaxWidth:a,TileHeight:f,PaddingX:h}},SetOuterTileDestination:function(e,t,n){var r=n._locations[0].x-e/2,i=n._locations[0].y-t/2,s=i/r,o=Math.atan2(i,r);n._locations[0].destinationx=e*Math.cos(o)+e/2,n._locations[0].destinationy=t*Math.sin(o)+t/2},SortBy:function(e,t,n,r){var i=function(t,r){if(n)for(var i=t.facetItem.Facets.length-1;i>-1;i-=1)if(t.facetItem.Facets[i].Name==e&&t.facetItem.Facets[i].FacetValues.length>0){if($.isNumeric(t.facetItem.Facets[i].FacetValues[0].Value))return n(t.facetItem.Facets[i].FacetValues[0].Value);for(var s=0;s<t.facetItem.Facets[i].FacetValues.length;s++)for(var o=0;o<r.length;o++)if(r[o].facet==e)for(var u=0;u<r[o].facetValue.length;u++)if(t.facetItem.Facets[i].FacetValues[s].Value==r[o].facetValue[u])return n(t.facetItem.Facets[i].FacetValues[s].Value)}return null};return function(e,n){var s=i(e,r),o=i(n,r);return(s<o?-1:s>o?1:0)*[1,-1][+!!t]}}}),PivotViewer.Views.GridView=PivotViewer.Views.TileBasedView.subClass({init:function(){this.Scale=1,this._super();var e=this;$.subscribe("/PivotViewer/Views/Canvas/Click",function(t){if(!e.isActive)return;var n=null,r=null;for(var i=0;i<e.tiles.length;i++){var s=e.tiles[i].Contains(t.x,t.y);s>=0?(r=e.tiles[i],n=e.tiles[i].facetItem.Id):e.tiles[i].Selected(!1)}e.handleSelection(n,r)}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(t){if(!e.isActive||e.selected.length>0)return;for(var n=0;n<e.tiles.length;n++){var r=e.tiles[n].Contains(t.x,t.y);r>=0?e.tiles[n].Selected(!0):e.tiles[n].Selected(!1)}}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(t){if(!e.isActive)return;var n=e.Scale,r=e.currentWidth,i=e.currentHeight,s=t.scale!=undefined?0:1e3;t.scale!=undefined?t.scale>=1?e.Scale+=t.scale-1:(e.Scale-=t.scale,e.Scale=e.Scale<1?1:e.Scale):t.delta!=undefined&&(e.Scale=t.delta==0?1:e.Scale+t.delta-1),e.Scale==NaN&&(e.Scale=1);var o=(e.width-e.offsetX)*e.Scale,u=(e.height-e.offsetY)*e.Scale;if(o<e.width||e.Scale==1)e.currentOffsetX=e.offsetX,e.currentOffsetY=e.offsetY,e.currentWidth=e.width,e.currentHeight=e.height,e.Scale=1;else{var a=(t.x-e.currentOffsetX)/n*e.Scale,f=(t.y-e.currentOffsetY)/n*e.Scale;e.currentOffsetX=t.x-a,e.currentOffsetY=t.y-f,e.currentWidth=o,e.currentHeight=u}var l=e.GetRowsAndColumns(e.currentWidth-e.offsetX,e.currentHeight-e.offsetY,e.maxRatio,e.currentFilter.length);e.SetVisibleTilePositions(l,e.currentFilter,e.currentOffsetX,e.currentOffsetY,!0,!0,s);if(e.Scale==1&&n!=1){for(var c=0;c<e.tiles.length;c++)e.tiles[c].Selected(!1);e.selected="",$.publish("/PivotViewer/Views/Item/Selected",[{id:e.selected,bkt:0}])}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(t){if(!e.isActive)return;var n=t.x,r=t.y,i=!1,s=!1;e.currentOffsetX+=n,e.currentOffsetY+=r,n>0&&e.currentOffsetX>e.offsetX&&(e.currentOffsetX-=n,i=!0),r>0&&e.currentOffsetY>e.offsetY&&(e.currentOffsetY-=r,s=!0),e.currentOffsetX<e.offsetX&&e.currentWidth==e.width&&(e.currentOffsetX-=n,i=!0),n<0&&e.currentOffsetX<-1*(e.currentWidth-e.width)&&(e.currentOffsetX-=n,i=!0),e.currentOffsetY<e.offsetY&&e.currentHeight==e.height&&(e.currentOffsetY-=r,s=!0),r<0&&e.currentOffsetY-e.offsetY<-1*(e.currentHeight-e.height)&&(e.currentOffsetY-=r,s=!0);if(i&&s)return;i?e.OffsetTiles(0,r):s?e.OffsetTiles(n,0):e.OffsetTiles(n,r)})},Setup:function(e,t,n,r,i){this.width=e,this.height=t,this.offsetX=n,this.offsetY=r,this.maxRatio=i,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY},Filter:function(e,t,n,r,i,s){var o=this;if(!Modernizr.canvas)return;Debug.Log("Grid View Filtered: "+t.length),this.changingView=!1,i&&($(".pv-tableview-table").fadeOut(),$(".pv-viewarea-canvas").fadeIn(),this.selected="",this.changingView=!0),this.tiles=e,this.init&&this.SetInitialTiles(this.tiles,this.width,this.height);for(var u=0;u<this.tiles.length;u++)while(this.tiles[u]._locations.length>1)this.tiles[u]._locations.pop();for(var a=0;a<this.tiles.length;a++)this.tiles[a].selectedLoc=0;this.tiles=this.tiles.sort(this.SortBy(n,!1,function(e){return $.isNumeric(e)?e:e.toUpperCase()},r)),this.currentFilter=t;var f=0;Debug.Log("this.currentWidth: "+this.currentWidth+" this.width: "+this.width);var l=$(".pv-toolbarpanel-zoomslider").slider("option","value");if(l>0){this.selected=s="",this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-toolbarpanel-zoomslider").slider("option","value",1);var c=this.GetRowsAndColumns(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,this.tiles.length),h=[];for(var a=0;a<this.tiles.length;a++)this.tiles[a].origwidth=c.TileHeight/this.tiles[a]._controller.GetRatio(this.tiles[a].facetItem.Img),this.tiles[a].origheight=c.TileHeight,h.push(this.tiles[a].facetItem.Id);this.SetVisibleTilePositions(c,h,this.currentOffsetX,this.currentOffsetY,!0,!1,1e3),f=1e3}setTimeout(function(){for(var e=0;e<o.tiles.length;e++){o.tiles[e]._locations[0].startx=o.tiles[e]._locations[0].x,o.tiles[e]._locations[0].starty=o.tiles[e]._locations[0].y,o.tiles[e].startwidth=o.tiles[e].width,o.tiles[e].startheight=o.tiles[e].height;var n=$.inArray(o.tiles[e].facetItem.Id,t);n<0&&(o.SetOuterTileDestination(o.width,o.height,o.tiles[e]),o.tiles[e].start=PivotViewer.Utils.Now(),o.tiles[e].end=o.tiles[e].start+1e3)}o.maxRatio=o.tiles[0]._controller.GetRatio(o.tiles[0].facetItem.Img);for(var e=0;e<o.tiles.length;e++){var n=$.inArray(o.tiles[e].facetItem.Id,t);n>=0&&o.tiles[e]._controller.GetRatio(o.tiles[e].facetItem.Img)<o.maxRatio&&(o.maxRatio=o.tiles[e]._controller.GetRatio(o.tiles[e].facetItem.Img))}var r=t.length==o.tiles.length?0:500;setTimeout(function(){var e=o.GetRowsAndColumns(o.width-o.offsetX,o.height-o.offsetY,o.maxRatio,o.currentFilter.length);for(var t=0;t<o.tiles.length;t++)o.tiles[t].origwidth=e.TileHeight/o.tiles[t]._controller.GetRatio(o.tiles[t].facetItem.Img),o.tiles[t].origheight=e.TileHeight;o.SetVisibleTilePositions(e,o.currentFilter,o.offsetX,o.offsetY,!1,!1,1e3)},r)},f),this.init=!1},GetUI:function(){return Modernizr.canvas?"":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"Content/images/GridView.png"},GetButtonImageSelected:function(){return"Content/images/GridViewSelected.png"},GetViewName:function(){return"Grid View"},SetVisibleTilePositions:function(e,t,n,r,i,s,o){var u=s&&this.rowscols?this.rowscols.Columns:e.Columns;s||(this.rowscols=e);var a=0,f=0;for(var l=0;l<this.tiles.length;l++){var c=$.inArray(this.tiles[l].facetItem.Id,t);c>=0&&(i&&(this.tiles[l]._locations[0].startx=this.tiles[l]._locations[0].x,this.tiles[l]._locations[0].starty=this.tiles[l]._locations[0].y,this.tiles[l].startwidth=this.tiles[l].width,this.tiles[l].startheight=this.tiles[l].height),this.tiles[l].destinationwidth=e.TileMaxWidth,this.tiles[l].destinationheight=e.TileHeight,this.tiles[l]._locations[0].destinationx=a*e.TileMaxWidth+n,this.tiles[l]._locations[0].destinationy=f*e.TileHeight+r,this.tiles[l].start=PivotViewer.Utils.Now(),this.tiles[l].end=this.tiles[l].start+o,a==u-1?(a=0,f++):a++)}},GetSelectedCol:function(e){var t=this;return selectedCol=Math.round((e._locations[0].x-t.currentOffsetX)/e.width),selectedCol},GetSelectedRow:function(e){var t=this;return selectedRow=Math.round((e._locations[0].y-t.currentOffsetY)/e.height),selectedRow},CentreOnSelectedTile:function(e,t){var n=this,r;for(var i=0;i<n.tiles.length;i++)if(n.tiles[i].IsSelected()){r=n.tiles[i];break}var s=n.GetRowsAndColumns(n.currentWidth-n.offsetX,n.currentHeight-n.offsetY,n.maxRatio,n.currentFilter.length);n.currentOffsetX=s.TileMaxWidth*e*-1+n.width/2-s.TileMaxWidth/2,n.currentOffsetY=s.TileHeight*t*-1+n.height/2-s.TileHeight/2,n.SetVisibleTilePositions(s,n.currentFilter,n.currentOffsetX,n.currentOffsetY,!0,!0,1e3)},handleSelection:function(e,t){var n=this,r=0,i=0,s=0,o=0;e!=null&&t!=null&&(r=Math.round((t._locations[0].x-n.currentOffsetX)/t.width),i=Math.round((t._locations[0].y-n.currentOffsetY)/t.height));if(e!=null&&n.selected!=e&&n.selected==""){var u=$(".pv-toolbarpanel-zoomslider").slider("option","value");u!=0&&$(".pv-toolbarpanel-zoomslider").slider("option","value",0)}e!=null&&t!=null&&(t.Selected(!0),tileHeight=t.height,tileWidth=t.height/t._controller.GetRatio(t.facetItem.Img),tileOrigHeight=t.origheight,tileOrigWidth=t.origwidth,canvasHeight=t.context.canvas.height,canvasWidth=t.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width()));if(e!=null&&n.selected!=e){tileHeight/canvasHeight>tileWidth/canvasWidth?origProportion=tileOrigHeight/canvasHeight:origProportion=tileOrigWidth/canvasWidth,scale=Math.round(.75/origProportion*2);if(n.selected==""){var u=$(".pv-toolbarpanel-zoomslider").slider("option","value");u=scale,$(".pv-toolbarpanel-zoomslider").slider("option","value",u)}n.selected=e,n.CentreOnSelectedTile(r,i)}else{n.selected=e="",n.currentOffsetX=n.offsetX,n.currentOffsetY=n.offsetY;var u=$(".pv-toolbarpanel-zoomslider").slider("option","value");u=0,$(".pv-toolbarpanel-zoomslider").slider("option","value",u)}$.publish("/PivotViewer/Views/Item/Selected",[{id:e,bkt:0}])}}),PivotViewer.Views.GraphView=PivotViewer.Views.TileBasedView.subClass({init:function(){this._super();var e=this;this.buckets=[],this.Scale=1,this.canvasHeightUIAdjusted=0,this.titleSpace=62,$.subscribe("/PivotViewer/Views/Canvas/Click",function(t){if(!e.isActive)return;var n=null,r=null,i=null;for(var s=0;s<e.tiles.length;s++){var o=e.tiles[s].Contains(t.x,t.y);o>=0?(r=e.tiles[s],n=e.tiles[s].facetItem.Id,i=o):e.tiles[s].Selected(!1)}e.handleSelection(n,r,t.x,i)}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(t){if(!e.isActive)return;$(".pv-viewarea-graphview-overlay-bucket").removeClass("graphview-bucket-hover");var n=Math.floor((t.x-e.offsetX)/e.columnWidth),r=$("#pv-viewarea-graphview-overlay-bucket-"+n);r.addClass("graphview-bucket-hover");for(var i=0;i<e.tiles.length;i++){var s=e.tiles[i].Contains(t.x,t.y);s>=0?(e.tiles[i].Selected(!0),e.tiles[i].selectedLoc=s):e.tiles[i].Selected(!1)}}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(t){if(!e.isActive)return;var n=e.Scale,r=e.currentWidth,i=e.currentHeight,s=t.scale!=undefined?0:1e3;t.scale!=undefined?t.scale>=1?e.Scale+=t.scale-1:(e.Scale-=t.scale,e.Scale=e.Scale<1?1:e.Scale):t.delta!=undefined&&(e.Scale=t.delta==0?1:e.Scale+t.delta-1),e.Scale==NaN&&(e.Scale=1);var o=(e.width-e.offsetX)*e.Scale,u=e.height*e.Scale;if(o<e.width||e.Scale==1)e.currentOffsetX=e.offsetX,e.currentOffsetY=e.offsetY,e.currentWidth=e.width,e.currentHeight=e.height,e.canvasHeightUIAdjusted=e.height-e.offsetY-e.titleSpace,e.columnWidth=(e.width-e.offsetX)/e.buckets.length,e.Scale=1,$(".pv-viewarea-graphview-overlay div").fadeIn("slow");else{e.currentOffsetX=t.x-(t.x-e.currentOffsetX)/n*e.Scale;var a=(t.y-e.currentOffsetY)/n*e.Scale;e.currentOffsetY=t.y-a,e.canvasHeightUIAdjusted=u-(e.offsetY+e.titleSpace)/n*e.Scale,e.currentWidth=o,e.currentHeight=u,e.columnWidth=o/e.buckets.length,$(".pv-viewarea-graphview-overlay div").fadeOut("slow")}e.rowscols=e.GetRowsAndColumns(e.columnWidth-2,e.canvasHeightUIAdjusted,e.maxRatio,e.bigCount),e.rowscols.TileHeight<10&&(e.rowscols.TileHeight=10),e.SetVisibleTileGraphPositions(e.rowscols,e.currentOffsetX,e.currentOffsetY,!0,!0);if(e.Scale==1&&n!=1){for(var f=0;f<e.tiles.length;f++)e.tiles[f].Selected(!1),e.tiles[f].selectedLoc=0;e.selected="",$.publish("/PivotViewer/Views/Item/Selected",[{id:e.selected,bkt:0}])}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(t){if(!e.isActive)return;var n=t.x,r=t.y,i=!1,s=!1;e.currentOffsetX+=n,e.currentOffsetY+=r,n>0&&e.currentOffsetX>e.offsetX&&(e.currentOffsetX-=n,i=!0),r>0&&e.currentOffsetY+e.canvasHeightUIAdjusted>e.currentHeight+e.offsetY&&(e.currentOffsetY-=r,s=!0),e.currentOffsetX<e.offsetX&&e.currentWidth==e.width&&(e.currentOffsetX-=n,i=!0),n<0&&e.currentOffsetX<-1*(e.currentWidth-e.width)&&(e.currentOffsetX-=n,i=!0),e.currentOffsetY<e.offsetY&&e.currentHeight==e.height&&(e.currentOffsetY-=r,s=!0),r<0&&e.currentOffsetY-e.offsetY<-1*(e.currentHeight-e.height)&&(e.currentOffsetY-=r,s=!0);if(i&&s)return;i?e.OffsetTiles(0,r):s?e.OffsetTiles(n,0):e.OffsetTiles(n,r)})},Setup:function(e,t,n,r,i){this.width=e,this.height=t,this.offsetX=n,this.offsetY=r,this.maxRatio=i,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,this.rowscols=null,this.bigCount=0},Filter:function(e,t,n,r){var i=this;if(!Modernizr.canvas)return;Debug.Log("Graph View Filtered: "+t.length),$(".pv-tableview-table").fadeOut(),$(".pv-viewarea-canvas").fadeIn(),this.sortFacet=n,this.tiles=e,this.tiles=e.sort(this.SortBy(this.sortFacet,!1,function(e){return $.isNumeric(e)?e:e.toUpperCase()},r)),this.currentFilter=t,this.buckets=this.Bucketize(e,t,this.sortFacet,r),this.columnWidth=(this.width-this.offsetX)/this.buckets.length,this.canvasHeightUIAdjusted=this.height-this.offsetY-this.titleSpace;var s=[];this.bigCount=0;for(var o=0;o<this.buckets.length;o++){var u=o%2==0?"graphview-bucket-dark":"graphview-bucket-light";s[o]="<div class='pv-viewarea-graphview-overlay-bucket "+u+"' id='pv-viewarea-graphview-overlay-bucket-"+o+"' style='width: "+(Math.floor(this.columnWidth)-4)+"px; height:"+(this.height-2)+"px; left:"+(o*this.columnWidth-2)+"px;'>",this.buckets[o].startRange==this.buckets[o].endRange?s[o]+="<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[o].startRange+"</div></div>":s[o]+="<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[o].startRange+"<br/>to<br/>"+this.buckets[o].endRange+"</div></div>",this.bigCount<this.buckets[o].Ids.length&&(this.bigCount=this.buckets[o].Ids.length)}var a=$(".pv-viewarea-graphview-overlay");a.css("left",this.offsetX+"px"),$(".pv-viewarea-graphview-overlay div").fadeOut("slow",function(){$(this).remove()}),a.append(s.join("")),$(".pv-viewarea-graphview-overlay div").fadeIn("slow");for(var o=0;o<this.tiles.length;o++){this.tiles[o]._locations[0].startx=this.tiles[o]._locations[0].x,this.tiles[o]._locations[0].starty=this.tiles[o]._locations[0].y,this.tiles[o].startwidth=this.tiles[o].width,this.tiles[o].startheight=this.tiles[o].height;var f=$.inArray(this.tiles[o].facetItem.Id,t);f<0&&(this.SetOuterTileDestination(this.width,this.height,this.tiles[o]),this.tiles[o].start=PivotViewer.Utils.Now(),this.tiles[o].end=this.tiles[o].start+1e3)}i.maxRatio=i.tiles[0]._controller.GetRatio(i.tiles[0].facetItem.Img);for(var o=0;o<i.tiles.length;o++){var f=$.inArray(i.tiles[o].facetItem.Id,t);f>=0&&i.tiles[o]._controller.GetRatio(i.tiles[o].facetItem.Img)<i.maxRatio&&(i.maxRatio=i.tiles[o]._controller.GetRatio(i.tiles[o].facetItem.Img))}var l=t.length==this.tiles.length?0:500;setTimeout(function(){var e=$(".pv-toolbarpanel-zoomslider").slider("option","value");e>0&&(this.selected=selectedItem="",this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-toolbarpanel-zoomslider").slider("option","value",1)),i.rowscols=i.GetRowsAndColumns(i.columnWidth-2,i.canvasHeightUIAdjusted-i.offsetY,i.maxRatio,i.bigCount),i.rowscols.TileHeight<10&&(i.rowscols.TileHeight=10);for(var t=0;t<i.tiles.length;t++)i.tiles[t].origwidth=i.rowscols.TileHeight/i.tiles[t]._controller.GetRatio(i.tiles[t].facetItem.Img),i.tiles[t].origheight=i.rowscols.TileHeight;i.SetVisibleTileGraphPositions(i.rowscols,i.offsetX,i.offsetY,!1,!1)},l),this.init=!1},GetUI:function(){return Modernizr.canvas?"<div class='pv-viewarea-graphview-overlay'></div>":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"Content/images/GraphView.png"},GetButtonImageSelected:function(){return"Content/images/GraphViewSelected.png"},GetViewName:function(){return"Graph View"},GetSortedFilter:function(){var e=[];for(i=0;i<this.buckets.length;i++)for(j=0;j<this.buckets[i].Ids.length;j++){var t=new Object;t.Id=this.buckets[i].Ids[j],t.Bucket=i,e.push(t)}return e},SetVisibleTileGraphPositions:function(e,t,n,r,i){var s=i&&this.rowscols?this.rowscols.Columns:e.Columns;i||(this.rowscols=e);var o=[],u=[];for(var a=0;a<this.tiles.length;a++){this.tiles[a].firstFilterItemDone=!1;while(this.tiles[a]._locations.length>1)this.tiles[a]._locations.pop()}for(var f=0;f<this.buckets.length;f++){var l=0,c=0;for(var h=0,p=this.tiles.length;h<p;h++)$.inArray(this.tiles[h].facetItem.Id,this.buckets[f].Ids)>=0&&(this.tiles[h].firstFilterItemDone?(tileLocation=new PivotViewer.Views.TileLocation,tileLocation.startx=this.tiles[h]._locations[0].startx,tileLocation.starty=this.tiles[h]._locations[0].starty,tileLocation.x=this.tiles[h]._locations[0].x,tileLocation.y=this.tiles[h]._locations[0].y,tileLocation.destinationx=f*this.columnWidth+l*e.TileMaxWidth+t,tileLocation.destinationy=this.canvasHeightUIAdjusted-e.TileHeight-c*e.TileHeight+n,this.tiles[h]._locations.push(tileLocation)):(r&&(this.tiles[h]._locations[0].startx=this.tiles[h]._locations[0].x,this.tiles[h]._locations[0].starty=this.tiles[h]._locations[0].y,this.tiles[h].startwidth=this.tiles[h].width,this.tiles[h].startheight=this.tiles[h].height),this.tiles[h].destinationwidth=e.TileMaxWidth,this.tiles[h].destinationheight=e.TileHeight,this.tiles[h]._locations[0].destinationx=f*this.columnWidth+l*e.TileMaxWidth+t,this.tiles[h]._locations[0].destinationy=this.canvasHeightUIAdjusted-e.TileHeight-c*e.TileHeight+n,this.tiles[h].start=PivotViewer.Utils.Now(),this.tiles[h].end=this.tiles[h].start+1e3,this.tiles[h].firstFilterItemDone=!0),l==s-1?(l=0,c++):l++)}},Bucketize:function(e,t,n,r){var i=[];for(var s=0;s<e.length;s++)if($.inArray(e[s].facetItem.Id,t)>=0){var o=!1;for(var u=0;u<e[s].facetItem.Facets.length;u++)if(e[s].facetItem.Facets[u].Name==n&&e[s].facetItem.Facets[u].FacetValues.length>0)for(var a=0;a<e[s].facetItem.Facets[u].FacetValues.length;a++){var f=e[s].facetItem.Facets[u].FacetValues[a].Value,l=!1;for(var c=0;c<i.length;c++)i[c].startRange==f&&($.inArray(e[s].facetItem.Id,i[c].Ids)<0&&i[c].Ids.push(e[s].facetItem.Id),l=!0);l||i.push({startRange:f,endRange:f,Ids:[e[s].facetItem.Id],Values:[f]}),o=!0}if(!o){var f="(no info)",l=!1;for(var c=0;c<i.length;c++)i[c].startRange==f&&(i[c].Ids.push(e[s].facetItem.Id),i[c].Values.push(f),l=!0);l||i.push({startRange:f,endRange:f,Ids:[e[s].facetItem.Id],Values:[f]})}}if(r.length>0){var h;for(var p=0;p<r.length;p++)if(r[p].facet==n){h=p;break}if(h!=undefined&&h>=0){var d=[],v=r[h].facetValue;for(var m=0;m<i.length;m++){var g=$.inArray(i[m].startRange,v);g>=0&&d.push(i[m])}i=d}}var y=0;while(i.length>8)if(y<i.length-1){i[y].endRange=i[y+1].endRange;for(var s=0;s<i[y+1].Ids.length;s++)$.inArray(i[y+1].Ids[s],i[y].Ids)<0&&i[y].Ids.push(i[y+1].Ids[s]),$.inArray(i[y+1].endRange,i[y].Values)<0&&i[y].Values.push(i[y+1].endRange);i.splice(y+1,1),y++}else y=0;return i},GetSelectedCol:function(e,t){var n=this,r=0;for(i=0;i<t;i++)$.inArray(e.facetItem.Id,this.buckets[i].Ids)>0&&r++;return padding=n.rowscols.PaddingX,colsInBar=n.rowscols.Columns,tileMaxWidth=n.rowscols.TileMaxWidth,selectedBar=Math.floor((e._locations[r].x-n.currentOffsetX)/(tileMaxWidth*colsInBar+padding)),selectedColInBar=Math.round((e._locations[r].x-n.currentOffsetX-selectedBar*(colsInBar*tileMaxWidth+padding))/tileMaxWidth),selectedCol=selectedBar*colsInBar+selectedColInBar,selectedCol},GetSelectedRow:function(e,t){var n=this,r=0;for(i=0;i<t;i++)$.inArray(e.facetItem.Id,this.buckets[i].Ids)>0&&r++;return selectedRow=Math.round((n.canvasHeightUIAdjusted-(e._locations[r].y-n.currentOffsetY))/e.height),selectedRow},CentreOnSelectedTile:function(e,t){var n=this,r;for(var i=0;i<n.tiles.length;i++)if(n.tiles[i].IsSelected()){r=n.tiles[i];break}n.rowscols=n.GetRowsAndColumns(n.columnWidth-2,n.canvasHeightUIAdjusted,n.maxRatio,n.bigCount),n.rowscols.TileHeight<10&&(n.rowscols.TileHeight=10);var s=Math.floor(e/n.rowscols.Columns),o=n.rowscols.PaddingX*s;n.currentOffsetX=n.rowscols.TileMaxWidth*e*-1+n.width/2-n.rowscols.TileMaxWidth/2-o,n.currentOffsetY=-n.rowscols.TileHeight*(n.rowscols.Rows/2-(t+1))-n.canvasHeightUIAdjusted/2-n.rowscols.TileHeight/2,n.SetVisibleTileGraphPositions(n.rowscols,n.currentOffsetX,n.currentOffsetY,!0,!0)},handleSelection:function(e,t,n,r){var i=this,s=0,o=0,u=!1,a=!1,f=0,l=0;e!=null&&t!=null&&(selectedX=t._locations[r].x,selectedY=t._locations[r].y);if(e!=null&&i.selected!=e&&i.selected==""){var c=$(".pv-toolbarpanel-zoomslider").slider("option","value");c!=0&&$(".pv-toolbarpanel-zoomslider").slider("option","value",0)}e!=null&&t!=null&&(t.Selected(!0),t.selectedLoc=r,u=!0,padding=i.rowscols.PaddingX,colsInBar=i.rowscols.Columns,tileMaxWidth=i.rowscols.TileMaxWidth,selectedBar=Math.floor((t._locations[r].x-i.currentOffsetX)/(t.width*colsInBar+padding)),selectedColInBar=Math.round((t._locations[r].x-i.currentOffsetX-selectedBar*(colsInBar*tileMaxWidth+padding))/tileMaxWidth),s=selectedBar*colsInBar+selectedColInBar,o=Math.round((i.canvasHeightUIAdjusted-(t._locations[r].y-i.currentOffsetY))/t.height),tileHeight=t.height,tileWidth=t.height/t._controller.GetRatio(t.facetItem.Img),tileOrigHeight=t.origheight,tileOrigWidth=t.origwidth,canvasHeight=t.context.canvas.height,canvasWidth=t.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width())),i.selected!=null&&i.selected!=""&&!u&&(a=!0);if(e!=null&&i.selected!=e){tileHeight/canvasHeight>tileWidth/canvasWidth?origProportion=tileOrigHeight/canvasHeight:origProportion=tileOrigWidth/canvasWidth,scale=Math.round(.75/origProportion*2);if(i.selected==""){var c=$(".pv-toolbarpanel-zoomslider").slider("option","value");c=scale,$(".pv-toolbarpanel-zoomslider").slider("option","value",c)}i.selected=e,i.CentreOnSelectedTile(s,o),$(".pv-viewarea-graphview-overlay div").fadeOut("slow")}else{i.selected=e="",selectedBar=0,i.currentOffsetX=i.offsetX,i.currentOffsetY=i.offsetY;var c=$(".pv-toolbarpanel-zoomslider").slider("option","value");c=0,$(".pv-toolbarpanel-zoomslider").slider("option","value",c),$(".pv-viewarea-graphview-overlay div").fadeIn("slow")}$.publish("/PivotViewer/Views/Item/Selected"
,[{id:e,bkt:selectedBar}]);if(!u&&!a){var h=Math.floor((n-i.offsetX)/i.columnWidth);$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:i.sortFacet,Item:i.buckets[h].startRange,MaxRange:i.buckets[h].endRange,Values:i.buckets[h].Values,ClearFacetFilters:!0}])}}}),PivotViewer.Views.TableView=PivotViewer.Views.IPivotViewerView.subClass({init:function(){this._super();var e=this,t,n="",r="",i="pv-key",s=!0,o=!0,u=!0},Setup:function(e,t,n,r,i){this.width=e,this.height=t,this.offsetX=n,this.offsetY=r,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY},Filter:function(e,t,n,r,i,s){var o=this;if(!Modernizr.canvas)return;Debug.Log("Table View Filtered: "+t.length),i&&($(".pv-viewarea-canvas").fadeOut(),$(".pv-tableview-table").fadeIn(function(){s&&$.publish("/PivotViewer/Views/Item/Selected",[{id:s.Id,bkt:0}])})),this.tiles=e,this.currentFilter=t,this.selectedId="",this.sortReverseEntity=!0,this.sortReverseAttribute=!0,this.sortReverseValue=!0,this.CreateTable(t,this.selectedFacet),this.init=!1},GetUI:function(){return Modernizr.canvas?"":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"Content/images/TableView.png"},GetButtonImageSelected:function(){return"Content/images/TableViewSelected.png"},GetViewName:function(){return"Table View"},SortTable:function(e){Debug.Log("SortTable"),e!="pv-key"&&e!="pv-facet"&&e=="pv-value"},CellClick:function(e,t){Debug.Log("CellClick");if(e=="pv-key"){var n=t[0].innerHTML,r=-1;for(var i=0;i<this.tiles.length;i++)if(this.tiles[i].facetItem.Name==n){r=this.tiles[i].facetItem.Id;break}r>0&&r!=this.selectedId?(this.selectedId=r,$.publish("/PivotViewer/Views/Item/Selected",[{id:r,bkt:0}])):r>0&&r==this.selectedId&&(this.selectedId="",$.publish("/PivotViewer/Views/Item/Selected",[{id:"",bkt:0}]))}else if(e=="pv-facet"){var s=[];this.selectedId==""||this.selectedId==null?s=this.currentFilter:s[0]=this.selectedId,this.selectedFacet==""?(this.selectedFacet=t[1].innerHTML,this.CreateTable(s,this.selectedFacet,this.sortKey)):(this.selectedFacet="",this.CreateTable(s,"")),$.publish("/PivotViewer/Views/Item/Updated",null)}else e=="pv-value"&&$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:t[1].innerHTML,Item:t[2].innerHTML,Values:null,ClearFacetFilters:!0}])},CreateTable:function(e,t,n,r){var i=this,s=$("#pv-table"),o=!1,u=new Array,a=0;s.empty();if(t==null||t==""||typeof t==undefined)o=!0;$(".pv-tableview-table").css("height",this.height-12+"px"),$(".pv-tableview-table").css("width",this.width-415+"px");var f="odd-row",c="<table style='color:#484848;'><tr class='pv-tableview-heading'><th id='pv-key'>Key</th><th id='pv-facet'>Facet</th><th id='pv-value'>Value</th></tr>";for(var h=0;h<e.length;h++)for(var p=0;p<this.tiles.length;p++)if(this.tiles[p].facetItem.Id==e[h]){var d=this.tiles[p].facetItem.Name;if(o||t=="Description"){var v;n=="pv-key"?v=d:n=="pv-facet"?v="Description":n=="pv-value"&&(v=this.tiles[p].facetItem.Description),u.push({key:v,value:"<tr class='pv-tableview-"+f+"'><td id='pv-key'>"+d+"</td><td id='pv-facet'>Description</td><td id='pv-value'>"+this.tiles[p].facetItem.Description+"</td></tr>"}),f="even-row"}f=="odd-row"?f="even-row":f="odd-row";if(o)for(k=0;k<this.tiles[p].facetItem.Facets.length;k++){var m=this.tiles[p].facetItem.Facets[k].Name;for(l=0;l<this.tiles[p].facetItem.Facets[k].FacetValues.length;l++){var g=this.tiles[p].facetItem.Facets[k].FacetValues[l].Value,v;n=="pv-key"?v=d:n=="pv-facet"?v=m:n=="pv-value"&&(v=g),this.IsFilterVisible(m)?u.push({key:v,value:"<tr class='pv-tableview-"+f+"'><td id='pv-key'>"+d+"</td><td id='pv-facet'>"+m+"</td><td id='pv-value' style='color:#36A3D8;cursor:pointer'>"+g+"</td></tr>"}):u.push({key:v,value:"<tr class='pv-tableview-"+f+"'><td id='pv-key'>"+d+"</td><td id='pv-facet'>"+m+"</td><td id='pv-value'>"+g+"</td></tr>"}),f=="odd-row"?f="even-row":f="odd-row"}}else for(k=0;k<this.tiles[p].facetItem.Facets.length;k++){var m=this.tiles[p].facetItem.Facets[k].Name;if(m==t){for(l=0;l<this.tiles[p].facetItem.Facets[k].FacetValues.length;l++){var g=this.tiles[p].facetItem.Facets[k].FacetValues[l].Value,v;n=="pv-key"?v=d:n=="pv-facet"?v=m:n=="pv-value"&&(v=g),this.IsFilterVisible(m)?u.push({key:v,value:"<tr class='pv-tableview-"+f+"'><td id='pv-key'>"+d+"</td><td id='pv-facet'>"+m+"</td><td id='pv-value' style='color:#36A3D8;cursor:pointer'>"+g+"</td></tr>"}):u.push({key:v,value:"<tr class='pv-tableview-"+f+"'><td id='pv-key'>"+d+"</td><td id='pv-facet'>"+m+"</td><td id='pv-value'>"+g+"</td></tr>"}),f=="odd-row"?f="even-row":f="odd-row"}break}}}u.sort(function(e,t){return e.key>t.key?1:e.key<t.key?-1:0}),r&&u.reverse();for(var h=0;h<u.length;h++)c+=u[h].value;c+="</table>",s.append(c),$(".pv-tableview-heading").on("click",function(e){var t=e.originalEvent.target.id,n=[];i.selectedId==""||i.selectedId==null?n=i.currentFilter:n[0]=i.selectedId;var r;t=="pv-key"?(i.sortReverseEntity?r=!1:r=!0,i.sortReverseEntity=r):t=="pv-facet"?(i.sortReverseAttribute?r=!1:r=!0,i.sortReverseAttribute=r):t=="pv-value"&&(i.sortReverseValue?r=!1:r=!0,i.sortReverseValue=r),i.sortKey=t,i.CreateTable(n,i.selectedFacet,t,r)}),$(".pv-tableview-odd-row").on("click",function(e){var t=e.originalEvent.target.id;i.CellClick(t,e.currentTarget.cells)}),$(".pv-tableview-even-row").on("click",function(e){var t=e.originalEvent.target.id;i.CellClick(t,e.currentTarget.cells)})},Selected:function(e){var t=[];e==""||e==null||typeof e==undefined?(this.selectedId="",this.CreateTable(this.currentFilter,this.selectedFacet)):(t[0]=e,this.selectedId=e,this.CreateTable(t,this.selectedFacet))},SetFacetCategories:function(e){this.categories=e.FacetCategories},IsFilterVisible:function(e){var t=null;for(i=0;i<this.categories.length;i++)this.categories[i].Name==e&&(t=this.categories[i].IsFilterVisible);return t!=null?t:!1},SetSelectedFacet:function(e){this.selectedFacet=e},GetSelectedFacet:function(){return this.selectedFacet}}),PivotViewer.Views.IImageController=Object.subClass({init:function(){},Setup:function(e){},GetImagesAtLevel:function(e,t){},Width:0,Height:0}),PivotViewer.Views.LoadImageSetHelper=Object.subClass({init:function(){this._images=[],this._loaded=!1},LoadImages:function(e){var t=this;for(var n=0;n<e.length;n++){var r=new Image;r.src=e[n],r.onload=function(){t._loaded=!0},this._images.push(r)}},GetImages:function(){return this._images},IsLoaded:function(){return this._loaded}}),PivotViewer.Views.DeepZoomImageController=PivotViewer.Views.IImageController.subClass({init:function(){this._items=[],this._collageItems=[],this._baseUrl="",this._collageMaxLevel=0,this._tileSize=256,this._format="",this._ratio=1,this.MaxRatio=1,this._zooming=!1;var e=this;$.subscribe("/PivotViewer/ImageController/Zoom",function(t){e._zooming=t})},Setup:function(e){this._baseUrl=e.substring(0,e.lastIndexOf("/")),this._collageUrl=e.substring(e.lastIndexOf("/")+1).replace(".xml","_files");var t=this;$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){var n=$(e).find("Collection");t._tileSize=$(n).attr("TileSize"),t._format=$(n).attr("Format"),t._collageMaxLevel=$(n).attr("MaxLevel");var r=$(e).find("I");if(r.length==0)return;var s=$(r[0]).find("Size");if(s.length>0){t.MaxWidth=parseInt(s.attr("Width")),t.Height=parseInt(s.attr("Height")),t.MaxRatio=t.Height/t.MaxWidth;for(i=0;i<r.length;i++){itemSize=$(r[i]).find("Size");var o=parseInt(itemSize.attr("Width")),u=parseInt(itemSize.attr("Height")),a=o>u?o:u,f=Math.ceil(Math.log(a)/Math.log(2));t._ratio=u/o;var l=$(r[i]).attr("Source"),c=$(r[i]).attr("Id"),h=$(r[i]).attr("N"),p=l.substring(l.lastIndexOf("/")+1).replace(/\.xml/gi,"").replace(/\.dzi/gi,""),d=l.substring(0,l.lastIndexOf("/"));d.length>0&&(d+="/"),t._items.push(new PivotViewer.Views.DeepZoomItem(c,p,h,d,t._ratio,o,u,f)),o>t.MaxWidth&&(t.MaxWidth=o),t._ratio<t.MaxRatio&&(t.MaxRatio=t._ratio)}}$.publish("/PivotViewer/ImageController/Collection/Loaded",null)},error:function(e,t,n){$(".pv-loading").remove();var r="";r+="Error loading from DeepZoom Cache<br><br>",r=r+"URL        : "+this.url+"<br>",r=r+"Status : "+e.status+" "+n+"<br>",r=r+"Details    : "+e.responseText+"<br>",r+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+r+"</p></div></div>");var i=setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}})},GetImagesAtLevel:function(e,t){t=t<=0?6:t;for(var n=0;n<this._items.length;n++)if(this._items[n].ItemId==e){t=t>this._items[n].MaxLevel?this._items[n].MaxLevel:t;var r=this._items[n].DZN.toString(2),i="",s="";for(var o=0;o<r.length;o++)o%2==0?i+=r[o]:s+=r[o];dzCol=parseInt(i,2),dzRow=parseInt(s,2);if(this._items[n].Levels!=undefined&&this._items[n].Levels.length!=0||!!this._zooming){if(this._items[n].Levels.length<t&&!this._zooming){var u=this.GetImageList(n,this._baseUrl+"/"+this._items[n].BasePath+this._items[n].DZId+"_files/"+t+"/",t),a=new PivotViewer.Views.LoadImageSetHelper;a.LoadImages(u),this._items[n].Levels.splice(t,0,a)}for(var f=t;f>-1;f--){if(this._items[n].Levels[f]!=undefined&&this._items[n].Levels[f].IsLoaded())return this._items[n].Levels[f].GetImages();if(f==t&&this._items[n].Levels[f]==undefined&&!this._zooming){var u=this.GetImageList(n,this._baseUrl+"/"+this._items[n].BasePath+this._items[n].DZId+"_files/"+f+"/",f),a=new PivotViewer.Views.LoadImageSetHelper;a.LoadImages(u),this._items[n].Levels.splice(f,0,a)}}return null}var u=this.GetImageList(n,this._baseUrl+"/"+this._items[n].BasePath+this._items[n].DZId+"_files/6/",6),a=new PivotViewer.Views.LoadImageSetHelper;return a.LoadImages(u),this._items[n].Levels.push(a),null}return null},GetImageList:function(e,t,n){var r=[],i=this._tileSize,s=this._format,o=this._items[e].Ratio,u=this._items[e].Height,a=this._items[e].MaxLevel,f=Math.ceil(u/o/Math.pow(2,a-n)),l=Math.ceil(u/Math.pow(2,a-n)),c=Math.ceil(f/i),h=Math.ceil(l/i);for(var p=0;p<c;p++)for(var d=0;d<h;d++)r.push(t+p+"_"+d+"."+s);return r},GetWidthForImage:function(e,t){for(var n=0;n<this._items.length;n++)if(this._items[n].ItemId==e)return Math.floor(t/this._items[n].Ratio)},GetDzi:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return dziName=this._baseUrl+"/"+this._items[t].BasePath+this._items[t].DZId+".dzi",dziName},GetMaxLevel:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return this._items[t].MaxLevel},GetWidth:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return this._items[t].Width},GetHeight:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return this._items[t].Height},GetRatio:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return this._items[t].Ratio}}),PivotViewer.Views.DeepZoomItem=Object.subClass({init:function(e,t,n,r,i,s,o,u){this.ItemId=e,this.DZId=t,this.DZN=parseInt(n),this.BasePath=r,this.Levels=[],this.Ratio=i,this.Width=s,this.Height=o,this.MaxLevel=u}}),PivotViewer.Views.TileController=Object.subClass({init:function(e){this._tiles=[],this._helpers=[],this._helperText="",this._easing=new Easing.Easer({type:"circular",side:"both"}),this._imageController=e},initTiles:function(e,t,n){for(var r=0;r<e.length;r++){var i=new PivotViewer.Views.Tile(this._imageController);i.facetItem=e[r],i.CollectionRoot=t.replace(/\\/gi,"/").replace(/\.xml/gi,""),this._canvasContext=n,i.context=this._canvasContext,tileLocation=new PivotViewer.Views.TileLocation,i._locations.push(tileLocation),this._tiles.push(i)}return this._tiles},AnimateTiles:function(e,n){var r=this;this._started=!0;var i=null,s=!1;if(this._tiles.length>0&&this._tiles[0].context!=null){i=this._tiles[0].context;var o=!1;for(var u=0;u<this._tiles.length;u++)for(c=0;c<this._tiles[u]._locations.length;c++){var a=PivotViewer.Utils.Now()-this._tiles[u].start,f=this._tiles[u].end-this._tiles[u].start;if(a<=f){if(this._tiles[u]._locations[c].x!=this._tiles[u]._locations[c].destinationx||this._tiles[u]._locations[c].y!=this._tiles[u]._locations[c].destinationy)o=!0;this._tiles[u]._locations[c].x=this._easing.ease(a,this._tiles[u]._locations[c].startx,this._tiles[u]._locations[c].destinationx-this._tiles[u]._locations[c].startx,f),this._tiles[u]._locations[c].y=this._easing.ease(a,this._tiles[u]._locations[c].starty,this._tiles[u]._locations[c].destinationy-this._tiles[u]._locations[c].starty,f);if(this._tiles[u].width!=this._tiles[u].destinationWidth||this._tiles[u].height!=this._tiles[u].destinationHeight)o=!0;this._tiles[u].width=this._easing.ease(a,this._tiles[u].startwidth,this._tiles[u].destinationwidth-this._tiles[u].startwidth,f),this._tiles[u].height=this._easing.ease(a,this._tiles[u].startheight,this._tiles[u].destinationheight-this._tiles[u].startheight,f)}else{this._tiles[u]._locations[c].x=this._tiles[u]._locations[c].destinationx,this._tiles[u]._locations[c].y=this._tiles[u]._locations[c].destinationy,this._tiles[u].width=this._tiles[u].destinationwidth,this._tiles[u].height=this._tiles[u].destinationheight;if(!isNaN(a)&&!isNaN(f)&&e){var l="";for(t=0;t<this._tiles.length;t++)if(this._tiles[t].facetItem.Id==n){l=this._tiles[t];break}n&&l&&$.publish("/PivotViewer/Views/Canvas/Click",[{x:l._locations[l.selectedLoc].destinationx,y:l._locations[l.selectedLoc].destinationy}]),e=!1,n=0}}this._tiles[u]._locations[c].destinationx+this._tiles[u].destinationwidth<0||this._tiles[u]._locations[c].destinationx>i.canvas.width||this._tiles[u]._locations[c].destinationy+this._tiles[u].destinationheight<0||this._tiles[u]._locations[c].destinationy>i.canvas.height?this._tiles[u].destinationVisible=!1:this._tiles[u].destinationVisible=!0}}this._isZooming!=o&&(this._isZooming=o,$.publish("/PivotViewer/ImageController/Zoom",[this._isZooming])),i.clearRect(0,0,i.canvas.width,i.canvas.height);for(var u=0;u<this._tiles.length;u++)for(var c=0;c<this._tiles[u]._locations.length;c++)this._tiles[u]._locations[c].x+this._tiles[u].width>0&&this._tiles[u]._locations[c].x<i.canvas.width&&this._tiles[u]._locations[c].y+this._tiles[u].height>0&&this._tiles[u]._locations[c].y<i.canvas.height&&(s?this._tiles[u].DrawEmpty(c):this._tiles[u].Draw(c));if(!!this._breaks){this._started=!1;return}requestAnimFrame(function(){r.AnimateTiles(e,n)})},BeginAnimation:function(e,t){!this._started&&this._tiles.length>0&&(this._breaks=!1,this.AnimateTiles(e,t))},StopAnimation:function(){this._breaks=!0},SetLinearEasingBoth:function(){this._easing=new Easing.Easer({type:"linear",side:"both"})},SetCircularEasingBoth:function(){this._easing=new Easing.Easer({type:"circular",side:"both"})},SetQuarticEasingOut:function(){this._easing=new Easing.Easer({type:"quartic",side:"out"})},GetMaxTileRatio:function(){return this._imageController.MaxRatio},DrawHelpers:function(e){this._helpers=e},DrawHelperText:function(e){this._helperText=e}}),PivotViewer.Views.Tile=Object.subClass({init:function(e){if(!(this instanceof PivotViewer.Views.Tile))return new PivotViewer.Views.Tile(e);this._controller=e,this._imageLoaded=!1,this._selected=!1,this._level=0,this._images=null,this._locations=[]},IsSelected:function(){return this._selected},Draw:function(e){if(this.destinationVisible){var t=this.width>this.height?this.width:this.height,n=Math.ceil(Math.log(t)/Math.log(2));if(n==Infinity||n==-Infinity)n=0;this._level=n,this._images=this._controller.GetImagesAtLevel(this.facetItem.Img,this._level)}if(this._images!=null){if(typeof this._images=="function")this._images(this.facetItem,this.context,this._locations[e].x+4,this._locations[e].y+4,this.width-8,this.height-8);else if(this._images.length>0&&this._images[0]instanceof Image){var r=this._controller.GetHeight(this.facetItem.Img),i=this.height-8,s=Math.ceil(this._controller.GetWidthForImage(this.facetItem.Img,i));blankWidth=this.width-8-s;for(var o=0;o<this._images.length;o++){var u=this._images[o].src,a=this._controller._tileSize,f=u.match(/[0-9]+_[0-9]+/g),l=parseInt(f[f.length-1].substring(0,f[f.length-1].indexOf("_"))),c=parseInt(f[f.length-1].substring(f[f.length-1].indexOf("_")+1));f=u.match(/_files\/[0-9]+\//g);var h=parseInt(f[0].substring(7,f[0].length-1)),p=Math.ceil(r/Math.pow(2,this._controller.GetMaxLevel(this.facetItem.Img)-h)),d=i/p,v=Math.floor(blankWidth/2)+4+l*Math.floor(a*d),m=4+Math.floor(c*a*d),g=Math.ceil(this._images[o].height*d),y=Math.ceil(this._images[o].width*d);this.context.drawImage(this._images[o],v+this._locations[e].x,m+this._locations[e].y,y,g)}if(this._selected){this.context.beginPath();var v=Math.floor(blankWidth/2)+4,m=4;this.context.rect(v+this._locations[this.selectedLoc].x,m+this._locations[this.selectedLoc].y,s,i),this.context.lineWidth=4,this.context.strokeStyle="#92C4E1",this.context.stroke()}}}else this.DrawEmpty(e)},Contains:function(e,t){var n=!1,r=-1;for(i=0;i<this._locations.length;i++)n=this._locations[i].x<=e&&this._locations[i].x+this.width>=e&&this._locations[i].y<=t&&this._locations[i].y+this.height>=t,n&&(r=i);return r},DrawEmpty:function(e){this._controller.DrawLevel==undefined?(this.context.beginPath(),this.context.fillStyle="#D7DDDD",this.context.fillRect(this._locations[e].x+4,this._locations[e].y+4,this.width-8,this.height-8),this.context.rect(this._locations[e].x+4,this._locations[e].y+4,this.width-8,this.height-8),this.context.lineWidth=1,this.context.strokeStyle="white",this.context.stroke()):this._controller.DrawLevel(this.facetItem,this.context,this._locations[e].x+4,this._locations[e].y+4,this.width-8,this.height-8)},CollectionRoot:"",now:null,end:null,width:0,height:0,origwidth:0,origheight:0,ratio:1,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,facetItem:null,firstFilterItemDone:!1,selectedLoc:0,Selected:function(e){this._selected=e}}),PivotViewer.Views.TileLocation=Object.subClass({init:function(){},x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0}),function(e){var t=[],n=[],r=[],s=[],o=[],u=[],a=[],f=0,l,c,h=[],p=[],d="",v=0,m="",g="",y=!1,b="",w,E=null,S=null,x={View:null,Facet:null,Filters:[]},T=null,N={},C=new PivotViewer.Models.Collection,k={init:function(e){T=this,T.addClass("pv-wrapper"),InitPreloader();if(e.Loader==undefined)throw"Collection loader is undefined.";if(!(e.Loader instanceof PivotViewer.Models.Loaders.ICollectionLoader))throw"Collection loader does not inherit from PivotViewer.Models.Loaders.ICollectionLoader.";e.Loader.LoadCollection(C);if(e.ImageController==undefined)w=new PivotViewer.Views.DeepZoomImageController;else{if(!e.ImageController instanceof PivotViewer.Views.IImageController)throw"Image Controller does not inherit from PivotViewer.Views.IImageController.";w=e.ImageController}if(e.ViewerState!=undefined){var t=e.ViewerState.split("&");for(var n=0,r=t.length;n<r;n++){var i=t[n].split("=");if(i.length==2)if(i[0]=="$view$")x.View=parseInt(i[1])-1;else if(i[0]=="$facet0$")x.Facet=PivotViewer.Utils.EscapeItemId(i[1]);else if(i[0]=="$selection$")x.Selection=PivotViewer.Utils.EscapeItemId(i[1]);else if(i[0]=="$tableFacet$")x.TableFacet=PivotViewer.Utils.EscapeItemId(i[1]);else{var s={Facet:i[0],Predicates:[]},o=i[1].split("_");for(var u=0,a=o.length;u<a;u++){var f=o[u].split(".");f.length==2&&s.Predicates.push({Operator:f[0],Value:f[1]})}x.Filters.push(s)}}}},show:function(){Debug.Log("Show")},hide:function(){Debug.Log("Hide")}};InitPreloader=function(){T.append("<div class='pv-loading'><img src='Content/images/loading.gif' alt='Loading' /><span>Loading...</span></div>"),e(".pv-loading").css("top",e(".pv-wrapper").height()/2-33+"px"),e(".pv-loading").css("left",e(".pv-wrapper").width()/2-43+"px")},InitTileCollection=function(){InitUI();var t=C.ImageBase;t.indexOf("http",0)>=0||t.indexOf("www.",0)>=0||(t=C.CXMLBase.substring(0,C.CXMLBase.lastIndexOf("/")+1)+t);var n=e(".pv-viewarea-canvas")[0].getContext("2d");c=new PivotViewer.Views.TileController(w),h=c.initTiles(C.Items,t,n),w.Setup(t.replace("\\","/"))},InitPivotViewer=function(){CreateFacetList(),CreateViews(),AttachEventHandlers(),e(".pv-loading").remove(),ApplyViewerState(),m=GetItem(x.Selection),g=x.TableFacet;var t=e(".pv-toolbarpanel").innerWidth()-(25+e(".pv-toolbarpanel-name").outerWidth()+e(".pv-toolbarpanel-zoomcontrols").outerWidth()+e(".pv-toolbarpanel-viewcontrols").outerWidth()+e(".pv-toolbarpanel-sortcontrols").outerWidth());e(".pv-toolbarpanel-facetbreadcrumb").css("width",t+"px"),x.View!=null?SelectView(x.View,!0):SelectView(0,!0);var n=m&&m.Id?m.Id:"";c.BeginAnimation(!0,n)},InitUI=function(){var t="<div class='pv-toolbarpanel'>",n=C.BrandImage;n.length>0&&(t+="<img class='pv-toolbarpanel-brandimage' src='"+n+"'></img>"),t+="<span class='pv-toolbarpanel-name'>"+C.CollectionName+"</span>",t+="<div class='pv-toolbarpanel-facetbreadcrumb'></div>",t+="<div class='pv-toolbarpanel-zoomcontrols'><div class='pv-toolbarpanel-zoomslider'></div></div>",t+="<div class='pv-toolbarpanel-viewcontrols'></div>",t+="<div class='pv-toolbarpanel-sortcontrols'></div>",t+="</div>",T.append(t);var r=0;e(".pv-toolbarpanel-zoomslider").slider({max:100,change:function(t,n){var i=n.value-r;centreX=e(".pv-viewarea-canvas").width()/2,centreY=e(".pv-viewarea-canvas").height()/2,e.publish("/PivotViewer/Views/Canvas/Zoom",[{x:centreX,y:centreY,delta:.5*i}]),r=n.value}}),T.append("<div class='pv-mainpanel'></div>");var i=e(".pv-wrapper").height()-e(".pv-toolbarpanel").height()-6;e(".pv-mainpanel").css("height",i+"px"),e(".pv-mainpanel").append("<div class='pv-filterpanel'></div>"),e(".pv-mainpanel").append("<div class='pv-viewpanel'><canvas class='pv-viewarea-canvas' width='"+T.width()+"' height='"+i+"px'></canvas></div>"),e(".pv-mainpanel").append("<div class='pv-infopanel'></div>"),e(".pv-viewpanel").append("<div class='pv-tableview-table' id='pv-table'></div>");var s=e(".pv-filterpanel");s.append("<div class='pv-filterpanel-clearall'>Clear All</div>").append("<input class='pv-filterpanel-search' type='text' placeholder='Search...' /><div class='pv-filterpanel-search-autocomplete'></div>").css("height",i-13+"px"),navigator.userAgent.match(/iPad/i)!=null?e(".pv-filterpanel-search").css("width",s.width()-10+"px"):e(".pv-filterpanel-search").css("width",s.width()-2+"px"),e(".pv-filterpanel-search-autocomplete").css("width",s.width()-8+"px").hide();var o=e(".pv-infopanel");o.css("left",e(".pv-mainpanel").offset().left+e(".pv-mainpanel").width()-205+"px").css("height",i-28+"px"),o.append("<div class='pv-infopanel-controls'></div>"),e(".pv-infopanel-controls").append("<div><div class='pv-infopanel-controls-navleft'></div><div class='pv-infopanel-controls-navleftdisabled'></div><div class='pv-infopanel-controls-navbar'></div><div class='pv-infopanel-controls-navright'></div><div class='pv-infopanel-controls-navrightdisabled'></div></div>"),e(".pv-infopanel-controls-navleftdisabled").hide(),e(".pv-infopanel-controls-navrightdisabled").hide(),o.append("<div class='pv-infopanel-heading'></div>"),o.append("<div class='pv-infopanel-details'></div>"),C.CopyrightName!=""&&o.append("<div class='pv-infopanel-copyright'><a href=\""+C.CopyrightHref+'" target="_blank">'+C.CopyrightName+"</a></div>"),o.hide()},CreateFacetList=function(){for(var t=0;t<C.Items.length;t++){var i=C.Items[t];for(var u=0;u<C.FacetCategories.length;u++){var a=C.FacetCategories[u];if(a.IsFilterVisible){var f=!1;for(var l=0,c=i.Facets.length;l<c;l++){var h=i.Facets[l];if(h.Name==a.Name){for(var p=0;p<h.FacetValues.length;p++)if(a.Type==PivotViewer.Models.FacetType.String){var d=!1,v="pv-facet-item-"+CleanName(h.Name)+"__"+CleanName(h.FacetValues[p].Value);for(var m=n.length-1;m>-1;m-=1)if(n[m].itemId==v){n[m].count+=1,d=!0;break}d||n.push({itemId:v,itemValue:h.FacetValues[p].Value,facet:h.Name,count:1})}else if(a.Type==PivotViewer.Models.FacetType.Number){var g=!1;for(var m=0;m<r.length;m++)if(r[m].Facet==i.Facets[l].Name){r[m].Values.push(h.FacetValues[p].Value),g=!0;break}g||r.push({Facet:h.Name,Values:[h.FacetValues[p].Value]})}else if(a.Type==PivotViewer.Models.FacetType.DateTime){var y=!1,v="pv-facet-item-"+CleanName(h.Name)+"__"+CleanName(h.FacetValues[p].Value);for(var m=0;m<s.length;m++)if(s[m].itemId==v){s[m].count+=1,y=!0;break}y||s.push({itemId:v,itemValue:h.FacetValues[p].Value,facet:h.Name,count:1})}f=!0}}if(!f){var d=!1,v="pv-facet-item-"+CleanName(a.Name)+"__"+CleanName("(no info)");for(var m=n.length-1;m>-1;m-=1)if(n[m].itemId==v){n[m].count+=1,d=!0;break}d||n.push({itemId:v,itemValue:"(no info)",facet:a.Name,count:1})}}if(a.IsWordWheelVisible)for(var l=0,c=i.Facets.length;l<c;l++){var h=i.Facets[l];if(h.Name==a.Name)for(var p=0;p<h.FacetValues.length;p++)a.Type==PivotViewer.Models.FacetType.String&&o.push({Facet:h.Name,Value:h.FacetValues[p].Value})}}}var b=["<div class='pv-filterpanel-accordion'>"],w=[];for(var t=0;t<C.FacetCategories.length;t++)C.FacetCategories[t].IsFilterVisible&&(b[t+1]="<h3><a href='#' title="+C.FacetCategories[t].Name+">",b[t+1]+=C.FacetCategories[t].Name,b[t+1]+="</a><div class='pv-filterpanel-accordion-heading-clear' facetType='"+C.FacetCategories[t].Type+"'>&nbsp;</div></h3>",b[t+1]+="<div style='height:30%' id='pv-cat-"+CleanName(C.FacetCategories[t].Name)+"'>",C.FacetCategories[t].Type==PivotViewer.Models.FacetType.DateTime&&(b[t+1]+=CreateDateTimeFacet(C.FacetCategories[t].Name)),C.FacetCategories[t].Type==PivotViewer.Models.FacetType.String?(C.FacetCategories[t].CustomSort!=undefined||C.FacetCategories[t].CustomSort!=null?b[t+1]+="<span class='pv-filterpanel-accordion-facet-sort' customSort='"+C.FacetCategories[t].CustomSort.Name+"'>Sort: "+C.FacetCategories[t].CustomSort.Name+"</span>":b[t+1]+="<span class='pv-filterpanel-accordion-facet-sort'>Sort: A-Z</span>",b[t+1]+=CreateStringFacet(C.FacetCategories[t].Name)):C.FacetCategories[t].Type==PivotViewer.Models.FacetType.Number&&(b[t+1]+="<div id='pv-filterpanel-category-numberitem-"+CleanName(C.FacetCategories[t].Name)+"'></div>"),b[t+1]+="</div>",w[t]="<option value='"+CleanName(C.FacetCategories[t].Name)+"' label='"+C.FacetCategories[t].Name+"'>"+C.FacetCategories[t].Name+"</option>");b[b.length]="</div>",e(".pv-filterpanel").append(b.join(""));for(var t=0;t<C.FacetCategories.length;t++)C.FacetCategories[t].IsFilterVisible&&SortFacetItems(C.FacetCategories[t].Name);e(".pv-filterpanel-accordion").css("height",e(".pv-filterpanel").height()-e(".pv-filterpanel-search").height()-75+"px"),e(".pv-filterpanel-accordion").accordion({}),e(".pv-toolbarpanel-sortcontrols").append('<select class="pv-toolbarpanel-sort">'+w.join("")+"</select>");for(var t=0;t<r.length;t++)CreateNumberFacet(CleanName(r[t].Facet),r[t].Values)},CreateDateTimeFacet=function(e){var t=["<ul class='pv-filterpanel-accordion-facet-list'>"];for(var n=0;n<s.length;n++)s[n].facet==e&&(t[n+1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+s[n].itemId+"'>",t[n+1]+="<input itemvalue='"+CleanName(s[n].itemValue)+"' itemfacet='"+CleanName(e)+"' class='pv-facet-facetitem' type='checkbox' />",t[n+1]+="<span class='pv-facet-facetitem-label' title='"+s[n].itemValue+"'>"+s[n].itemValue+"</span>",t[n+1]+="<span class='pv-facet-facetitem-count'>0</span>",t[n+1]+="</li>");return t[t.length]="</ul>",t.join("")},CreateStringFacet=function(e){var t=["<ul class='pv-filterpanel-accordion-facet-list'>"];for(var r=0;r<n.length;r++)n[r].facet==e&&(t[r+1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+n[r].itemId+"'>",t[r+1]+="<input itemvalue='"+CleanName(n[r].itemValue)+"' itemfacet='"+CleanName(e)+"' class='pv-facet-facetitem' type='checkbox' />",t[r+1]+="<span class='pv-facet-facetitem-label' title='"+n[r].itemValue+"'>"+n[r].itemValue+"</span>",t[r+1]+="<span class='pv-facet-facetitem-count'>0</span>",t[r+1]+="</li>");return t[t.length]="</ul>",t.join("")},CreateNumberFacet=function(t,n){var r=165,i=80,s=e("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(t));s.empty(),s.append("<span class='pv-filterpanel-numericslider-range-val'>&nbsp;</span>");var o="<svg class='pv-filterpanel-accordion-facet-chart' width='"+r+"' height='"+i+"'>",u=PivotViewer.Utils.Histogram(n),a=.5+r/u.BinCount|0,f=0;for(var l=0,c=u.Histogram.length;l<c;l++)f=f<u.Histogram[l].length?u.Histogram[l].length:f;for(var l=0,c=u.Histogram.length;l<c;l++){var h=.5+i/(f/u.Histogram[l].length)|0,p=.5+a*l|0;o+="<rect x='"+p+"' y='"+(i-h)+"' width='"+a+"' height='"+h+"'></rect>"}s.append(o+"</svg>");var d=e("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(t));d.append('</span><div id="pv-filterpanel-numericslider-'+t+'" class="pv-filterpanel-numericslider"></div><span class="pv-filterpanel-numericslider-range-min">'+u.Min+'</span><span class="pv-filterpanel-numericslider-range-max">'+u.Max+"</span>");var v=e("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeMetaChars(t));v.slider({range:!0,min:u.Min,max:u.Max,values:[u.Min,u.Max],slide:function(t,n){e(this).parent().find(".pv-filterpanel-numericslider-range-val").text(n.values[0]+" - "+n.values[1])},stop:function(t,n){var r=e(this),i=r.slider("option","min"),s=r.slider("option","max");n.values[0]>i||n.values[1]<s?r.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"):n.values[0]==i&&n.values[1]==s&&r.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection(!1)}})},CreateViews=function(){var n=e(".pv-viewpanel"),r=T.width(),i=e(".pv-mainpanel").height(),s=e(".pv-filterpanel").width()+18,o=4;t.push(new PivotViewer.Views.GridView),t.push(new PivotViewer.Views.GraphView),t.push(new PivotViewer.Views.TableView);for(var u=0;u<t.length;u++)try{if(t[u]instanceof PivotViewer.Views.IPivotViewerView)t[u].Setup(r,i,s,o,c.GetMaxTileRatio()),n.append("<div class='pv-viewpanel-view' id='pv-viewpanel-view-"+u+"'>"+t[u].GetUI()+"</div>"),e(".pv-toolbarpanel-viewcontrols").append("<div class='pv-toolbarpanel-view' id='pv-toolbarpanel-view-"+u+"' title='"+t[u].GetViewName()+"'><img id='pv-viewpanel-view-"+u+"-image' src='"+t[u].GetButtonImage()+"' alt='"+t[u].GetViewName()+"' /></div>");else{var a="";a+="View does not inherit from PivotViewer.Views.IPivotViewerView<br>",e(".pv-wrapper").append('<div id="pv-view-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+a+"</p></div></div>"),window.open("#pv-view-error","_self")}}catch(f){alert(f.Message)}t[2].SetFacetCategories(C)},SelectView=function(n,r){for(var i=0;i<t.length;i++)n!=i&&(e("#pv-viewpanel-view-"+i+"-image").attr("src",t[i].GetButtonImage()),t[i].Deactivate(),t[i].init=!1);e("#pv-viewpanel-view-"+n+"-image").attr("src",t[n].GetButtonImageSelected()),t[n].Activate(),t[n].init=r;var s=f,o=d.Id;f=n,FilterCollection(!0)},SortFacetItems=function(t){var n=e("#pv-cat-"+PivotViewer.Utils.EscapeMetaChars(CleanName(t))+" ul"),r=n.prev().text().replace("Sort: ",""),i=n.children("li").get();if(r=="A-Z")i.sort(function(t,n){var r=e(t).children().first().attr("itemvalue"),i=e(n).children().first().attr("itemvalue");return r<i?1:r>i?-1:0});else if(r=="Quantity")i.sort(function(t,n){var r=parseInt(e(t).children(".pv-facet-facetitem-count").text()),i=parseInt(e(n).children(".pv-facet-facetitem-count").text());return r<i?-1:r>i?1:0});else{var s=C.GetFacetCategoryByName(t);if(s.CustomSort!=undefined){var o=[];for(var u=s.CustomSort.SortValues.length-1;u>-1;u-=1)for(var a=0;a<i.length;a++)s.CustomSort.SortValues[u]==e(i[a]).children(".pv-facet-facetitem-label").text()&&(o.push(i[a]),found=!0);i=o}}for(var u=0;u<i.length;u++)n.prepend(i[u])},ApplyViewerState=function(){x.Facet!=null&&(e(".pv-toolbarpanel-sort").val(x.Facet).attr("selected","selected"),b=e(".pv-toolbarpanel-sort option:selected").text());for(var t=0,n=x.Filters.length;t<n;t++)for(var r=0,i=x.Filters[t].Predicates.length;r<i;r++){var s=x.Filters[t].Predicates[r].Operator;if(s=="GT"||s=="GE"||s=="LT"||s=="LE"){var o=e("#pv-filterpanel-numericslider-"+CleanName(x.Filters[t].Facet)),u=parseFloat(x.Filters[t].Predicates[r].Value);switch(s){case"GT":o.slider("values",0,u+1);break;case"GE":o.slider("values",0,u);break;case"LT":o.slider("values",1,u-1);break;case"LE":o.slider("values",1,u)}o.parent().find(".pv-filterpanel-numericslider-range-val").text(o.slider("values",0)+" - "+o.slider("values",1)),o.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility"
,"visible")}else s=="EQ"?SelectStringFacetItem(CleanName(x.Filters[t].Facet),CleanName(x.Filters[t].Predicates[r].Value)):s=="NT"&&SelectStringFacetItem(CleanName(x.Filters[t].Facet),"_no_info_")}},SelectStringFacetItem=function(t,n){var r=e('.pv-facet-facetitem[itemfacet="'+t+'"][itemvalue="'+n+'"]');r.prop("checked",!0),r.parent().parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")},FilterCollection=function(n){var r=[],i=[],s=[],o=e(".pv-toolbarpanel-sort option:selected").text(),l=e(".pv-facet-facetitem:checked");e(".pv-filterpanel-clearall").css("visibility","hidden");var v=[];for(var b=0;b<l.length;b++){var w=N[e(l[b]).attr("itemfacet")],E=N[e(l[b]).attr("itemvalue")],S=!1;for(var x=0;x<v.length;x++)v[x].facet==w&&(v[x].facetValue.push(E),S=!0);S||v.push({facet:w,facetValue:[E]}),e.inArray(w,s)<0&&s.push(w)}var T=[];for(var b=0,k=C.FacetCategories.length;b<k;b++)if(C.FacetCategories[b].Type==PivotViewer.Models.FacetType.Number){var L=e("#pv-filterpanel-category-numberitem-"+CleanName(C.FacetCategories[b].Name)),A=e(L).find(".pv-filterpanel-numericslider");if(A.length>0){var O=A.slider("values"),M=A.slider("option","max"),_=A.slider("option","min");if(O[0]!=_||O[1]!=M){var w=C.FacetCategories[b].Name;T.push({facet:w,selectedMin:O[0],selectedMax:O[1],rangeMin:_,rangeMax:M}),e.inArray(w,s)<0&&s.push(w)}}}for(var b=0,k=C.Items.length;b<k;b++){var D=0;for(var P=0,H=v.length;P<H;P++)for(var B=0,j=v[P].facetValue.length;B<j;B++)if(v[P].facetValue[B]=="(no info)"){var F=!1;for(var x=0,I=C.Items[b].Facets.length;x<I;x++)C.Items[b].Facets[x].Name==v[P].facet&&(F=!0);F==0&&D++}for(var x=0,I=C.Items[b].Facets.length;x<I;x++)for(var P=0,H=v.length;P<H;P++){var q=0;if(C.Items[b].Facets[x].Name==v[P].facet)for(var R=0,U=C.Items[b].Facets[x].FacetValues.length;R<U;R++)for(var B=0,j=v[P].facetValue.length;B<j;B++)C.Items[b].Facets[x].FacetValues[R].Value==v[P].facetValue[B]&&q++;q>0&&D++}if(D!=v.length)continue;for(var P=0,H=T.length;P<H;P++)if(T[P].selectedMin=="(no info)"){var F=!1;for(var x=0,I=C.Items[b].Facets.length;x<I;x++)C.Items[b].Facets[x].Name==T[P].facet&&(F=!0);F==0&&D++}for(var x=0,I=C.Items[b].Facets.length;x<I;x++)for(var P=0,H=T.length;P<H;P++)if(C.Items[b].Facets[x].Name==T[P].facet)for(var R=0,U=C.Items[b].Facets[x].FacetValues.length;R<U;R++){var z=parseFloat(C.Items[b].Facets[x].FacetValues[R].Value);!isNaN(z)&&z>=T[P].selectedMin&&z<=T[P].selectedMax&&D++}if(D!=v.length+T.length)continue;r.push(C.Items[b].Id),v.length+T.length>0&&e(".pv-filterpanel-clearall").css("visibility","visible")}a=T,u=v,e(".pv-viewpanel-view").hide(),e("#pv-viewpanel-view-"+f).show(),FilterFacets(r,s),UpdateBreadcrumbNavigation(v,T),c.SetCircularEasingBoth(),y?t[f].Filter(h,r,o,v,n,d):(t[f].SetSelectedFacet(g),t[f].Filter(h,r,o,v,n,m),y=!0);var W=[];if(t[f].GetViewName()=="Graph View")W=t[f].GetSortedFilter();else for(var b=0;b<t[f].tiles.length;b++){var X=e.inArray(t[f].tiles[b].facetItem.Id,r);if(X>=0){var V=new Object;V.Id=t[f].tiles[b].facetItem.Id,V.Bucket=0,W.push(V)}}p=W,UpdateBookmark(),DeselectInfoPanel()},FilterFacets=function(t,i){if(t.length==C.Items.length){for(var o=s.length-1;o>-1;o-=1){var u=e("#"+PivotViewer.Utils.EscapeMetaChars(s[o].itemId));u.show(),u.find("span").last().text(s[o].count)}for(var o=n.length-1;o>-1;o-=1){var u=e("#"+PivotViewer.Utils.EscapeMetaChars(n[o].itemId));u.show(),u.find("span").last().text(n[o].count)}for(var o=0;o<r.length;o++)CreateNumberFacet(CleanName(r[o].Facet),r[o].Values);return}var a=[],f=[],l=[];for(var o=t.length-1;o>-1;o-=1){var u=C.GetItemById(t[o]);for(var c=0;c<C.FacetCategories.length;c++)if(C.FacetCategories[c].IsFilterVisible){var h=!1;for(var p=u.Facets.length-1;p>-1;p-=1)if(u.Facets[p].Name==C.FacetCategories[c].Name){if(e.inArray(u.Facets[p].Name,i)<0){var d=C.GetFacetCategoryByName(u.Facets[p].Name);if(d.IsFilterVisible)for(var v=u.Facets[p].FacetValues.length-1;v>-1;v-=1)if(d.Type==PivotViewer.Models.FacetType.String){var m={item:"#"+PivotViewer.Utils.EscapeMetaChars("pv-facet-item-"+CleanName(u.Facets[p].Name)+"__"+CleanName(u.Facets[p].FacetValues[v].Value)),count:1},g=!1;for(var y=a.length-1;y>-1;y-=1)if(a[y].item==m.item){a[y].count+=1,g=!0;break}g||a.push(m)}else if(d.Type==PivotViewer.Models.FacetType.Number){var b=!1;for(var y=0;y<f.length;y++)if(f[y].Facet==u.Facets[p].Name){f[y].Values.push(u.Facets[p].FacetValues[v].Value),b=!0;break}b||f.push({Facet:u.Facets[p].Name,Values:[u.Facets[p].FacetValues[v].Value]})}}h=!0}if(!h){var m={item:"#"+PivotViewer.Utils.EscapeMetaChars("pv-facet-item-"+CleanName(C.FacetCategories[c].Name)+"__"+CleanName("(no info)")),count:1},g=!1;for(var y=a.length-1;y>-1;y-=1)if(a[y].item==m.item){a[y].count+=1,g=!0;break}g||a.push(m)}}}for(var o=n.length-1;o>-1;o-=1)if(e.inArray(n[o].facet,i)<0){var g=!1;for(var p=a.length-1;p>-1;p-=1)if(a[p].item==n[o].itemId){g=!0;break}g||e("#"+PivotViewer.Utils.EscapeMetaChars(n[o].itemId)).hide()}else e("#"+PivotViewer.Utils.EscapeMetaChars(n[o].itemId)).find("span").last().text(n[o].count);for(var o=a.length-1;o>-1;o-=1){var w=e(a[o].item);if(w.length>0){w.show();var E=w.find("span").last();E.text(a[o].count)}}for(var o=0;o<f.length;o++)CreateNumberFacet(CleanName(f[o].Facet),f[o].Values)},UpdateBreadcrumbNavigation=function(t,n){var r=e(".pv-toolbarpanel-facetbreadcrumb");r.empty();if(t.length==0&&n.length==0)return;var i="|";for(var s=0,o=t.length;s<o;s++)i+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+t[s].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",i+=t[s].facetValue.join(", "),i+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>";for(var s=0,o=n.length;s<o;s++)i+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+n[s].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",n[s].selectedMin==n[s].rangeMin?i+="Under "+n[s].selectedMax:n[s].selectedMax==n[s].rangeMax?i+="Over "+n[s].selectedMin:i+=n[s].selectedMin+" - "+n[s].selectedMax,i+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>";r.append(i)},DeselectInfoPanel=function(){e(".pv-infopanel").fadeOut(),e(".pv-infopanel-heading").empty(),e(".pv-infopanel-details").empty()},GetItemIds=function(e,t){var n=[];for(var r=0;r<C.Items.length;r++){var i=!1;for(var s=0;s<C.Items[r].Facets.length;s++)if(C.Items[r].Facets[s].Name==e){for(var o=0;o<C.Items[r].Facets[s].FacetValues.length;o++)t==C.Items[r].Facets[s].FacetValues[o].Value&&n.push(C.Items[r].Id);i=!0}!i&&t=="(no info)"&&n.push(C.Items[r].Id)}return n},GetItem=function(e){for(var t=0;t<C.Items.length;t++)if(C.Items[t].Id==e)return C.Items[t];return null},UpdateBookmark=function(){var e="#",n=f+1;e+="$view$="+n,b&&(e+="&$facet0$="+b),d&&(e+="&$selection$="+d.Id),f==2&&(e+="&$tableFacet$="+t[f].GetSelectedFacet());var r=C.CollectionName;a.length+u.length>0&&(r+=" | ");if(u.length>0)for(i=0;i<u.length;i++){for(j=0;j<u[i].facetValue.length;j++)e+="&",e+=u[i].facet,e+="=EQ."+u[i].facetValue[j];r+=u[i].facet+": ",r+=u[i].facetValue.join(", "),i<u.length-1&&(r+=" > ")}if(a.length>0)for(i=0;i<a.length;i++)e+="&",e+=a[i].facet,r+=a[i].facet+": ",a[i].selectedMin==a[i].rangeMin?(e+="=LE."+a[i].selectedMax,r+="Under "+a[i].selectedMax):a[i].selectedMax==a[i].rangeMax?(e+="=GE."+a[i].selectedMin,r+="Over "+a[i].selectedMin):(e+="=GE."+a[i].selectedMin+"_LE."+a[i].selectedMax,r+="Between "+a[i].selectedMin+" and "+a[i].selectedMax),i<a.length-1&&(r+=" > ");typeof SetBookmark!=undefined&&typeof SetBookmark=="function"&&SetBookmark(C.CXMLBaseNoProxy,e,r)},CleanName=function(e){return name=e.replace(/[^\w]/gi,"_"),N[name]=e,name},e.subscribe("/PivotViewer/Models/Collection/Loaded",function(e){InitTileCollection()}),e.subscribe("/PivotViewer/ImageController/Collection/Loaded",function(t){InitPivotViewer();var n=e(".pv-filterpanel");n.append("<div class='pv-filterpanel-version'><a href=\"#pv-open-version\">About HTHL5 PivotViewer</a></div>"),n.append('<div id="pv-open-version" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>Version: '+e(PivotViewer)[0].Version+'</p><p>The sources are available on <a href="https://github.com/openlink/html5pivotviewer" target="_blank">github</a></p></div></div>')}),e.subscribe("/PivotViewer/Views/Item/Selected",function(n){if(n.id===undefined||n.id===null||n.id===""){DeselectInfoPanel(),d="",f==2&&t[f].Selected(d.Id),UpdateBookmark();return}var r=GetItem(n.id);if(r!=null){var i=!0;e(".pv-infopanel-heading").empty(),e(".pv-infopanel-heading").append('<a href="'+r.Href+'" target="_blank">'+r.Name+"</a></div>");var s=e(".pv-infopanel-details");s.empty(),r.Description!=undefined&&r.Description.length>0&&s.append("<div class='pv-infopanel-detail-description' style='height:100px;'>"+r.Description+"</div><div class='pv-infopanel-detail-description-more'>More</div>"),r.Id==p[0].Id&&r==p[p.length-1]?(e(".pv-infopanel-controls-navright").hide(),e(".pv-infopanel-controls-navrightdisabled").show(),e(".pv-infopanel-controls-navleft").hide(),e(".pv-infopanel-controls-navleftdisabled").show()):r.Id==p[0].Id?(e(".pv-infopanel-controls-navleft").hide(),e(".pv-infopanel-controls-navleftdisabled").show(),e(".pv-infopanel-controls-navright").show(),e(".pv-infopanel-controls-navrightdisabled").hide()):r.Id==p[p.length-1].Id?(e(".pv-infopanel-controls-navright").hide(),e(".pv-infopanel-controls-navrightdisabled").show(),e(".pv-infopanel-controls-navleft").show(),e(".pv-infopanel-controls-navleftdisabled").hide()):(e(".pv-infopanel-controls-navright").show(),e(".pv-infopanel-controls-navrightdisabled").hide(),e(".pv-infopanel-controls-navleft").show(),e(".pv-infopanel-controls-navleftdisabled").hide());var o=[],u=0;for(var a=0;a<r.Facets.length;a++){var l=!1,c=!1;for(var h=0;h<C.FacetCategories.length;h++)if(C.FacetCategories[h].Name==r.Facets[a].Name&&C.FacetCategories[h].IsMetaDataVisible){l=!0,c=C.FacetCategories[h].IsFilterVisible;break}if(l){o[u]="<div class='pv-infopanel-detail "+(i?"detail-dark":"detail-light")+"'><div class='pv-infopanel-detail-item detail-item-title'>"+r.Facets[a].Name+"</div>";for(var h=0;h<r.Facets[a].FacetValues.length;h++)o[u]+="<div class='pv-infopanel-detail-item detail-item-value"+(c?" detail-item-value-filter":"")+"'>",r.Facets[a].FacetValues[h].Href!=null?o[u]+="<a class='detail-item-link' href='"+r.Facets[a].FacetValues[h].Href+"'>"+r.Facets[a].FacetValues[h].Value+"</a>":o[u]+=r.Facets[a].FacetValues[h].Value,o[u]+="</div>";o[u]+="</div>",u++,i=!i}}s.append(o.join("")),e(".pv-infopanel").fadeIn(),s.css("height",e(".pv-infopanel").height()-(e(".pv-infopanel-controls").height()+e(".pv-infopanel-heading").height()+e(".pv-infopanel-copyright").height())-20+"px"),d=r,v=n.bkt,f==2&&t[f].Selected(d.Id),UpdateBookmark();return}}),e.subscribe("/PivotViewer/Views/Item/Filtered",function(t){if(t==undefined||t==null)return;if(t.ClearFacetFilters==1)for(var n=0,r=C.FacetCategories.length;n<r;n++)if(C.FacetCategories[n].Name==t.Facet&&(C.FacetCategories[n].Type==PivotViewer.Models.FacetType.String||C.FacetCategories[n].Type==PivotViewer.Models.FacetType.DateTime)){var i=e('.pv-facet-facetitem[itemfacet="'+CleanName(t.Facet)+'"]');for(var s=0;s<i.length;s++)e(i[s]).prop("checked",!1)}for(var n=0,r=C.FacetCategories.length;n<r;n++){if(C.FacetCategories[n].Name==t.Facet&&(C.FacetCategories[n].Type==PivotViewer.Models.FacetType.String||C.FacetCategories[n].Type==PivotViewer.Models.FacetType.DateTime))if(t.Values)for(var s=0;s<t.Values.length;s++){var o=e(PivotViewer.Utils.EscapeMetaChars("#pv-facet-item-"+CleanName(t.Facet)+"__"+CleanName(t.Values[s]))+" input");o.prop("checked",!0),FacetItemClick(o[0])}else{var o=e(PivotViewer.Utils.EscapeMetaChars("#pv-facet-item-"+CleanName(t.Facet)+"__"+CleanName(t.Item))+" input");o.prop("checked",!0),FacetItemClick(o[0])}if(C.FacetCategories[n].Name==t.Facet&&C.FacetCategories[n].Type==PivotViewer.Models.FacetType.Number){var u=e("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeMetaChars(t.Facet));FacetSliderDrag(u,t.Item,t.MaxRange)}}}),e.subscribe("/PivotViewer/Views/Item/Updated",function(){UpdateBookmark()}),AttachEventHandlers=function(){e(".pv-toolbarpanel-view").on("click",function(e){var t=this.id.substring(this.id.lastIndexOf("-")+1,this.id.length);t!=null&&SelectView(parseInt(t),!1)}),e(".pv-toolbarpanel-sort").on("change",function(t){b=e(".pv-toolbarpanel-sort option:selected").text(),FilterCollection(!1)}),e(".pv-filterpanel-accordion-facet-sort").on("click",function(t){var n=e(this),r=n.text(),i=n.parent().prev().children("a").text(),s=n.attr("customSort");r=="Sort: A-Z"?e(this).text("Sort: Quantity"):r=="Sort: Quantity"&&s==undefined?e(this).text("Sort: A-Z"):r=="Sort: Quantity"?e(this).text("Sort: "+s):e(this).text("Sort: A-Z"),SortFacetItems(i)}),e(".pv-facet-facetitem").on("click",function(e){FacetItemClick(this)}),e(".pv-facet-facetitem-label").on("click",function(t){var n=e(this).prev(),r=e(this.parentElement.parentElement).find(":checked");n.prop("checked")==1&&r.length<=1?n.prop("checked",!1):n.prop("checked",!0);for(var i=r.length-1;i>-1;i-=1)r[i].getAttribute("itemvalue")!=n[0].getAttribute("itemvalue")&&(r[i].checked=!1);FacetItemClick(n[0])}),e(".pv-filterpanel-clearall").on("click",function(t){var n=e(".pv-facet-facetitem:checked");for(var r=0;r<n.length;r++)e(n[r]).prop("checked",!1);var i=e(".pv-filterpanel-numericslider");for(var r=0;r<i.length;r++){var s=e(i[r]),o=s.slider("option","min"),u=s.slider("option","max");s.slider("values",0,o),s.slider("values",1,u),s.prev().prev().html("&nbsp;")}e(".pv-filterpanel-search").val(""),e(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection(!1)}),e(".pv-filterpanel-accordion-heading-clear").on("click",function(t){var n=this.attributes.facetType.value;if(n=="DateTime"){var r=e(this.parentElement).next().find(".pv-facet-facetitem:checked");for(var i=0;i<r.length;i++)e(r[i]).prop("checked",!1)}else if(n=="String"){var r=e(this.parentElement).next().find(".pv-facet-facetitem:checked");for(var i=0;i<r.length;i++)e(r[i]).prop("checked",!1)}else if(n=="Number"){var s=e(this.parentElement).next().find(".pv-filterpanel-numericslider"),o=s.slider("option","min"),u=s.slider("option","max");s.slider("values",0,o),s.slider("values",1,u),s.prev().prev().html("&nbsp;")}FilterCollection(!1),e(this).css("visibility","hidden")}),e(".ui-slider-range").on("mousedown",function(e){}),e(".pv-infopanel-details").on("click",".detail-item-value-filter",function(t){return e.publish("/PivotViewer/Views/Item/Filtered",[{Facet:e(this).parent().children().first().text(),Item:e(this).text(),Values:null,ClearFacetFilters:!0}]),!1}),e(".pv-infopanel-details").on("click",".pv-infopanel-detail-description-more",function(t){var n=e(this),r=e(this).prev();n.text()=="More"?(r.css("height",""),e(this).text("Less")):(r.css("height","100px"),e(this).text("More"))}),e(".pv-infopanel-controls-navleft").on("click",function(n){for(var r=0;r<p.length;r++)if(p[r].Id==d.Id&&p[r].Bucket==v){r>=0&&e.publish("/PivotViewer/Views/Item/Selected",[{id:p[r-1].Id,bkt:p[r-1].Bucket}]);for(var i=0;i<h.length;i++)h[i].facetItem.Id==p[r-1].Id?(h[i].Selected(!0),selectedCol=t[f].GetSelectedCol(h[i],p[r-1].Bucket),selectedRow=t[f].GetSelectedRow(h[i],p[r-1].Bucket),t[f].CentreOnSelectedTile(selectedCol,selectedRow)):h[i].Selected(!1);break}}),e(".pv-infopanel-controls-navright").on("click",function(n){for(var r=0;r<p.length;r++)if(p[r].Id==d.Id&&p[r].Bucket==v){if(r<p.length){e.publish("/PivotViewer/Views/Item/Selected",[{id:p[r+1].Id,bkt:p[r+1].Bucket}]);for(var i=0;i<h.length;i++)h[i].facetItem.Id==p[r+1].Id?(h[i].Selected(!0),selectedCol=t[f].GetSelectedCol(h[i],p[r+1].Bucket),selectedRow=t[f].GetSelectedRow(h[i],p[r+1].Bucket),t[f].CentreOnSelectedTile(selectedCol,selectedRow)):h[i].Selected(!1)}break}}),e(".pv-filterpanel-search").on("keyup",function(t){var n=!1,r=[],i=e(".pv-filterpanel-search-autocomplete"),s=FilterCollection,u=SelectStringFacetItem;i.empty();if(t.keyCode==27){e(t.target).blur();return}for(var a=0,f=o.length;a<f;a++){var l=o[a].Value.toLowerCase();l.indexOf(t.target.value.toLowerCase())>=0&&e.inArray(l,r)==-1&&(r.push(l),i.append('<span facet="'+o[a].Facet+'">'+o[a].Value+"</span>"),t.keyCode==13&&(SelectStringFacetItem(CleanName(o[a].Facet),CleanName(o[a].Value)),n=!0))}e(".pv-filterpanel-search-autocomplete > span").on("mousedown",function(t){t.preventDefault(),e(".pv-filterpanel-search").val(t.target.textContent),e(".pv-filterpanel-search-autocomplete").hide(),u(CleanName(t.target.attributes[0].value),CleanName(t.target.textContent)),s()}),r.length>0&&i.show(),n&&FilterCollection(!1)}),e(".pv-filterpanel-search").on("blur",function(t){t.target.value="",e(".pv-filterpanel-search-autocomplete").hide()});var n=e(".pv-viewarea-canvas");n.on("mouseup",function(t){var n=e(this).offset(),r=t.clientX-n.left,i=t.clientY-n.top;(!S||S.x==0&&S.y==0)&&e.publish("/PivotViewer/Views/Canvas/Click",[{x:r,y:i}]),E=null,S=!1}),n.on("mouseout",function(e){E=null,S=!1}),n.on("mousedown",function(t){var n=e(this).offset(),r=t.clientX-n.left,i=t.clientY-n.top;E={x:r,y:i}}),n.on("mousemove",function(t){var n=e(this).offset(),r=t.clientX-n.left,i=t.clientY-n.top;E==null?e.publish("/PivotViewer/Views/Canvas/Hover",[{x:r,y:i}]):(S={x:r-E.x,y:i-E.y},E={x:r,y:i},e.publish("/PivotViewer/Views/Canvas/Drag",[S]))}),n.on("mousewheel",function(t,n){var r=e(this).offset(),i=t.clientX-r.left,s=t.clientY-r.top;c.SetQuarticEasingOut(),c.DrawHelpers([{x:i,y:s}]);var o=e(".pv-toolbarpanel-zoomslider").slider("option","value");n>0?o=o<5?5:o+5:n<0&&(o-=5),o=Math.max(0,Math.min(100,o)),e(".pv-toolbarpanel-zoomslider").slider("option","value",o)}),n.on("touchstart",function(t){var n=t.originalEvent,r=e(this).offset(),i=n.touches[0].pageX-r.left,s=n.touches[0].pageY-r.top;E={x:i,y:s}}),n.on("touchmove",function(t){try{var n=t.originalEvent;t.preventDefault();if(n.touches.length>1){t.preventDefault();var r=1e7,i=1e7,s=0,o=0,u=[];for(var a=0;a<n.touches.length;a++)u.push({x:n.touches[a].pageX,y:n.touches[a].pageY}),n.touches[a].pageX<r&&(r=n.touches[a].pageX),n.touches[a].pageX>s&&(s=n.touches[a].pageX),n.touches[a].pageY<i&&(i=n.touches[a].pageY),n.touches[a].pageY>o&&(o=n.touches[a].pageY);var f=(r+s)/2,l=(i+o)/2;c.SetLinearEasingBoth(),u.push({x:f,y:l}),c.DrawHelpers(u),c.DrawHelperText("Scale: "+n.scale),e.publish("/PivotViewer/Views/Canvas/Zoom",[{x:f,y:l,scale:n.scale}]);return}var h=e(this).offset(),p=n.touches[0].pageX-h.left,d=n.touches[0].pageY-h.top;S={x:p-E.x,y:d-E.y},E={x:p,y:d},e.publish("/PivotViewer/Views/Canvas/Drag",[S])}catch(v){Debug.Log(v.message)}}),n.on("touchend",function(t){var n=t.originalEvent;if(n.touches.length==1&&E==null){var r=e(this).offset(),i=n.touches[0].pageX-r.left,s=n.touches[0].pageY-r.top;(!S||S.x==0&&S.y==0)&&e.publish("/PivotViewer/Views/Canvas/Click",[{x:i,y:s}])}E=null,S=!1;return})},FacetItemClick=function(t){e(t).prop("checked")==1&&e(t.parentElement.parentElement.parentElement).prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"),FilterCollection(!1)},FacetSliderDrag=function(t,n,r){var i=e(t),s=i.slider("option","min"),o=i.slider("option","max");n=="(no info)"&&(n=0),n>s||r<o?(i.parent().find(".pv-filterpanel-numericslider-range-val").text(n+" - "+r),i.slider("values",0,n),i.slider("values",1,r),i.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")):n==s&&r==o&&i.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection(!1)},e.fn.PivotViewer=function(t){if(k[t])return k[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return k.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.PivotViewer")}}(jQuery);