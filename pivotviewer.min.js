//
//  HTML5 PivotViewer
//
//  Collection loader interface - used so that different types of data sources can be used
//
//  Original Code:
//    Copyright (C) 2011 LobsterPot Solutions - http://www.lobsterpot.com.au/
//    enquiries@lobsterpot.com.au
//
//  Enhancements:
//    Copyright (C) 2012 OpenLink Software - http://www.openlinksw.com/
//
//  This software is licensed under the terms of the
//  GNU General Public License v2 (see COPYING)
//
///PivotViewer
var PivotViewer=PivotViewer||{};PivotViewer.Models={},PivotViewer.Models.Loaders={},PivotViewer.Utils={},PivotViewer.Views={};var Debug=Debug||{};(function(e){var t={};e.publish=function(n,r){t[n]&&e.each(t[n],function(){this.apply(e,r||[])})},e.subscribe=function(e,n){return t[e]||(t[e]=[]),t[e].push(n),[e,n]},e.unsubscribe=function(n){var r=n[0];t[r]&&e.each(t[r],function(e){this==n[1]&&t[r].splice(e,1)})}})(jQuery),Debug.Log=function(e){window.console&&window.console.log&&typeof debug!="undefined"&&debug==1&&window.console.log(e)},window.requestAnimFrame=function(e){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),PivotViewer.Utils.EscapeMetaChars=function(e){return e.replace(/\|/gi,"\\|").replace(/\//gi,"\\/").replace(/'/gi,"\\'").replace(/,/gi,"\\,").replace(/:/gi,"\\:").replace(/\(/gi,"\\(").replace(/\)/gi,"\\)").replace(/\+/gi,"\\+").replace(/\+/gi,"\\-").replace(/\+/gi,"\\_").replace(/\+/gi,"\\%")},PivotViewer.Utils.EscapeItemId=function(e){return e.replace(/\s+/gi,"|").replace(/'/gi,"").replace(/\(/gi,"").replace(/\)/gi,"").replace(/\./gi,"")},PivotViewer.Utils.Now=function(){return Date.now?Date.now():(new Date).getTime()},PivotViewer.Utils.Min=function(e){var t=1e6;for(var n=0,r=e.length;n<r;n++)t=t>e[n]?e[n]:t;return t},PivotViewer.Utils.Max=function(e){var t=-1e6;for(var n=0,r=e.length;n<r;n++)t=t<e[n]?e[n]:t;return t},PivotViewer.Utils.Histogram=function(e){if(!e instanceof Array)return null;var t=PivotViewer.Utils.Min(e),n=PivotViewer.Utils.Max(e),r=(Math.floor(Math.pow(2*e.length,1/3))+1)*2;r>10&&(r=10);var i=(n+1-(t-1))/r,s=[];for(var o=0;o<r;o++){var u=t+o*i,a=t+(o+1)*i;s.push([]);for(var f=0,l=e.length;f<l;f++)u<=e[f]&&a>e[f]&&s[o].push(e[f])}return{Histogram:s,Min:t,Max:n,BinCount:r}},function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(n){function o(){!e&&this.init&&this.init.apply(this,arguments)}var r=this.prototype;e=!0;var i=new this;e=!1;for(var s in n)i[s]=typeof n[s]=="function"&&typeof r[s]=="function"&&t.test(n[s])?function(e,t){return function(){var n=this._super;this._super=r[e];var i=t.apply(this,arguments);return this._super=n,i}}(s,n[s]):n[s];return o.prototype=i,o.constructor=o,o.subClass=arguments.callee,o}}(),PivotViewer.Models.Collection=Object.subClass({init:function(){var e="http://schemas.microsoft.com/collection/metadata/2009",t="http://schemas.microsoft.com/livelabs/pivot/collection/2009";this.CollectionName="",this.BrandImage="",this.FacetCategories=[],this.Items=[],this.CXMLBase="",this.ImageBase=""},GetItemById:function(e){for(var t=0;t<this.Items.length;t++)if(this.Items[t].Id==e)return this.Items[t];return null},GetFacetCategoryByName:function(e){for(var t=0;t<this.FacetCategories.length;t++)if(this.FacetCategories[t].Name==e)return this.FacetCategories[t];return null}}),PivotViewer.Models.FacetCategory=Object.subClass({init:function(e,t,n,r,i,s,o){this.Name=e,this.Format=t,this.Type=n!=null&&n!=undefined?n:PivotViewer.Models.FacetType.String,this.IsFilterVisible=r!=null&&r!=undefined?r:!0,this.IsMetaDataVisible=i!=null&&i!=undefined?i:!0,this.IsWordWheelVisible=s!=null&&s!=undefined?s:!0,this.CustomSort}}),PivotViewer.Models.FacetCategorySort=Object.subClass({init:function(e){this.Name=e,this.SortValues=[]}}),PivotViewer.Models.Item=Object.subClass({init:function(e,t,n,r){this.Img=parseInt(e),this.Id=t,this.Href=n,this.Name=r,this.Description,this.Facets=[]}}),PivotViewer.Models.Facet=Object.subClass({init:function(e){this.Name=e,this.FacetValues=[]},AddFacetValue:function(e){this.FacetValues.push(e)}}),PivotViewer.Models.FacetValue=Object.subClass({init:function(e){this.Value=e,this.Href=""}}),PivotViewer.Models.FacetType={String:"String",LongString:"LongString",Number:"Number",DateTime:"DateTime",Link:"Link"},PivotViewer.Models.Loaders.ICollectionLoader=Object.subClass({init:function(){},LoadCollection:function(e){if(!e instanceof PivotViewer.Models.Collection)throw"collection not an instance of PivotViewer.Models.Collection."}}),PivotViewer.Models.Loaders.CXMLLoader=PivotViewer.Models.Loaders.ICollectionLoader.subClass({init:function(e){this.CXMLUri=e},LoadCollection:function(e){var e=e;this._super(e),e.CXMLBase=this.CXMLUri,$.ajax({type:"GET",url:this.CXMLUri,dataType:"xml",success:function(t){Debug.Log("CXML loaded");var n=$(t).find("Collection")[0],r="P";if(n==undefined){$(".pv-loading").remove();var i="";throw i+="Error parsing CXML Collection\r\n\r\n",i+="\r\nPivot Viewer cannot continue until this problem is resolved\r\r",window.alert(i),"Error parsing CXML Collection"}for(var s=0;s<n.attributes.length;s++)if(n.attributes[s].value=="http://schemas.microsoft.com/livelabs/pivot/collection/2009"){r=n.attributes[s].localName!=undefined?n.attributes[s].localName:n.attributes[s].baseName;break}e.CollectionName=$(n).attr("Name"),e.BrandImage=$(n).attr(r+":BrandImage")!=undefined?$(n).attr(r+":BrandImage"):"";var o=$(t).find("FacetCategory");for(var s=0;s<o.length;s++){var u=$(o[s]),a=new PivotViewer.Models.FacetCategory(u.attr("Name"),u.attr("Format"),u.attr("Type"),u.attr(r+":IsFilterVisible")!=undefined?u.attr(r+":IsFilterVisible").toLowerCase()=="true"?!0:!1:!0,u.attr(r+":IsMetaDataVisible")!=undefined?u.attr(r+":IsMetaDataVisible").toLowerCase()=="true"?!0:!1:!0,u.attr(r+":IsWordWheelVisible")!=undefined?u.attr(r+":IsWordWheelVisible").toLowerCase()=="true"?!0:!1:!1),f=u.find(r+"\\:SortOrder"),l=f.find(r+"\\:SortValue");f.length==0&&(f=u.find("SortOrder"),l=f.find("SortValue"));if(f.length==1){var c=new PivotViewer.Models.FacetCategorySort(f.attr("Name"));for(var h=0;h<l.length;h++)c.SortValues.push($(l[h]).attr("Value"));a.CustomSort=c}e.FacetCategories.push(a)}var p=$(t).find("Items");if(p.length==1){e.ImageBase=$(p[0]).attr("ImgBase");var d=$(p[0]).find("Item");if(d.length==0){$(".pv-loading").remove();var i="";i+="There are no items in the CXML Collection\r\n\r\n",window.alert(i)}else for(var s=0;s<d.length;s++){var v=new PivotViewer.Models.Item($(d[s]).attr("Img").replace("#",""),$(d[s]).attr("Id"),$(d[s]).attr("Href"),$(d[s]).attr("Name")),m=$(d[s]).find("Description");m.length==1&&m[0].childNodes.length&&(v.Description=m[0].childNodes[0].nodeValue);var g=$(d[s]).find("Facet");for(var h=0;h<g.length;h++){var y=new PivotViewer.Models.Facet($(g[h]).attr("Name")),b=$(g[h]).children();for(var w=0;w<b.length;w++)if(b[w].nodeType==1){var E=$.trim($(b[w]).attr("Value"));if(E==null){var S=new PivotViewer.Models.FacetValue($(b[w]).attr("Name"));S.Href=$(b[w]).attr("Href"),y.AddFacetValue(S)}else if(b[w].nodeName=="Number"){var S=new PivotViewer.Models.FacetValue(parseFloat(E));y.AddFacetValue(S)}else{var S=new PivotViewer.Models.FacetValue(E);y.AddFacetValue(S)}}v.Facets.push(y)}e.Items.push(v)}}$.publish("/PivotViewer/Models/Collection/Loaded",null)},error:function(e,t,n){$(".pv-loading").remove();var r="";r+="Error loading CXML Collection\r\n\r\n",r=r+"URL        : "+this.url+"\r\n",r=r+"Statuscode : "+e.status+"\r\n",r=r+"Details    : "+n+"\r\n",r+="\r\nPivot Viewer cannot continue until this problem is resolved\r\r",window.alert(r)}})}}),PivotViewer.Views.IPivotViewerView=Object.subClass({init:function(){this.isActive=!1,this.init=!0,this.selected="",this.tiles=[]},Setup:function(e,t,n,r,i){},Filter:function(e,t,n){},GetUI:function(){return""},GetButtonImage:function(){return""},GetButtonImageSelected:function(){return""},GetViewName:function(){return""},Activate:function(){this.isActive=!0},Deactivate:function(){this.isActive=!1}}),PivotViewer.Views.TileBasedView=PivotViewer.Views.IPivotViewerView.subClass({OffsetTiles:function(e,t){for(var n=0;n<this.tiles.length;n++){var r=$.inArray(this.tiles[n].facetItem.Id,this.currentFilter);r>=0&&(this.tiles[n]._locations[0].destinationx+=e,this.tiles[n]._locations[0].destinationy+=t)}},SetInitialTiles:function(e,t,n){var r=t/2,i=n/2;for(var s=0;s<e.length;s++)e[s]._locations[0].x=r,e[s]._locations[0].y=i,e[s].velocityx=0,e[s].velocityy=0,e[s]._locations[0].startx=r,e[s]._locations[0].starty=i,e[s]._locations[0].destinationx=0,e[s]._locations[0].destinationy=0,e[s].width=1,e[s].height=1},GetRowsAndColumns:function(e,t,n,r){var i=.7,s=n*(r-Math.pow(i,2)),o=(t+e*n)*i,u=-1*t*e,a=(-1*o+Math.sqrt(Math.pow(o,2)-4*s*u))/(2*s),f=Math.floor(a*n),l=Math.ceil(t/f),c=Math.floor(e/a);return{Rows:l,Columns:c,TileMaxWidth:a,TileHeight:f}},SetOuterTileDestination:function(e,t,n){var r=n._locations[0].x-e/2,i=n._locations[0].y-t/2,s=i/r,o=Math.atan2(i,r);n._locations[0].destinationx=e*Math.cos(o)+e/2,n._locations[0].destinationy=t*Math.sin(o)+t/2},SortBy:function(e,t,n){var r=function(t){if(n)for(var r=t.facetItem.Facets.length-1;r>-1;r-=1)if(t.facetItem.Facets[r].Name==e&&t.facetItem.Facets[r].FacetValues.length>0)return n(t.facetItem.Facets[r].FacetValues[0].Value);return null};return function(e,n){var i=r(e),s=r(n);return(i<s?-1:i>s?1:0)*[1,-1][+!!t]}}}),PivotViewer.Views.GridView=PivotViewer.Views.TileBasedView.subClass({init:function(){this.Scale=1,this._super();var e=this;$.subscribe("/PivotViewer/Views/Canvas/Click",function(t){if(!e.isActive)return;var n=null,r=0,i=0,s=0,o=0;for(var u=0;u<e.tiles.length;u++)e.tiles[u].Contains(t.x,t.y)?(n=e.tiles[u].facetItem.Id,r=Math.round((e.tiles[u]._locations[0].x-e.currentOffsetX)/e.tiles[u].width),i=Math.round((e.tiles[u]._locations[0].y-e.currentOffsetY)/e.tiles[u].height),e.tiles[u].Selected(!0),tileHeight=e.tiles[u].height,tileWidth=e.tiles[u].height/e.tiles[u]._controller.GetRatio(e.tiles[u].facetItem.Img),tileOrigHeight=e.tiles[u].origheight,tileOrigWidth=e.tiles[u].origwidth,canvasHeight=e.tiles[u].context.canvas.height,canvasWidth=e.tiles[u].context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width())):e.tiles[u].Selected(!1);if(n!=null&&e.selected!=n){tileHeight/canvasHeight>tileWidth/canvasWidth?origProportion=tileOrigHeight/canvasHeight:origProportion=tileOrigWidth/canvasWidth,scale=Math.round(.75/origProportion*2);if(e.selected==""){var a=$(".pv-toolbarpanel-zoomslider").slider("option","value");a=scale,$(".pv-toolbarpanel-zoomslider").slider("option","value",a)}e.selected=n,e.CentreOnSelectedTile(r,i)}else{e.selected=n="",e.currentOffsetX=e.offsetX,e.currentOffsetY=e.offsetY;var a=$(".pv-toolbarpanel-zoomslider").slider("option","value");a=0,$(".pv-toolbarpanel-zoomslider").slider("option","value",a)}$.publish("/PivotViewer/Views/Item/Selected",[n])}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(t){if(!e.isActive||e.selected.length>0)return;for(var n=0;n<e.tiles.length;n++)e.tiles[n].Contains(t.x,t.y)?e.tiles[n].Selected(!0):e.tiles[n].Selected(!1)}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(t){if(!e.isActive)return;var n=e.Scale,r=e.currentWidth,i=e.currentHeight,s=t.scale!=undefined?0:1e3;t.scale!=undefined?t.scale>=1?e.Scale+=t.scale-1:(e.Scale-=t.scale,e.Scale=e.Scale<1?1:e.Scale):t.delta!=undefined&&(e.Scale=t.delta==0?1:e.Scale+t.delta-1),e.Scale==NaN&&(e.Scale=1);var o=(e.width-e.offsetX)*e.Scale,u=(e.height-e.offsetY)*e.Scale;if(o<e.width||e.Scale==1)e.currentOffsetX=e.offsetX,e.currentOffsetY=e.offsetY,e.currentWidth=e.width,e.currentHeight=e.height,e.Scale=1;else{var a=(t.x-e.currentOffsetX)/n*e.Scale,f=(t.y-e.currentOffsetY)/n*e.Scale;e.currentOffsetX=t.x-a,e.currentOffsetY=t.y-f,e.currentWidth=o,e.currentHeight=u}var l=e.GetRowsAndColumns(e.currentWidth-e.offsetX,e.currentHeight-e.offsetY,e.maxRatio,e.currentFilter.length);e.SetVisibleTilePositions(l,e.currentFilter,e.currentOffsetX,e.currentOffsetY,!0,!0,s);if(e.Scale==1&&n!=1){for(var c=0;c<e.tiles.length;c++)e.tiles[c].Selected(!1);e.selected="",$.publish("/PivotViewer/Views/Item/Selected",[e.selected])}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(t){if(!e.isActive)return;var n=t.x,r=t.y,i=!1,s=!1;e.currentOffsetX+=n,e.currentOffsetY+=r,n>0&&e.currentOffsetX>e.offsetX&&(e.currentOffsetX-=n,i=!0),r>0&&e.currentOffsetY>e.offsetY&&(e.currentOffsetY-=r,s=!0),e.currentOffsetX<e.offsetX&&e.currentWidth==e.width&&(e.currentOffsetX-=n,i=!0),n<0&&e.currentOffsetX<-1*(e.currentWidth-e.width)&&(e.currentOffsetX-=n,i=!0),e.currentOffsetY<e.offsetY&&e.currentHeight==e.height&&(e.currentOffsetY-=r,s=!0),r<0&&e.currentOffsetY-e.offsetY<-1*(e.currentHeight-e.height)&&(e.currentOffsetY-=r,s=!0);if(i&&s)return;i?e.OffsetTiles(0,r):s?e.OffsetTiles(n,0):e.OffsetTiles(n,r)})},Setup:function(e,t,n,r,i){this.width=e,this.height=t,this.offsetX=n,this.offsetY=r,this.maxRatio=i,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY},Filter:function(e,t,n){var r=this;if(!Modernizr.canvas)return;Debug.Log("Grid View Filtered: "+t.length),this.tiles=e,this.init&&this.SetInitialTiles(this.tiles,this.width,this.height);for(var i=0;i<this.tiles.length;i++)while(this.tiles[i]._locations.length>1)this.tiles[i]._locations.pop();this.tiles=this.tiles.sort(this.SortBy(n,!1,function(e){return $.isNumeric(e)?e:e.toUpperCase()})),this.currentFilter=t;var s=0;Debug.Log("this.currentWidth: "+this.currentWidth+" this.width: "+this.width);var o=$(".pv-toolbarpanel-zoomslider").slider("option","value");if(o>0){this.selected=selectedItem="",this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-toolbarpanel-zoomslider").slider("option","value",1);var u=this.GetRowsAndColumns(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,this.tiles.length),a=[];for(var f=0;f<this.tiles.length;f++)this.tiles[f].origwidth=u.TileHeight/this.tiles[f]._controller.GetRatio(this.tiles[f].facetItem.Img),this.tiles[f].origheight=u.TileHeight,a.push(this.tiles[f].facetItem.Id);this.SetVisibleTilePositions(u,a,this.currentOffsetX,this.currentOffsetY,!0,!1,1e3),s=1e3}setTimeout(function(){for(var e=0;e<r.tiles.length;e++){r.tiles[e]._locations[0].startx=r.tiles[e]._locations[0].x,r.tiles[e]._locations[0].starty=r.tiles[e]._locations[0].y,r.tiles[e].startwidth=r.tiles[e].width,r.tiles[e].startheight=r.tiles[e].height;var n=$.inArray(r.tiles[e].facetItem.Id,t);n<0&&(r.SetOuterTileDestination(r.width,r.height,r.tiles[e]),r.tiles[e].start=PivotViewer.Utils.Now(),r.tiles[e].end=r.tiles[e].start+1e3)}r.maxRatio=r.tiles[0]._controller.GetRatio(r.tiles[0].facetItem.Img);for(var e=0;e<r.tiles.length;e++){var n=$.inArray(r.tiles[e].facetItem.Id,t);n>=0&&r.tiles[e]._controller.GetRatio(r.tiles[e].facetItem.Img)<r.maxRatio&&(r.maxRatio=r.tiles[e]._controller.GetRatio(r.tiles[e].facetItem.Img))}var i=t.length==r.tiles.length?0:500;setTimeout(function(){var e=r.GetRowsAndColumns(r.width-r.offsetX,r.height-r.offsetY,r.maxRatio,r.currentFilter.length);for(var t=0;t<r.tiles.length;t++)r.tiles[t].origwidth=e.TileHeight/r.tiles[t]._controller.GetRatio(r.tiles[t].facetItem.Img),r.tiles[t].origheight=e.TileHeight;r.SetVisibleTilePositions(e,r.currentFilter,r.offsetX,r.offsetY,!1,!1,1e3)},i)},s),this.init=!1},GetUI:function(){return Modernizr.canvas?"":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"Content/images/GridView.png"},GetButtonImageSelected:function(){return"Content/images/GridViewSelected.png"},GetViewName:function(){return"Grid View"},SetVisibleTilePositions:function(e,t,n,r,i,s,o){var u=s?this.rowscols.Columns:e.Columns;s||(this.rowscols=e);var a=0,f=0;for(var l=0;l<this.tiles.length;l++){var c=$.inArray(this.tiles[l].facetItem.Id,t);c>=0&&(i&&(this.tiles[l]._locations[0].startx=this.tiles[l]._locations[0].x,this.tiles[l]._locations[0].starty=this.tiles[l]._locations[0].y,this.tiles[l].startwidth=this.tiles[l].width,this.tiles[l].startheight=this.tiles[l].height),this.tiles[l].destinationwidth=e.TileMaxWidth,this.tiles[l].destinationheight=e.TileHeight,this.tiles[l]._locations[0].destinationx=a*e.TileMaxWidth+n,this.tiles[l]._locations[0].destinationy=f*e.TileHeight+r,this.tiles[l].start=PivotViewer.Utils.Now(),this.tiles[l].end=this.tiles[l].start+o,a==u-1?(a=0,f++):a++)}},GetSelectedCol:function(e){var t=this;return selectedCol=Math.round((e._locations[0].x-t.currentOffsetX)/e.width),selectedCol},GetSelectedRow:function(e){var t=this;return selectedRow=Math.round((e._locations[0].y-t.currentOffsetY)/e.height),selectedRow},CentreOnSelectedTile:function(e,t){var n=this,r;for(var i=0;i<n.tiles.length;i++)if(n.tiles[i].IsSelected()){r=n.tiles[i];break}offsetX=r._locations[0].x,offsetY=r._locations[0].y;var s=n.GetRowsAndColumns(n.currentWidth-n.offsetX,n.currentHeight-n.offsetY,n.maxRatio,n.currentFilter.length);n.currentOffsetX=s.TileMaxWidth*e*-1+n.width/2-s.TileMaxWidth/2,n.currentOffsetY=s.TileHeight*t*-1+n.height/2-s.TileHeight/2,n.SetVisibleTilePositions(s,n.currentFilter,n.currentOffsetX,n.currentOffsetY,!0,!0,1e3)}}),PivotViewer.Views.GraphView=PivotViewer.Views.TileBasedView.subClass({init:function(){this._super();var e=this;this.buckets=[],this.Scale=1,this.canvasHeightUIAdjusted=0,this.titleSpace=62,$.subscribe("/PivotViewer/Views/Canvas/Click",function(t){if(!e.isActive)return;var n=null,r=0,i=0,s=!1,o=!1,u=0,a=0;for(var f=0;f<e.tiles.length;f++)e.tiles[f].Contains(t.x,t.y)?(n=e.tiles[f].facetItem.Id,selectedX=e.tiles[f]._locations[0].x,selectedY=e.tiles[f]._locations[0].y,e.tiles[f].Selected(!0),s=!0,r=Math.round((e.tiles[f]._locations[0].x-e.currentOffsetX)/e.tiles[f].width),i=Math.round((e.canvasHeightUIAdjusted-e.tiles[f]._locations[0].y)/e.tiles[f].height),tileHeight=e.tiles[f].height,tileWidth=e.tiles[f].height/e.tiles[f]._controller.GetRatio(e.tiles[f].facetItem.Img),tileOrigHeight=e.tiles[f].origheight,tileOrigWidth=e.tiles[f].origwidth,canvasHeight=e.tiles[f].context.canvas.height,canvasWidth=e.tiles[f].context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width())):e.tiles[f].Selected(!1);e.selected!=null&&e.selected!=""&&!s&&(o=!0);if(n!=null&&e.selected!=n){tileHeight/canvasHeight>tileWidth/canvasWidth?origProportion=tileOrigHeight/canvasHeight:origProportion=tileOrigWidth/canvasWidth,scale=Math.round(.75/origProportion*2);if(e.selected==""){var l=$(".pv-toolbarpanel-zoomslider").slider("option","value");l=scale,$(".pv-toolbarpanel-zoomslider").slider("option","value",l)}e.selected=n,e.CentreOnSelectedTile(r,i),$(".pv-viewarea-graphview-overlay div").fadeOut("slow")}else{e.selected=n="",e.currentOffsetX=e.offsetX,e.currentOffsetY=e.offsetY;var l=$(".pv-toolbarpanel-zoomslider").slider("option","value");l=0,$(".pv-toolbarpanel-zoomslider").slider("option","value",l),$(".pv-viewarea-graphview-overlay div").fadeIn("slow")}$.publish("/PivotViewer/Views/Item/Selected",[n]);if(!s&&!o){var c=Math.floor((t.x-e.offsetX)/e.columnWidth);$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:e.sortFacet,Item:e.buckets[c].startRange,MaxRange:e.buckets[c].endRange}])}}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(t){if(!e.isActive)return;$(".pv-viewarea-graphview-overlay-bucket").removeClass("graphview-bucket-hover");var n=Math.floor((t.x-e.offsetX)/e.columnWidth),r=$("#pv-viewarea-graphview-overlay-bucket-"+n);r.addClass("graphview-bucket-hover");for(var i=0;i<e.tiles.length;i++)e.tiles[i].Contains(t.x,t.y)?e.tiles[i].Selected(!0):e.tiles[i].Selected(!1)}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(t){if(!e.isActive)return;var n=e.Scale,r=e.currentWidth,i=e.currentHeight,s=t.scale!=undefined?0:1e3;t.scale!=undefined?t.scale>=1?e.Scale+=t.scale-1:(e.Scale-=t.scale,e.Scale=e.Scale<1?1:e.Scale):t.delta!=undefined&&(e.Scale=t.delta==0?1:e.Scale+t.delta-1),e.Scale==NaN&&(e.Scale=1);var o=(e.width-e.offsetX)*e.Scale,u=(e.height-e.offsetY-e.titleSpace)*e.Scale;if(o<e.width||e.Scale==1)e.currentOffsetX=e.offsetX,e.currentOffsetY=e.offsetY,e.currentWidth=e.width,e.currentHeight=e.height,e.canvasHeightUIAdjusted=e.height-e.titleSpace,e.columnWidth=(e.width-e.offsetX)/e.buckets.length,e.Scale=1,$(".pv-viewarea-graphview-overlay div").fadeIn("slow");else{e.currentOffsetX=t.x-(t.x-e.currentOffsetX)/n*e.Scale;var a=(t.y-e.currentOffsetY)/n*e.Scale;e.currentOffsetY=t.y-a,e.canvasHeightUIAdjusted=u-e.titleSpace/n*e.Scale,e.currentWidth=o,e.currentHeight=u,e.columnWidth=o/e.buckets.length,$(".pv-viewarea-graphview-overlay div").fadeOut("slow")}var f=e.GetRowsAndColumns(e.columnWidth-2,e.canvasHeightUIAdjusted-e.currentOffsetY,e.maxRatio,e.bigCount);e.SetVisibleTileGraphPositions(f,e.currentOffsetX,e.currentOffsetY,!0,!0);if(e.Scale==1&&n!=1){for(var l=0;l<e.tiles.length;l++)e.tiles[l].Selected(!1);e.selected="",$.publish("/PivotViewer/Views/Item/Selected",[e.selected])}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(t){if(!e.isActive)return;var n=t.x,r=t.y,i=!1,s=!1;e.currentOffsetX+=n,e.currentOffsetY+=r,n>0&&e.currentOffsetX>e.offsetX&&(e.currentOffsetX-=n,i=!0),r>0&&e.currentOffsetY+e.canvasHeightUIAdjusted>e.currentHeight+e.offsetY&&(e.currentOffsetY-=r,s=!0),e.currentOffsetX<e.offsetX&&e.currentWidth==e.width&&(e.currentOffsetX-=n,i=!0),n<0&&e.currentOffsetX<-1*(e.currentWidth-e.width)&&(e.currentOffsetX-=n,i=!0),e.currentOffsetY<e.offsetY&&e.currentHeight==e.height&&(e.currentOffsetY-=r,s=!0),r<0&&e.currentOffsetY-e.offsetY<-1*(e.currentHeight-e.height)&&(e.currentOffsetY-=r,s=!0);if(i&&s)return;i?e.OffsetTiles(0,r):s?e.OffsetTiles(n,0):e.OffsetTiles(n,r)})},Setup:function(e,t,n,r,i){this.width=e,this.height=t,this.offsetX=n,this.offsetY=r,this.maxRatio=i,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,this.rowscols=null,this.bigCount=0},Filter:function(e,t,n){var r=this;if(!Modernizr.canvas)return;Debug.Log("Graph View Filtered: "+t.length),this.sortFacet=n,this.tiles=e,this.tiles=e.sort(this.SortBy(this.sortFacet,!1,function(e){return $.isNumeric(e)?e:e.toUpperCase()})),this.currentFilter=t,this.buckets=this.Bucketize(e,t,this.sortFacet),this.columnWidth=(this.width-this.offsetX)/this.buckets.length,this.canvasHeightUIAdjusted=this.height-this.titleSpace;var i=[];this.bigCount=0;for(var s=0;s<this.buckets.length;s++){var o=s%2==0?"graphview-bucket-dark":"graphview-bucket-light";i[s]="<div class='pv-viewarea-graphview-overlay-bucket "+o+"' id='pv-viewarea-graphview-overlay-bucket-"+s+"' style='width: "+(Math.floor(this.columnWidth)-4)+"px; height:"+(this.height-2)+"px; left:"+(s*this.columnWidth-2)+"px;'>",this.buckets[s].startRange==this.buckets[s].endRange?i[s]+="<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[s].startRange+"</div></div>":i[s]+="<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[s].startRange+"<br/>to<br/>"+this.buckets[s].endRange+"</div></div>",this.bigCount<this.buckets[s].Ids.length&&(this.bigCount=this.buckets[s].Ids.length)}var u=$(".pv-viewarea-graphview-overlay");u.css("left",this.offsetX+"px"),$(".pv-viewarea-graphview-overlay div").fadeOut("slow",function(){$(this).remove()}),u.append(i.join("")),$(".pv-viewarea-graphview-overlay div").fadeIn("slow");for(var s=0;s<this.tiles.length;s++){this.tiles[s]._locations[0].startx=this.tiles[s]._locations[0].x,this.tiles[s]._locations[0].starty=this.tiles[s]._locations[0].y,this.tiles[s].startwidth=this.tiles[s].width,this.tiles[s].startheight=this.tiles[s].height;var a=$.inArray(this.tiles[s].facetItem.Id,t);a<0&&(this.SetOuterTileDestination(this.width,this.height,this.tiles[s]),this.tiles[s].start=PivotViewer.Utils.Now(),this.tiles[s].end=this.tiles[s].start+1e3)}r.maxRatio=r.tiles[0]._controller.GetRatio(r.tiles[0].facetItem.Img);for(var s=0;s<r.tiles.length;s++){var a=$.inArray(r.tiles[s].facetItem.Id,t);a>=0&&r.tiles[s]._controller.GetRatio(r.tiles[s].facetItem.Img)<r.maxRatio&&(r.maxRatio=r.tiles[s]._controller.GetRatio(r.tiles[s].facetItem.Img))}var f=t.length==this.tiles.length?0:500;setTimeout(function(){r.rowscols=r.GetRowsAndColumns(r.columnWidth-2,r.canvasHeightUIAdjusted-r.offsetY,r.maxRatio,r.bigCount);for(var e=0;e<r.tiles.length;e++)r.tiles[e].origwidth=r.rowscols.TileHeight/r.tiles[e]._controller.GetRatio(r.tiles[e].facetItem.Img),r.tiles[e].origheight=r.rowscols.TileHeight;r.SetVisibleTileGraphPositions(r.rowscols,r.offsetX,r.offsetY,!1,!1)},f),this.init=!1},GetUI:function(){return Modernizr.canvas?"<div class='pv-viewarea-graphview-overlay'></div>":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"Content/images/GraphView.png"},GetButtonImageSelected:function(){return"Content/images/GraphViewSelected.png"},GetViewName:function(){return"Graph View"},SetVisibleTileGraphPositions:function(e,t,n,r,i){var s=i?this.rowscols.Columns:e.Columns;i||(this.rowscols=e);var o=[],u=[];for(var a=0;a<this.tiles.length;a++){this.tiles[a].firstFilterItemDone=!1;while(this.tiles[a]._locations.length>1)this.tiles[a]._locations.pop()}for(var f=0;f<this.buckets.length;f++){var l=0,c=0;for(var h=0,p=this.tiles.length;h<p;h++)$.inArray(this.tiles[h].facetItem.Id,this.buckets[f].Ids)>=0&&(this.tiles[h].firstFilterItemDone?(tileLocation=new PivotViewer.Views.TileLocation,tileLocation.startx=this.tiles[h]._locations[0].startx,tileLocation.starty=this.tiles[h]._locations[0].starty,tileLocation.x=this.tiles[h]._locations[0].x,tileLocation.y=this.tiles[h]._locations[0].y,tileLocation.destinationx=f*this.columnWidth+l*e.TileMaxWidth+t,tileLocation.destinationy=this.canvasHeightUIAdjusted-e.TileHeight-c*e.TileHeight+n,this.tiles[h]._locations.push(tileLocation)):(r&&(this.tiles[h]._locations[0].startx=this.tiles[h]._locations[0].x,this.tiles[h]._locations[0].starty=this.tiles[h]._locations[0].y,this.tiles[h].startwidth=this.tiles[h].width,this.tiles[h].startheight=this.tiles[h].height),this.tiles[h].destinationwidth=e.TileMaxWidth,this.tiles[h].destinationheight=e.TileHeight,this.tiles[h]._locations[0].destinationx=f*this.columnWidth+l*e.TileMaxWidth+t,this.tiles[h]._locations[0].destinationy=this.canvasHeightUIAdjusted-e.TileHeight-c*e.TileHeight+n,this.tiles[h].start=PivotViewer.Utils.Now(),this.tiles[h].end=this.tiles[h].start+1e3,this.tiles[h].firstFilterItemDone=!0),l==s-1?(l=0,c++):l++)}},Bucketize:function(e,t,n){var r=[];for(var i=0;i<e.length;i++)if($.inArray(e[i].facetItem.Id,t)>=0){var s=!1;for(var o=0;o<e[i].facetItem.Facets.length;o++)if(e[i].facetItem.Facets[o].Name==n&&e[i].facetItem.Facets[o].FacetValues.length>0)for(var u=0;u<e[i].facetItem.Facets[o].FacetValues.length;u++){var a=e[i].facetItem.Facets[o].FacetValues[u].Value,f=!1;for(var l=0;l<r.length;l++)r[l].startRange==a&&($.inArray(e[i].facetItem.Id,r[l].Ids)<0&&r[l].Ids.push(e[i].facetItem.Id),f=!0);f||r.push({startRange:a,endRange:a,Ids:[e[i].facetItem.Id]}),s=!0}if(!s){var a="(no info)",f=!1;for(var l=0;l<r.length;l++)r[l].startRange==a&&(r[l].Ids.push(e[i].facetItem.Id),f=!0);f||r.push({startRange:a,endRange:a,Ids:[e[i].facetItem.Id]})}}var c=0;while(r.length>8)if(c<r.length-1){r[c].endRange=r[c+1].endRange;for(var i=0;i<r[c+1].Ids.length;i++)$.inArray(r[c+1].Ids[i],r[c].Ids)<0&&r[c].Ids.push(r[c+1].Ids[i]);r.splice(c+1,1),c++}else c=0;return r},GetSelectedCol:function(e){var t=this;return selectedCol=Math.round((e._locations[0].x-t.currentOffsetX)/e.width),selectedCol},GetSelectedRow:function(e){var t=this;return selectedRow=Math.round((e._locations[0].y-t.currentOffsetY)/e.height),selectedRow},CentreOnSelectedTile:function(e,t){var n=this,r;for(var i=0;i<n.tiles.length;i++)if(n.tiles[i].IsSelected()){r=n.tiles[i];break}offsetX=r._locations[0].x,offsetY=r._locations[0].y;var s=n.GetRowsAndColumns(n.columnWidth-2,n.canvasHeightUIAdjusted-n.currentOffsetY,n.maxRatio,n.bigCount),o=0,u=n.columnWidth-s.TileMaxWidth*s.Columns,a=Math.floor(e/s.Columns);u>0&&(o=a*u),n.currentOffsetX=s.TileMaxWidth*e*-1+n.width/2-s.TileMaxWidth/2+o,n.currentOffsetY=n.canvasHeightUIAdjusted-s.TileHeight*t+n.height/2-s.TileHeight/2,n.SetVisibleTileGraphPositions(s,n.currentOffsetX,n.currentOffsetY,!0,!0)}}),PivotViewer.Views.IImageController=Object.subClass({init:function(){},Setup:function(e){},GetImagesAtLevel:function(e,t){},Width:0,Height:0}),PivotViewer.Views.LoadImageSetHelper=Object.subClass({init:function(){this._images=[],this._loaded=!1},LoadImages:function(e){var t=this;for(var n=0;n<e.length;n++){var r=new Image;r.src=e[n],r.onload=function(){t._loaded=!0},this._images.push(r)}},GetImages:function(){return this._images},IsLoaded:function(){return this._loaded}}),PivotViewer.Views.DeepZoomImageController=PivotViewer.Views.IImageController.subClass({init:function(){this._items=[],this._collageItems=[],this._baseUrl="",this._collageMaxLevel=0,this._tileSize=256,this._format="",this._ratio=1,this.MaxRatio=1,this._zooming=!1;var e=this;$.subscribe("/PivotViewer/ImageController/Zoom",function(t){e._zooming=t})},Setup:function(e){this._baseUrl=e.substring(0,e.lastIndexOf("/")),this._collageUrl=e.substring(e.lastIndexOf("/")+1).replace(".xml","_files");var t=this;$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){var n=$(e).find("Collection");t._tileSize=$(n).attr("TileSize"),t._format=$(n).attr("Format"),t._collageMaxLevel=$(n).attr("MaxLevel");var r=$(e).find("I");if(r.length==0)return;var s=$(r[0]).find("Size");if(s.length>0){t.MaxWidth=parseInt(s.attr("Width")),t.Height=parseInt(s.attr("Height")),t.MaxRatio=t.Height/t.MaxWidth;for(i=0;i<r.length;i++){itemSize=$(r[i]).find("Size");var o=parseInt(itemSize.attr("Width")),u=parseInt(itemSize.attr("Height")),a=o>u?o:u,f=Math.ceil(Math.log(a)/Math.log(2));t._ratio=u/o;var l=$(r[i]).attr("Source"),c=$(r[i]).attr("Id"),h=$(r[i]).attr("N"),p=l.substring(l.lastIndexOf("/")+1).replace(/\.xml/gi,"").replace(/\.dzi/gi,""),d=l.substring(0,l.lastIndexOf("/"));d.length>0&&(d+="/"),t._items.push(new PivotViewer.Views.DeepZoomItem(c,p,h,d,t._ratio,o,u,f)),o>t.MaxWidth&&(t.MaxWidth=o),t._ratio<t.MaxRatio&&(t.MaxRatio=t._ratio)}}$.publish("/PivotViewer/ImageController/Collection/Loaded",null)},error:function(e,t,n){$(".pv-loading").remove();var r="";r+="Error loading from DeepZoom Cache\r\n\r\n",r=r+"URL        : "+this.url+"\r\n",r=r+"Statuscode : "+e.status+"\r\n",r=r+"Details    : "+n+"\r\n",r+="\r\nPivot Viewer cannot continue until this problem is resolved\r\r",window.alert(r)}})},GetImagesAtLevel:function(e,t){t=t<=0?6:t;for(var n=0;n<this._items.length;n++)if(this._items[n].ItemId==e){t=t>this._items[n].MaxLevel?this._items[n].MaxLevel:t;var r=this._items[n].DZN.toString(2),i="",s="";for(var o=0;o<r.length;o++)o%2==0?i+=r[o]:s+=r[o];dzCol=parseInt(i,2),dzRow=parseInt(s,2);if(this._items[n].Levels!=undefined&&this._items[n].Levels.length!=0||!!this._zooming){if(this._items[n].Levels.length<t&&!this._zooming){var u=this.GetImageList(n,this._baseUrl+"/"+this._items[n].BasePath+this._items[n].DZId+"_files/"+t+"/",t),a=new PivotViewer.Views.LoadImageSetHelper;a.LoadImages(u),this._items[n].Levels.splice(t,0,a)}for(var f=t;f>-1;f--){if(this._items[n].Levels[f]!=undefined&&this._items[n].Levels[f].IsLoaded())return this._items[n].Levels[f].GetImages();if(f==t&&this._items[n].Levels[f]==undefined&&!this._zooming){var u=this.GetImageList(n,this._baseUrl+"/"+this._items[n].BasePath+this._items[n].DZId+"_files/"+f+"/",f),a=new PivotViewer.Views.LoadImageSetHelper;a.LoadImages(u),this._items[n].Levels.splice(f,0,a)}}return null}var u=this.GetImageList(n,this._baseUrl+"/"+this._items[n].BasePath+this._items[n].DZId+"_files/6/",6),a=new PivotViewer.Views.LoadImageSetHelper;return a.LoadImages(u),this._items[n].Levels.push(a),null}return null},GetImageList:function(e,t,n){var r=[],i=this._tileSize,s=this._format,o=this._items[e].Ratio,u=this._items[e].Height,a=this._items[e].MaxLevel,f=Math.ceil(u/o/Math.pow(2,a-n)),l=Math.ceil(u/Math.pow(2,a-n)),c=Math.ceil(f/i),h=Math.ceil(l/i);for(var p=0
;p<c;p++)for(var d=0;d<h;d++)r.push(t+p+"_"+d+"."+s);return r},GetWidthForImage:function(e,t){for(var n=0;n<this._items.length;n++)if(this._items[n].ItemId==e)return Math.floor(t/this._items[n].Ratio)},GetDzi:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return dziName=this._baseUrl+"/"+this._items[t].BasePath+this._items[t].DZId+".dzi",dziName},GetMaxLevel:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return this._items[t].MaxLevel},GetWidth:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return this._items[t].Width},GetHeight:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return this._items[t].Height},GetRatio:function(e){for(var t=0;t<this._items.length;t++)if(this._items[t].ItemId==e)return this._items[t].Ratio}}),PivotViewer.Views.DeepZoomItem=Object.subClass({init:function(e,t,n,r,i,s,o,u){this.ItemId=e,this.DZId=t,this.DZN=parseInt(n),this.BasePath=r,this.Levels=[],this.Ratio=i,this.Width=s,this.Height=o,this.MaxLevel=u}}),PivotViewer.Views.TileController=Object.subClass({init:function(e){this._tiles=[],this._helpers=[],this._helperText="",this._easing=new Easing.Easer({type:"circular",side:"both"}),this._imageController=e},initTiles:function(e,t,n){for(var r=0;r<e.length;r++){var i=new PivotViewer.Views.Tile(this._imageController);i.facetItem=e[r],i.CollectionRoot=t.replace(/\\/gi,"/").replace(/\.xml/gi,""),this._canvasContext=n,i.context=this._canvasContext,tileLocation=new PivotViewer.Views.TileLocation,i._locations.push(tileLocation),this._tiles.push(i)}return this._tiles},AnimateTiles:function(){var e=this;this._started=!0;var t=null,n=!1;if(this._tiles.length>0&&this._tiles[0].context!=null){t=this._tiles[0].context;var r=!1;for(var i=0;i<this._tiles.length;i++)for(l=0;l<this._tiles[i]._locations.length;l++){var s=PivotViewer.Utils.Now()-this._tiles[i].start,o=this._tiles[i].end-this._tiles[i].start;if(s<=o){if(this._tiles[i]._locations[l].x!=this._tiles[i]._locations[l].destinationx||this._tiles[i]._locations[l].y!=this._tiles[i]._locations[l].destinationy)r=!0;this._tiles[i]._locations[l].x=this._easing.ease(s,this._tiles[i]._locations[l].startx,this._tiles[i]._locations[l].destinationx-this._tiles[i]._locations[l].startx,o),this._tiles[i]._locations[l].y=this._easing.ease(s,this._tiles[i]._locations[l].starty,this._tiles[i]._locations[l].destinationy-this._tiles[i]._locations[l].starty,o);if(this._tiles[i].width!=this._tiles[i].destinationWidth||this._tiles[i].height!=this._tiles[i].destinationHeight)r=!0;this._tiles[i].width=this._easing.ease(s,this._tiles[i].startwidth,this._tiles[i].destinationwidth-this._tiles[i].startwidth,o),this._tiles[i].height=this._easing.ease(s,this._tiles[i].startheight,this._tiles[i].destinationheight-this._tiles[i].startheight,o)}else this._tiles[i]._locations[l].x=this._tiles[i]._locations[l].destinationx,this._tiles[i]._locations[l].y=this._tiles[i]._locations[l].destinationy,this._tiles[i].width=this._tiles[i].destinationwidth,this._tiles[i].height=this._tiles[i].destinationheight;this._tiles[i]._locations[l].destinationx+this._tiles[i].destinationwidth<0||this._tiles[i]._locations[l].destinationx>t.canvas.width||this._tiles[i]._locations[l].destinationy+this._tiles[i].destinationheight<0||this._tiles[i]._locations[l].destinationy>t.canvas.height?this._tiles[i].destinationVisible=!1:this._tiles[i].destinationVisible=!0}}this._isZooming!=r&&(this._isZooming=r,$.publish("/PivotViewer/ImageController/Zoom",[this._isZooming])),t.clearRect(0,0,t.canvas.width,t.canvas.height);for(var i=0;i<this._tiles.length;i++)this._tiles[i]._locations[0].x+this._tiles[i].width>0&&this._tiles[i]._locations[0].x<t.canvas.width&&this._tiles[i]._locations[0].y+this._tiles[i].height>0&&this._tiles[i]._locations[0].y<t.canvas.height&&(n?this._tiles[i].DrawEmpty():this._tiles[i].Draw());if(!!this._breaks){this._started=!1;return}requestAnimFrame(function(){e.AnimateTiles()})},BeginAnimation:function(){!this._started&&this._tiles.length>0&&(this._breaks=!1,this.AnimateTiles())},StopAnimation:function(){this._breaks=!0},SetLinearEasingBoth:function(){this._easing=new Easing.Easer({type:"linear",side:"both"})},SetCircularEasingBoth:function(){this._easing=new Easing.Easer({type:"circular",side:"both"})},SetQuarticEasingOut:function(){this._easing=new Easing.Easer({type:"quartic",side:"out"})},GetMaxTileRatio:function(){return this._imageController.MaxRatio},DrawHelpers:function(e){this._helpers=e},DrawHelperText:function(e){this._helperText=e}}),PivotViewer.Views.Tile=Object.subClass({init:function(e){if(!(this instanceof PivotViewer.Views.Tile))return new PivotViewer.Views.Tile(e);this._controller=e,this._imageLoaded=!1,this._selected=!1,this._level=0,this._images=null,this._locations=[]},IsSelected:function(){return this._selected},Draw:function(){if(this.destinationVisible){var e=this.width>this.height?this.width:this.height,t=Math.ceil(Math.log(e)/Math.log(2));if(t==Infinity||t==-Infinity)t=0;this._level=t,this._images=this._controller.GetImagesAtLevel(this.facetItem.Img,this._level)}if(this._images!=null){if(typeof this._images=="function")this._images(this.facetItem,this.context,this._locations[0].x+4,this._locations[0].y+4,this.width-8,this.height-8);else if(this._images.length>0&&this._images[0]instanceof Image){var n=this._controller.GetHeight(this.facetItem.Img),r=this.height-8,i=Math.ceil(this._controller.GetWidthForImage(this.facetItem.Img,r));blankWidth=this.width-8-i;for(var s=0;s<this._images.length;s++){var o=this._images[s].src,u=this._controller._tileSize,a=o.match(/[0-9]+_[0-9]+/g),f=parseInt(a[a.length-1].substring(0,a[a.length-1].indexOf("_"))),c=parseInt(a[a.length-1].substring(a[a.length-1].indexOf("_")+1));a=o.match(/_files\/[0-9]+\//g);var h=parseInt(a[0].substring(7,a[0].length-1)),p=Math.ceil(n/Math.pow(2,this._controller.GetMaxLevel(this.facetItem.Img)-h)),d=r/p,v=Math.floor(blankWidth/2)+4+f*Math.floor(u*d),m=4+Math.floor(c*u*d),g=Math.ceil(this._images[s].height*d),y=Math.ceil(this._images[s].width*d);for(l=0;l<this._locations.length;l++)this.context.drawImage(this._images[s],v+this._locations[l].x,m+this._locations[l].y,y,g)}if(this._selected){this.context.beginPath();var v=Math.floor(blankWidth/2)+4,m=4;this.context.rect(v+this._locations[0].x,m+this._locations[0].y,i,r),this.context.lineWidth=4,this.context.strokeStyle="#92C4E1",this.context.stroke()}}}else this.DrawEmpty()},Contains:function(e,t){var n=!1;for(i=0;i<this._locations.length;i++)n=this._locations[0].x<=e&&this._locations[0].x+this.width>=e&&this._locations[0].y<=t&&this._locations[0].y+this.height>=t;return n},DrawEmpty:function(){this._controller.DrawLevel==undefined?(this.context.beginPath(),this.context.fillStyle="#D7DDDD",this.context.fillRect(this._locations[0].x+4,this._locations[0].y+4,this.width-8,this.height-8),this.context.rect(this._locations[0].x+4,this._locations[0].y+4,this.width-8,this.height-8),this.context.lineWidth=1,this.context.strokeStyle="white",this.context.stroke()):this._controller.DrawLevel(this.facetItem,this.context,this._locations[0].x+4,this._locations[0].y+4,this.width-8,this.height-8)},CollectionRoot:"",now:null,end:null,width:0,height:0,origwidth:0,origheight:0,ratio:1,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,facetItem:null,firstFilterItemDone:!1,Selected:function(e){this._selected=e}}),PivotViewer.Views.TileLocation=Object.subClass({init:function(){},x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0}),function(e){var t=[],n=[],r=[],i=[],s=0,o,u,a=[],f=[],l="",c,h=null,p=null,d={View:null,Facet:null,Filters:[]},v=null,m=0,g=new PivotViewer.Models.Collection,y={init:function(e){v=this,v.addClass("pv-wrapper"),InitPreloader();if(e.Loader==undefined)throw"Collection loader is undefined.";if(!(e.Loader instanceof PivotViewer.Models.Loaders.ICollectionLoader))throw"Collection loader does not inherit from PivotViewer.Models.Loaders.ICollectionLoader.";e.Loader.LoadCollection(g);if(e.ImageController==undefined)c=new PivotViewer.Views.DeepZoomImageController;else{if(!e.ImageController instanceof PivotViewer.Views.IImageController)throw"Image Controller does not inherit from PivotViewer.Views.IImageController.";c=e.ImageController}if(e.ViewerState!=undefined){var t=e.ViewerState.split("&");for(var n=0,r=t.length;n<r;n++){var i=t[n].split("=");if(i.length==2)if(i[0]=="$view$")d.View=parseInt(i[1])-1;else if(i[0]=="$facet0$")d.Facet=PivotViewer.Utils.EscapeItemId(i[1]);else{var s={Facet:i[0],Predicates:[]},o=i[1].split("_");for(var u=0,a=o.length;u<a;u++){var f=o[u].split(".");f.length==2&&s.Predicates.push({Operator:f[0],Value:f[1]})}d.Filters.push(s)}}}},show:function(){Debug.Log("Show")},hide:function(){Debug.Log("Hide")}};InitPreloader=function(){v.append("<div class='pv-loading'><img src='Content/images/loading.gif' alt='Loading' /><span>Loading...</span></div>"),e(".pv-loading").css("top",e(".pv-wrapper").height()/2-33+"px"),e(".pv-loading").css("left",e(".pv-wrapper").width()/2-43+"px")},InitTileCollection=function(){InitUI();var t=g.ImageBase;t.indexOf("http",0)>=0||t.indexOf("www.",0)>=0||(t=g.CXMLBase.substring(0,g.CXMLBase.lastIndexOf("/")+1)+t);var n=e(".pv-viewarea-canvas")[0].getContext("2d");u=new PivotViewer.Views.TileController(c),a=u.initTiles(g.Items,t,n),c.Setup(t.replace("\\","/"))},InitPivotViewer=function(){CreateFacetList(),CreateViews(),AttachEventHandlers(),e(".pv-loading").remove(),ApplyViewerState(),d.View!=null?SelectView(d.View,!0):SelectView(0,!0),u.BeginAnimation()},InitUI=function(){var t="<div class='pv-toolbarpanel'>",n=g.BrandImage;n.length>0&&(t+="<img class='pv-toolbarpanel-brandimage' src='"+n+"'></img>"),t+="<span class='pv-toolbarpanel-name'>"+g.CollectionName+"</span>",t+="<div class='pv-toolbarpanel-facetbreadcrumb'></div>",t+="<div class='pv-toolbarpanel-zoomcontrols'><div class='pv-toolbarpanel-zoomslider'></div></div>",t+="<div class='pv-toolbarpanel-viewcontrols'></div>",t+="<div class='pv-toolbarpanel-sortcontrols'></div>",t+="</div>",v.append(t);var r=m;e(".pv-toolbarpanel-zoomslider").slider({max:100,change:function(t,n){var i=n.value-r;centreX=e(".pv-viewarea-canvas").width()/2,centreY=e(".pv-viewarea-canvas").height()/2,e.publish("/PivotViewer/Views/Canvas/Zoom",[{x:centreX,y:centreY,delta:.5*i}]),r=n.value}}),v.append("<div class='pv-mainpanel'></div>");var i=e(".pv-wrapper").height()-e(".pv-toolbarpanel").height()-6;e(".pv-mainpanel").css("height",i+"px"),e(".pv-mainpanel").append("<div class='pv-filterpanel'></div>"),e(".pv-mainpanel").append("<div class='pv-viewpanel'><canvas class='pv-viewarea-canvas' width='"+v.width()+"' height='"+i+"px'></canvas></div>"),e(".pv-mainpanel").append("<div class='pv-infopanel'></div>");var s=e(".pv-filterpanel");s.append("<div class='pv-filterpanel-clearall'>Clear All</div>").append("<input class='pv-filterpanel-search' type='text' placeholder='Search...' /><div class='pv-filterpanel-search-autocomplete'></div>").css("height",i-13+"px"),e(".pv-filterpanel-search").css("width",s.width()-2+"px"),e(".pv-filterpanel-search-autocomplete").css("width",s.width()-8+"px").hide();var o=e(".pv-infopanel");o.css("left",e(".pv-mainpanel").offset().left+e(".pv-mainpanel").width()-205+"px").css("height",i-28+"px"),o.append("<div class='pv-infopanel-controls'></div>"),e(".pv-infopanel-controls").append("<div><div class='pv-infopanel-controls-navleft'></div><div class='pv-infopanel-controls-navleftdisabled'></div><div class='pv-infopanel-controls-navbar'></div><div class='pv-infopanel-controls-navright'></div><div class='pv-infopanel-controls-navrightdisabled'></div></div>"),e(".pv-infopanel-controls-navleftdisabled").hide(),e(".pv-infopanel-controls-navrightdisabled").hide(),o.append("<div class='pv-infopanel-heading'></div>"),o.append("<div class='pv-infopanel-details'></div>"),o.hide()},CreateFacetList=function(){for(var t=0;t<g.Items.length;t++){var s=g.Items[t];for(var o=0;o<g.FacetCategories.length;o++){var u=g.FacetCategories[o];if(u.IsFilterVisible){var a=!1;for(var f=0,l=s.Facets.length;f<l;f++){var c=s.Facets[f];if(c.Name==u.Name){for(var h=0;h<c.FacetValues.length;h++)if(u.Type==PivotViewer.Models.FacetType.String){var p=!1,d=PivotViewer.Utils.EscapeItemId("pv-facet-item-"+c.Name+"__"+c.FacetValues[h].Value);for(var v=n.length-1;v>-1;v-=1)if(n[v].itemId==d){n[v].count+=1,p=!0;break}p||n.push({itemId:d,itemValue:c.FacetValues[h].Value,facet:c.Name,count:1})}else if(u.Type==PivotViewer.Models.FacetType.Number){var m=!1;for(var v=0;v<r.length;v++)if(r[v].Facet==s.Facets[f].Name){r[v].Values.push(c.FacetValues[h].Value),m=!0;break}m||r.push({Facet:c.Name,Values:[c.FacetValues[h].Value]})}a=!0}}if(!a){var p=!1,d=PivotViewer.Utils.EscapeItemId("pv-facet-item-"+u.Name+"__(no info)");for(var v=n.length-1;v>-1;v-=1)if(n[v].itemId==d){n[v].count+=1,p=!0;break}p||n.push({itemId:d,itemValue:"(no info)",facet:u.Name,count:1})}}if(u.IsWordWheelVisible)for(var f=0,l=s.Facets.length;f<l;f++){var c=s.Facets[f];if(c.Name==u.Name)for(var h=0;h<c.FacetValues.length;h++)u.Type==PivotViewer.Models.FacetType.String&&i.push({Facet:c.Name,Value:c.FacetValues[h].Value})}}}var y=["<div class='pv-filterpanel-accordion'>"],b=[];for(var t=0;t<g.FacetCategories.length;t++)g.FacetCategories[t].IsFilterVisible&&(y[t+1]="<h3><a href='#'>",y[t+1]+=g.FacetCategories[t].Name,y[t+1]+="</a><div class='pv-filterpanel-accordion-heading-clear' facetType='"+g.FacetCategories[t].Type+"'>&nbsp;</div></h3>",y[t+1]+="<div style='height:30%' id='pv-cat-"+PivotViewer.Utils.EscapeItemId(g.FacetCategories[t].Name)+"'>",g.FacetCategories[t].Type==PivotViewer.Models.FacetType.String?(g.FacetCategories[t].CustomSort!=undefined||g.FacetCategories[t].CustomSort!=null?y[t+1]+="<span class='pv-filterpanel-accordion-facet-sort' customSort='"+g.FacetCategories[t].CustomSort.Name+"'>Sort: "+g.FacetCategories[t].CustomSort.Name+"</span>":y[t+1]+="<span class='pv-filterpanel-accordion-facet-sort'>Sort: A-Z</span>",y[t+1]+=CreateStringFacet(g.FacetCategories[t].Name)):g.FacetCategories[t].Type==PivotViewer.Models.FacetType.Number&&(y[t+1]+="<div id='pv-filterpanel-category-numberitem-"+g.FacetCategories[t].Name.replace(/\s+/gi,"|")+"'></div>"),y[t+1]+="</div>",b[t]="<option value='"+PivotViewer.Utils.EscapeItemId(g.FacetCategories[t].Name)+"' label='"+g.FacetCategories[t].Name+"'>"+g.FacetCategories[t].Name+"</option>");y[y.length]="</div>",e(".pv-filterpanel").append(y.join(""));for(var t=0;t<g.FacetCategories.length;t++)g.FacetCategories[t].IsFilterVisible&&SortFacetItems(g.FacetCategories[t].Name);e(".pv-filterpanel-accordion").css("height",e(".pv-filterpanel").height()-e(".pv-filterpanel-search").height()-50+"px"),e(".pv-filterpanel-accordion").accordion({}),e(".pv-toolbarpanel-sortcontrols").append('<select class="pv-toolbarpanel-sort">'+b.join("")+"</select>");for(var t=0;t<r.length;t++)CreateNumberFacet(PivotViewer.Utils.EscapeItemId(r[t].Facet),r[t].Values)},CreateStringFacet=function(e){var t=["<ul class='pv-filterpanel-accordion-facet-list'>"];for(var r=0;r<n.length;r++)n[r].facet==e&&(t[r+1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+n[r].itemId+"'>",t[r+1]+="<input itemvalue='"+n[r].itemValue.replace(/\s+/gi,"|")+"' itemfacet='"+e.replace(/\s+/gi,"|")+"' class='pv-facet-facetitem' type='checkbox' />",t[r+1]+="<span class='pv-facet-facetitem-label' title='"+n[r].itemValue+"'>"+n[r].itemValue+"</span>",t[r+1]+="<span class='pv-facet-facetitem-count'>0</span>",t[r+1]+="</li>");return t[t.length]="</ul>",t.join("")},CreateNumberFacet=function(t,n){var r=165,i=80,s=e("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(t));s.empty(),s.append("<span class='pv-filterpanel-numericslider-range-val'>&nbsp;</span>");var o="<svg class='pv-filterpanel-accordion-facet-chart' width='"+r+"' height='"+i+"'>",u=PivotViewer.Utils.Histogram(n),a=.5+r/u.BinCount|0,f=0;for(var l=0,c=u.Histogram.length;l<c;l++)f=f<u.Histogram[l].length?u.Histogram[l].length:f;for(var l=0,c=u.Histogram.length;l<c;l++){var h=.5+i/(f/u.Histogram[l].length)|0,p=.5+a*l|0;o+="<rect x='"+p+"' y='"+(i-h)+"' width='"+a+"' height='"+h+"'></rect>"}s.append(o+"</svg>");var d=e("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(t));d.append('</span><div id="pv-filterpanel-numericslider-'+t+'" class="pv-filterpanel-numericslider"></div><span class="pv-filterpanel-numericslider-range-min">'+u.Min+'</span><span class="pv-filterpanel-numericslider-range-max">'+u.Max+"</span>");var v=e("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeMetaChars(t));v.slider({range:!0,min:u.Min,max:u.Max,values:[u.Min,u.Max],slide:function(t,n){e(this).parent().find(".pv-filterpanel-numericslider-range-val").text(n.values[0]+" - "+n.values[1])},stop:function(t,n){var r=e(this),i=r.slider("option","min"),s=r.slider("option","max");n.values[0]>i||n.values[1]<s?r.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"):n.values[0]==i&&n.values[1]==s&&r.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection()}})},CreateViews=function(){var n=e(".pv-viewpanel"),r=v.width(),i=e(".pv-mainpanel").height(),s=e(".pv-filterpanel").width()+18,o=4;t.push(new PivotViewer.Views.GridView),t.push(new PivotViewer.Views.GraphView);for(var a=0;a<t.length;a++)try{t[a]instanceof PivotViewer.Views.IPivotViewerView?(t[a].Setup(r,i,s,o,u.GetMaxTileRatio()),n.append("<div class='pv-viewpanel-view' id='pv-viewpanel-view-"+a+"'>"+t[a].GetUI()+"</div>"),e(".pv-toolbarpanel-viewcontrols").append("<div class='pv-toolbarpanel-view' id='pv-toolbarpanel-view-"+a+"' title='"+t[a].GetViewName()+"'><img id='pv-viewpanel-view-"+a+"-image' src='"+t[a].GetButtonImage()+"' alt='"+t[a].GetViewName()+"' /></div>")):alert("View does not inherit from PivotViewer.Views.IPivotViewerView")}catch(f){alert(f.Message)}},SelectView=function(n,r){for(var i=0;i<t.length;i++)n!=i&&(e("#pv-viewpanel-view-"+i+"-image").attr("src",t[i].GetButtonImage()),t[i].Deactivate(),t[i].init=!1);e("#pv-viewpanel-view-"+n+"-image").attr("src",t[n].GetButtonImageSelected()),t[n].Activate(),t[n].init=r,s=n,FilterCollection()},SortFacetItems=function(t){var n=e("#pv-cat-"+PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId(t))+" ul"),r=n.prev().text().replace("Sort: ",""),i=n.children("li").get();if(r=="A-Z")i.sort(function(t,n){var r=e(t).children().first().attr("itemvalue"),i=e(n).children().first().attr("itemvalue");return r<i?1:r>i?-1:0});else if(r=="Quantity")i.sort(function(t,n){var r=parseInt(e(t).children(".pv-facet-facetitem-count").text()),i=parseInt(e(n).children(".pv-facet-facetitem-count").text());return r<i?-1:r>i?1:0});else{var s=g.GetFacetCategoryByName(t);if(s.CustomSort!=undefined){var o=[];for(var u=s.CustomSort.SortValues.length-1;u>-1;u-=1)for(var a=0;a<i.length;a++)s.CustomSort.SortValues[u]==e(i[a]).children(".pv-facet-facetitem-label").text()&&(o.push(i[a]),found=!0);i=o}}for(var u=0;u<i.length;u++)n.prepend(i[u])},ApplyViewerState=function(){d.Facet!=null&&e(".pv-toolbarpanel-sort").val(d.Facet).attr("selected","selected");for(var t=0,n=d.Filters.length;t<n;t++)for(var r=0,i=d.Filters[t].Predicates.length;r<i;r++){var s=d.Filters[t].Predicates[r].Operator;if(s=="GT"||s=="GE"||s=="LT"||s=="LE"){var o=e("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeItemId(d.Filters[t].Facet)),u=parseFloat(d.Filters[t].Predicates[r].Value);switch(s){case"GT":o.slider("values",0,u+1);break;case"GE":o.slider("values",0,u);break;case"LT":o.slider("values",1,u-1);break;case"LE":o.slider("values",1,u)}o.parent().find(".pv-filterpanel-numericslider-range-val").text(o.slider("values",0)+" - "+o.slider("values",1)),o.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")}else s=="EQ"?SelectStringFacetItem(PivotViewer.Utils.EscapeItemId(d.Filters[t].Facet),PivotViewer.Utils.EscapeItemId(d.Filters[t].Predicates[r].Value)):s=="NT"&&SelectStringFacetItem(PivotViewer.Utils.EscapeItemId(d.Filters[t].Facet),"(no|info)")}},SelectStringFacetItem=function(t,n){var r=e('.pv-facet-facetitem[itemfacet="'+t+'"][itemvalue="'+n+'"]');r.attr("checked","checked"),r.parent().parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")},FilterCollection=function(){var n=[],r=[],i=[],o=e(".pv-toolbarpanel-sort option:selected").text(),l=e(".pv-facet-facetitem:checked");e(".pv-filterpanel-clearall").css("visibility","hidden");var c=[];for(var h=0;h<l.length;h++){var p=e(l[h]).attr("itemfacet").replace(/\|/gi," "),d=e(l[h]).attr("itemvalue").replace(/\|/gi," "),v=!1;for(var m=0;m<c.length;m++)c[m].facet==p&&(c[m].facetValue.push(d),v=!0);v||c.push({facet:p,facetValue:[d]}),e.inArray(p,i)<0&&i.push(p)}var y=[];for(var h=0,b=g.FacetCategories.length;h<b;h++)if(g.FacetCategories[h].Type==PivotViewer.Models.FacetType.Number){var w=e("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(g.FacetCategories[h].Name.replace(/\s+/gi,"|"))),E=e(w).find(".pv-filterpanel-numericslider");if(E.length>0){var S=E.slider("values"),x=E.slider("option","max"),T=E.slider("option","min");if(S[0]!=T||S[1]!=x){var p=g.FacetCategories[h].Name;y.push({facet:p,selectedMin:S[0],selectedMax:S[1],rangeMin:T,rangeMax:x}),e.inArray(p,i)<0&&i.push(p)}}}for(var h=0,b=g.Items.length;h<b;h++){var N=0;for(var C=0,k=c.length;C<k;C++)for(var L=0,A=c[C].facetValue.length;L<A;L++)if(c[C].facetValue[L]=="(no info)"){var O=!1;for(var m=0,M=g.Items[h].Facets.length;m<M;m++)g.Items[h].Facets[m].Name==c[C].facet&&(O=!0);O==0&&N++}for(var m=0,M=g.Items[h].Facets.length;m<M;m++)for(var C=0,k=c.length;C<k;C++){var _=0;if(g.Items[h].Facets[m].Name==c[C].facet)for(var D=0,P=g.Items[h].Facets[m].FacetValues.length;D<P;D++)for(var L=0,A=c[C].facetValue.length;L<A;L++)g.Items[h].Facets[m].FacetValues[D].Value==c[C].facetValue[L]&&_++;_>0&&N++}if(N!=c.length)continue;for(var C=0,k=y.length;C<k;C++)if(y[C].selectedMin=="(no info)"){var O=!1;for(var m=0,M=g.Items[h].Facets.length;m<M;m++)g.Items[h].Facets[m].Name==y[C].facet&&(O=!0);O==0&&N++}for(var m=0,M=g.Items[h].Facets.length;m<M;m++)for(var C=0,k=y.length;C<k;C++)if(g.Items[h].Facets[m].Name==y[C].facet)for(var D=0,P=g.Items[h].Facets[m].FacetValues.length;D<P;D++){var H=parseFloat(g.Items[h].Facets[m].FacetValues[D].Value);!isNaN(H)&&H>=y[C].selectedMin&&H<=y[C].selectedMax&&N++}if(N!=c.length+y.length)continue;n.push(g.Items[h].Id),c.length+y.length>0&&e(".pv-filterpanel-clearall").css("visibility","visible")}e(".pv-viewpanel-view").hide(),e("#pv-viewpanel-view-"+s).show(),FilterFacets(n,i),UpdateBreadcrumbNavigation(c,y),u.SetCircularEasingBoth(),t[s].Filter(a,n,o);var B=[];for(var h=0;h<t[s].tiles.length;h++){var j=e.inArray(t[s].tiles[h].facetItem.Id,n);j>=0&&B.push(t[s].tiles[h].facetItem.Id)}f=B,DeselectInfoPanel()},FilterFacets=function(t,i){if(t.length==g.Items.length){for(var s=n.length-1;s>-1;s-=1){var o=e("#"+PivotViewer.Utils.EscapeMetaChars(n[s].itemId));o.show(),o.find("span").last().text(n[s].count)}for(var s=0;s<r.length;s++)CreateNumberFacet(PivotViewer.Utils.EscapeItemId(r[s].Facet),r[s].Values);return}var u=[],a=[];for(var s=t.length-1;s>-1;s-=1){var o=g.GetItemById(t[s]);for(var f=0;f<g.FacetCategories.length;f++)if(g.FacetCategories[f].IsFilterVisible){var l=!1;for(var c=o.Facets.length-1;c>-1;c-=1)if(o.Facets[c].Name==g.FacetCategories[f].Name){if(e.inArray(o.Facets[c].Name,i)<0){var h=g.GetFacetCategoryByName(o.Facets[c].Name);if(h.IsFilterVisible)for(var p=o.Facets[c].FacetValues.length-1;p>-1;p-=1)if(h.Type==PivotViewer.Models.FacetType.String){var d={item:"#"+PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId("pv-facet-item-"+o.Facets[c].Name+"__"+o.Facets[c].FacetValues[p].Value)),count:1},v=!1;for(var m=u.length-1;m>-1;m-=1)if(u[m].item==d.item){u[m].count+=1,v=!0;break}v||u.push(d)}else if(h.Type==PivotViewer.Models.FacetType.Number){var y=!1;for(var m=0;m<a.length;m++)if(a[m].Facet==o.Facets[c].Name){a[m].Values.push(o.Facets[c].FacetValues[p].Value),y=!0;break}y||a.push({Facet:o.Facets[c].Name,Values:[o.Facets[c].FacetValues[p].Value]})}}l=!0}if(!l){var d={item:"#"+PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId("pv-facet-item-"+g.FacetCategories[f].Name+"__(no info)")),count:1},v=!1;for(var m=u.length-1;m>-1;m-=1)if(u[m].item==d.item){u[m].count+=1,v=!0;break}v||u.push(d)}}}for(var s=n.length-1;s>-1;s-=1)if(e.inArray(n[s].facet,i)<0){var v=!1;for(var c=u.length-1;c>-1;c-=1)if(u[c].item==n[s].itemId){v=!0;break}v||e("#"+PivotViewer.Utils.EscapeMetaChars(n[s].itemId)).hide()}else e("#"+PivotViewer.Utils.EscapeMetaChars(n[s].itemId)).find("span").last().text(n[s].count);for(var s=u.length-1;s>-1;s-=1){var b=e(u[s].item);if(b.length>0){b.show();var w=b.find("span").last();w.text(u[s].count)}}for(var s=0;s<a.length;s++)CreateNumberFacet(PivotViewer.Utils.EscapeItemId(a[s].Facet),a[s].Values)},UpdateBreadcrumbNavigation=function(t,n){var r=e(".pv-toolbarpanel-facetbreadcrumb");r.empty();if(t.length==0)return;var i="|";for(var s=0,o=t.length;s<o;s++)i+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+t[s].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",i+=t[s].facetValue.join(", "),i+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>";for(var s=0,o=n.length;s<o;s++)i+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+n[s].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",n[s].selectedMin==n[s].rangeMin?i+="Under "+n[s].selectedMax:n[s].selectedMax==n[s].rangeMax?i+="Over "+n[s].selectedMin:i+=n[s].selectedMin+" - "+n[s].selectedMax,i+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>";r.append(i)},DeselectInfoPanel=function(){e(".pv-infopanel").fadeOut(),e(".pv-infopanel-heading").text(""),e(".pv-infopanel-details").empty()},GetItemIds=function(e,t){var n=[];for(var r=0;r<g.Items.length;r++){var i=!1;for(var s=0;s<g.Items[r].Facets.length;s++)if(g.Items[r].Facets[s].Name==e){for(var o=0;o<g.Items[r].Facets[s].FacetValues.length;o++)t==g.Items[r].Facets[s].FacetValues[o].Value&&n.push(g.Items[r].Id);i=!0}!i&&t=="(no info)"&&n.push(g.Items[r].Id)}return n},GetItem=function(e){for(var t=0;t<g.Items.length;t++)if(g.Items[t].Id==e)return g.Items[t];return null},e.subscribe("/PivotViewer/Models/Collection/Loaded",function(e){InitTileCollection()}),e.subscribe("/PivotViewer/ImageController/Collection/Loaded",function(e){InitPivotViewer()}),e.subscribe("/PivotViewer/Views/Item/Selected",function(t){if(t===undefined||t===null||t===""){DeselectInfoPanel();return}var n=GetItem(t);if(n!=null){var r=!0;e(".pv-infopanel-heading").text(n.Name);var i=e(".pv-infopanel-details");i.empty(),n.Description!=undefined&&n.Description.length>0&&i.append("<div class='pv-infopanel-detail-description' style='height:100px;'>"+n.Description+"</div><div class='pv-infopanel-detail-description-more'>More</div>"),n.Id==f[0]&&n==f[f.length-1]?(e(".pv-infopanel-controls-navright").hide(),e(".pv-infopanel-controls-navrightdisabled").show(),e(".pv-infopanel-controls-navleft").hide(),e(".pv-infopanel-controls-navleftdisabled").show()):n.Id==f[0]?(e(".pv-infopanel-controls-navleft").hide(),e(".pv-infopanel-controls-navleftdisabled").show(),e(".pv-infopanel-controls-navright").show(),e(".pv-infopanel-controls-navrightdisabled").hide()):n.Id==f[f.length-1]?(e(".pv-infopanel-controls-navright").hide(),e(".pv-infopanel-controls-navrightdisabled").show(),e(".pv-infopanel-controls-navleft").show(),e(".pv-infopanel-controls-navleftdisabled").hide()):(e(".pv-infopanel-controls-navright").show(),e(".pv-infopanel-controls-navrightdisabled").hide(),e(".pv-infopanel-controls-navleft").show(),e(".pv-infopanel-controls-navleftdisabled").hide());var s=[],o=0;for(var u=0;u<n.Facets.length;u++){var a=!1,c=!1;for(var h=0;h<g.FacetCategories.length;h++)if(g.FacetCategories[h].Name==n.Facets[u].Name&&g.FacetCategories[h].IsMetaDataVisible){a=!0,c=g.FacetCategories[h].IsFilterVisible;break}if(a){s[o]="<div class='pv-infopanel-detail "+(r?"detail-dark":"detail-light")+"'><div class='pv-infopanel-detail-item detail-item-title'>"+n.Facets[u].Name+"</div>";for(var h=0;h<n.Facets[u].FacetValues.length;h++)s[o]+="<div class='pv-infopanel-detail-item detail-item-value"+(c?" detail-item-value-filter":"")+"'>",n.Facets[u].FacetValues[h].Href!=null?s[o]+="<a class='detail-item-link' href='"+n.Facets[u].FacetValues[h].Href+"'>"+n.Facets[u].FacetValues[h].Value+"</a>":s[o]+=n.Facets[u].FacetValues[h].Value,s[o]+="</div>";s[o]+="</div>",o++,r=!r}}i.append(s.join("")),e(".pv-infopanel").fadeIn(),i.css("height",e(".pv-infopanel").height()-(e(".pv-infopanel-controls").height()+e(".pv-infopanel-heading").height())-20+"px"),l=n;return}}),e.subscribe("/PivotViewer/Views/Item/Filtered",function(t){if(t==undefined||t==null)return;for(var n=0,r=g.FacetCategories.length;n<r;n++){if(g.FacetCategories[n].Name==t.Facet&&g.FacetCategories[n].Type==PivotViewer.Models.FacetType.String){var i=e(PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId("#pv-facet-item-"+t.Facet+"__"+t.Item))+" input");i.attr("checked","checked"),FacetItemClick(i[0])}if(g.FacetCategories[n].Name==t.Facet&&g.FacetCategories[n].Type==PivotViewer.Models.FacetType.Number){var s=e("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeMetaChars(t.Facet));FacetSliderDrag(s,t.Item,t.MaxRange)}}}),AttachEventHandlers=function(){e(".pv-toolbarpanel-view").on("click",function(e){var t=this.id.substring(this.id.lastIndexOf("-")+1,this.id.length);t!=null&&SelectView(parseInt(t),!1)}),e(".pv-toolbarpanel-sort").on("change",function(e){FilterCollection()}),e(".pv-filterpanel-accordion-facet-sort").on("click",function(t){var n=e(this),r=n.text(),i=n.parent().prev().children("a").text(),s=n.attr("customSort");r=="Sort: A-Z"?e(this).text("Sort: Quantity"):r=="Sort: Quantity"&&s==undefined?e(this).text("Sort: A-Z"):r=="Sort: Quantity"?e(this).text("Sort: "+s):e(this).text("Sort: A-Z"),SortFacetItems(i)}),e(".pv-facet-facetitem").on("click",function(e){FacetItemClick(this)}),e(".pv-facet-facetitem-label").on("click",function(t){var n=e(this).prev(),r=e(this.parentElement.parentElement).find(":checked");n.attr("checked")=="checked"&&r.length<=1?n.removeAttr("checked"):n.attr("checked","checked");for(var i=r.length-1;i>-1;i-=1)r[i].getAttribute("itemvalue")!=n[0].getAttribute("itemvalue")&&(r[i].checked=!1);FacetItemClick(n[0])}),e(".pv-filterpanel-clearall").on("click",function(t){var n=e(".pv-facet-facetitem:checked");for(var r=0;r<n.length;r++)e(n[r]).removeAttr("checked");var i=e(".pv-filterpanel-numericslider");for(var r=0;r<i.length;r++){var s=e(i[r]),o=s.slider("option","min"),u=s.slider("option","max");s.slider("values",0,o),s.slider("values",1,u),s.prev().prev().html("&nbsp;")}e(".pv-filterpanel-search").val(""),e(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection()}),e(".pv-filterpanel-accordion-heading-clear").on("click",function(t){var n=this.attributes.facetType.value;if(n=="String"){var r=e(this.parentElement).next().find(".pv-facet-facetitem:checked");for(var i=0;i<r.length;i++)e(r[i]).removeAttr("checked")}else if(n=="Number"){var s=e(this.parentElement).next().find(".pv-filterpanel-numericslider"),o=s.slider("option","min"),u=s.slider("option","max");s.slider("values",0,o),s.slider("values",1,u),s.prev().prev().html("&nbsp;")}FilterCollection(),e(this).css("visibility","hidden")}),e(".ui-slider-range").on("mousedown",function(e){}),e(".pv-infopanel-details").on("click",".detail-item-value-filter",function(t){return e.publish("/PivotViewer/Views/Item/Filtered",[{Facet:e(this).parent().children().first().text(),Item:e(this).text()}]),!1}),e(".pv-infopanel-details").on("click",".pv-infopanel-detail-description-more",function(t){var n=e(this),r=e(this).prev();n.text()=="More"?(r.css("height",""),e(this).text("Less")):(r.css("height","100px"),e(this).text("More"))}),e(".pv-infopanel-controls-navleft").on("click",function(n){for(var r=0;r<f.length;r++)if(f[r]==l.Id){r>=0&&e.publish("/PivotViewer/Views/Item/Selected",[f[r-1]]);for(var i=0;i<a.length;i++)a[i].facetItem.Id==f[r-1]?(a[i].Selected(!0),selectedCol=t[s].GetSelectedCol(a[i]),selectedRow=t[s].GetSelectedRow(a[i]),t[s].CentreOnSelectedTile(selectedCol,selectedRow)):a[i].Selected(!1);break}}),e(".pv-infopanel-controls-navright").on("click",function(n){for(var r=0;r<f.length;r++)if(f[r]==l.Id){if(r<f.length){e.publish("/PivotViewer/Views/Item/Selected",[f[r+1]]);for(var i=0;i<a.length;i++)a[i].facetItem.Id==f[r+1]?(a[i].Selected(!0),selectedCol=t[s].GetSelectedCol(a[i]),selectedRow=t[s].GetSelectedRow(a[i]),t[s].CentreOnSelectedTile
(selectedCol,selectedRow)):a[i].Selected(!1)}break}}),e(".pv-filterpanel-search").on("keyup",function(t){var n=!1,r=[],s=e(".pv-filterpanel-search-autocomplete"),o=FilterCollection,u=SelectStringFacetItem;s.empty();if(t.keyCode==27){e(t.target).blur();return}for(var a=0,f=i.length;a<f;a++){var l=i[a].Value.toLowerCase();l.indexOf(t.target.value.toLowerCase())>=0&&e.inArray(l,r)==-1&&(r.push(l),s.append('<span facet="'+i[a].Facet+'">'+i[a].Value+"</span>"),t.keyCode==13&&(SelectStringFacetItem(PivotViewer.Utils.EscapeItemId(i[a].Facet),PivotViewer.Utils.EscapeItemId(i[a].Value)),n=!0))}e(".pv-filterpanel-search-autocomplete > span").on("mousedown",function(t){t.preventDefault(),e(".pv-filterpanel-search").val(t.target.textContent),e(".pv-filterpanel-search-autocomplete").hide(),u(PivotViewer.Utils.EscapeItemId(t.target.attributes[0].value),PivotViewer.Utils.EscapeItemId(t.target.textContent)),o()}),r.length>0&&s.show(),n&&FilterCollection()}),e(".pv-filterpanel-search").on("blur",function(t){t.target.value="",e(".pv-filterpanel-search-autocomplete").hide()});var n=e(".pv-viewarea-canvas");n.on("mouseup",function(t){var n=e(this).offset(),r=t.clientX-n.left,i=t.clientY-n.top;(!p||p.x==0&&p.y==0)&&e.publish("/PivotViewer/Views/Canvas/Click",[{x:r,y:i}]),h=null,p=!1}),n.on("mouseout",function(e){h=null,p=!1}),n.on("mousedown",function(t){var n=e(this).offset(),r=t.clientX-n.left,i=t.clientY-n.top;h={x:r,y:i}}),n.on("mousemove",function(t){var n=e(this).offset(),r=t.clientX-n.left,i=t.clientY-n.top;h==null?e.publish("/PivotViewer/Views/Canvas/Hover",[{x:r,y:i}]):(p={x:r-h.x,y:i-h.y},h={x:r,y:i},e.publish("/PivotViewer/Views/Canvas/Drag",[p]))}),n.on("mousewheel",function(t,n){var r=e(this).offset(),i=t.clientX-r.left,s=t.clientY-r.top;u.SetQuarticEasingOut(),u.DrawHelpers([{x:i,y:s}]);var o=e(".pv-toolbarpanel-zoomslider").slider("option","value");n>0?o=o<5?5:o+5:n<0&&(o-=5),o=Math.max(0,Math.min(100,o)),e(".pv-toolbarpanel-zoomslider").slider("option","value",o)}),n.on("touchstart",function(t){var n=t.originalEvent,r=e(this).offset(),i=n.touches[0].pageX-r.left,s=n.touches[0].pageY-r.top;h={x:i,y:s}}),n.on("touchmove",function(t){try{var n=t.originalEvent;t.preventDefault();if(n.touches.length>1){t.preventDefault();var r=1e7,i=1e7,s=0,o=0,a=[];for(var f=0;f<n.touches.length;f++)a.push({x:n.touches[f].pageX,y:n.touches[f].pageY}),n.touches[f].pageX<r&&(r=n.touches[f].pageX),n.touches[f].pageX>s&&(s=n.touches[f].pageX),n.touches[f].pageY<i&&(i=n.touches[f].pageY),n.touches[f].pageY>o&&(o=n.touches[f].pageY);var l=(r+s)/2,c=(i+o)/2;u.SetLinearEasingBoth(),a.push({x:l,y:c}),u.DrawHelpers(a),u.DrawHelperText("Scale: "+n.scale),e.publish("/PivotViewer/Views/Canvas/Zoom",[{x:l,y:c,scale:n.scale}]);return}var d=e(this).offset(),v=n.touches[0].pageX-d.left,m=n.touches[0].pageY-d.top;p={x:v-h.x,y:m-h.y},h={x:v,y:m},e.publish("/PivotViewer/Views/Canvas/Drag",[p])}catch(g){Debug.Log(g.message)}}),n.on("touchend",function(t){var n=t.originalEvent;if(n.touches.length==1&&h==null){var r=e(this).offset(),i=n.touches[0].pageX-r.left,s=n.touches[0].pageY-r.top;(!p||p.x==0&&p.y==0)&&e.publish("/PivotViewer/Views/Canvas/Click",[{x:i,y:s}])}h=null,p=!1;return})},FacetItemClick=function(t){e(t).attr("checked")=="checked"&&e(t.parentElement.parentElement.parentElement).prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"),FilterCollection()},FacetSliderDrag=function(t,n,r){var i=e(t),s=i.slider("option","min"),o=i.slider("option","max");n=="(no info)"&&(n=0),n>s||r<o?(i.parent().find(".pv-filterpanel-numericslider-range-val").text(n+" - "+r),i.slider("values",0,n),i.slider("values",1,r),i.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")):n==s&&r==o&&i.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection()},e.fn.PivotViewer=function(t){if(y[t])return y[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return y.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.PivotViewer")}}(jQuery);